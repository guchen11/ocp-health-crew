{% extends "base.html" %}

{% block title %}CNV HealthCrew AI{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Quick Actions
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">â–¼</span>
            </div>
            <div class="sidebar-content">
                <a href="/job/configure" class="sidebar-item">
                    <span class="sidebar-icon">â–¶ï¸</span>
                    Run with Parameters
                </a>
                <a href="/job/quick-run" class="sidebar-item">
                    <span class="sidebar-icon">âš¡</span>
                    Quick Health Check
                </a>
                <a href="/job/quick-sanity" class="sidebar-item">
                    <span class="sidebar-icon">ğŸ”¥</span>
                    Quick Sanity Check
                </a>
                <a href="/job/history" class="sidebar-item">
                    <span class="sidebar-icon">ğŸ“‹</span>
                    Run History
                </a>
            </div>
        </div>
        {% if current_user.is_admin %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Cleanup
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">â–¼</span>
            </div>
            <div class="sidebar-content">
                <a href="#" onclick="deleteBulk('stopped'); return false;" class="sidebar-item" style="color:var(--warning);">
                    <span class="sidebar-icon">â¹ï¸</span>
                    Delete All Stopped
                </a>
                <a href="#" onclick="deleteBulk('failed'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">âŒ</span>
                    Delete All Failed
                </a>
                <a href="#" onclick="deleteBulk('all'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">ğŸ—‘ï¸</span>
                    Delete All Runs
                </a>
            </div>
        </div>
        {% endif %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Recent Runs
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">â–¼</span>
            </div>
            <div class="sidebar-content">
                {% for build in recent_builds[:5] %}
                <a href="/job/{{ build.number }}" class="sidebar-item">
                    <span class="status-icon {{ build.status }}"></span>
                    #{{ build.number }}{% if build.name %} - {{ build.name[:20] }}{% else %} - {{ build.timestamp[:16] }}{% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </aside>
    
    <main class="main">
        <!-- Stats -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                ğŸ“Š Run Statistics
                <span class="collapse-icon" style="margin-left:auto;">â–¼</span>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box info">
                        <div class="stat-value">{{ stats.total }}</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                    {% if stats.running > 0 %}
                    <div class="stat-box" style="border-left:4px solid var(--accent);animation:pulse 1.5s infinite;">
                        <div class="stat-value" style="color:var(--accent);">{{ stats.running }}</div>
                        <div class="stat-label">Running</div>
                    </div>
                    {% endif %}
                    <div class="stat-box success">
                        <div class="stat-value">{{ stats.success }}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="stat-value">{{ stats.unstable }}</div>
                        <div class="stat-label">Issues Found</div>
                    </div>
                    <div class="stat-box danger">
                        <div class="stat-value">{{ stats.failed }}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Build History -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                ğŸ“‹ Recent Run History
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                    <a href="/?view=all" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view != 'mine' %}background:var(--accent);color:white;{% endif %}">All Runs</a>
                    <a href="/?view=mine" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view == 'mine' %}background:var(--accent);color:white;{% endif %}">My Runs</a>
                    <span class="collapse-icon" style="margin-left:8px;">â–¼</span>
                </div>
                <button id="deleteSelectedBtn" onclick="event.stopPropagation(); deleteSelected()" class="btn btn-danger" style="margin-left:16px;display:none;">
                    ğŸ—‘ï¸ Delete Selected (<span id="selectedCount">0</span>)
                </button>
            </div>
            <div class="card-body" style="padding:0;">
                {% if builds %}
                <table class="build-table">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th style="width:60px;">Run</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Lab</th>
                            <th>Jump Host</th>
                            <th>Triggered By</th>
                            <th>Checks Run</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if running_build %}
                        <tr style="background:rgba(59,130,246,0.08);">
                            <td></td>
                            <td>
                                <a href="/job/{{ running_build.number }}/console" class="build-link" style="color:var(--accent);" title="View live console">
                                    <span class="status-icon running"></span>
                                    #{{ running_build.number }}
                                </a>
                            </td>
                            <td>
                                {% if running_build.options and running_build.options.task_type == 'cnv_combined' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;">ğŸ§¬ Combined</span>
                                {% elif running_build.options and running_build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV</span>
                                {% else %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">ğŸ©º Health</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-running" style="animation:pulse 1.5s infinite;">
                                    ğŸ”„ Running
                                </span>
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;">
                                {{ running_build.name or 'â€”' }}
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                {{ running_build.options.server_host.split('.')[0] if running_build.options and running_build.options.server_host else 'â€”' }}
                            </td>
                            <td style="font-size:12px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;">
                                    <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;font-weight:700;">{{ (running_build.triggered_by or 'S')[0]|upper }}</span>
                                    {{ running_build.triggered_by or 'system' }}
                                </span>
                            </td>
                            <td>
                                <span style="font-size:11px;">{{ running_build.checks_count or 'â€”' }}</span>
                            </td>
                            <td>{{ running_build.timestamp or 'â€”' }}</td>
                            <td><span id="running-row-elapsed" style="color:var(--accent);font-weight:600;">â€”</span></td>
                            <td>
                                {% if current_user.is_admin or running_build.user_id == current_user.id %}
                                <button onclick="stopBuild()" class="btn" style="color:var(--error);" title="Stop">â¹ï¸</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% for build in builds %}
                        <tr>
                            <td>{% if current_user.is_admin or build.triggered_by == current_user.username %}<input type="checkbox" class="build-checkbox" value="{{ build.number }}" onchange="updateSelectedCount()">{% endif %}</td>
                            <td>
                                <a href="/job/{{ build.number }}" class="build-link">
                                    <span class="status-icon {{ build.status }}"></span>
                                    #{{ build.number }}
                                </a>
                            </td>
                            <td>
                                {% if build.options.task_type == 'cnv_combined' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;">ğŸ§¬ Combined</span>
                                {% elif build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV</span>
                                {% else %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">ğŸ©º Health</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ build.status }}">
                                    {{ build.status_text }}
                                </span>
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;">
                                {{ build.name or 'â€”' }}
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ build.options.server_host or '' }}">
                                {{ build.options.server_host.split('.')[0] if build.options.server_host else 'â€”' }}
                            </td>
                            <td style="font-size:12px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;">
                                    <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;font-weight:700;">{{ (build.triggered_by or 'S')[0]|upper }}</span>
                                    {{ build.triggered_by or 'system' }}
                                </span>
                            </td>
                            <td>
                                {% if build.options.task_type in ['cnv_scenarios', 'cnv_combined'] %}
                                <span style="font-size:11px;">{{ build.checks_count }} tests</span>
                                {% else %}
                                {{ build.checks_count }} checks
                                {% endif %}
                            </td>
                            <td>{{ build.timestamp }}</td>
                            <td>{{ build.duration }}</td>
                            <td>
                                {% if build.report_file %}
                                <a href="/report/{{ build.report_file }}" class="btn" target="_blank">ğŸ“„ Report</a>
                                {% endif %}
                                <a href="/job/{{ build.number }}/console" class="btn">ğŸ“ Console</a>
                                {% if current_user.is_admin or build.triggered_by == current_user.username %}
                                <button onclick="deleteBuild({{ build.number }})" class="btn" style="color:var(--error);" title="Delete">ğŸ—‘ï¸</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <h3>No builds yet</h3>
                    <p>Click "Run with Parameters" to run your first health check</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCard(header) {
        header.classList.toggle('collapsed');
        var body = header.nextElementSibling;
        if (body && body.classList.contains('card-body')) {
            body.classList.toggle('collapsed');
        }
    }
    
    function toggleSidebarSection(title) {
        title.classList.toggle('collapsed');
        var content = title.nextElementSibling;
        if (content && content.classList.contains('sidebar-content')) {
            content.classList.toggle('collapsed');
        }
    }
    
    function toggleSelectAll() {
        var selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.build-checkbox').forEach(function(cb) {
            cb.checked = selectAll;
        });
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        var count = document.querySelectorAll('.build-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('deleteSelectedBtn').style.display = count > 0 ? 'inline-flex' : 'none';
    }
    
    function deleteSelected() {
        var selected = [];
        document.querySelectorAll('.build-checkbox:checked').forEach(function(cb) {
            selected.push(cb.value);
        });
        
        if (selected.length === 0) return;
        
        if (confirm('Are you sure you want to delete ' + selected.length + ' build(s) and their reports?')) {
            Promise.all(selected.map(function(buildNum) {
                return fetch('/api/delete/' + buildNum, { method: 'POST' });
            })).then(function() {
                location.reload();
            });
        }
    }
    
    function deleteBuild(buildNum) {
        if (confirm('Are you sure you want to delete Run #' + buildNum + ' and its report?')) {
            fetch('/api/delete/' + buildNum, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete: ' + data.error);
                    }
                });
        }
    }
    
    function deleteBulk(filterType) {
        var messages = {
            'stopped': 'Are you sure you want to delete ALL STOPPED builds?',
            'failed': 'Are you sure you want to delete ALL FAILED builds?',
            'all': 'âš ï¸ WARNING: This will delete ALL builds and their reports!\n\nAre you absolutely sure?'
        };
        
        if (confirm(messages[filterType])) {
            fetch('/api/delete-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filter: filterType})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Deleted ' + data.deleted + ' build(s)');
                    location.reload();
                } else {
                    alert('Failed to delete: ' + data.error);
                }
            });
        }
    }
</script>

{% if running_build %}
<script>
    var buildStartTime = {{ running_build.start_time }};
    
    function formatDuration(seconds) {
        if (seconds < 60) return seconds.toFixed(1) + 's';
        var mins = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        return mins + 'm ' + secs + 's';
    }
    
    function stopBuild() {
        if (confirm('Are you sure you want to stop the running build?')) {
            fetch('/api/stop', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to stop build: ' + data.error);
                    }
                });
        }
    }
    
    setInterval(function() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                if (data.running) {
                    var runningRowEl = document.getElementById('running-row-elapsed');
                    if (runningRowEl) {
                        var elapsed = Date.now() / 1000 - (data.start_time || buildStartTime);
                        runningRowEl.textContent = formatDuration(elapsed);
                    }
                } else {
                    location.reload();
                }
            });
    }, 2000);
</script>
{% endif %}
{% endblock %}
