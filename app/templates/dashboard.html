{% extends "base.html" %}

{% block title %}CNV HealthCrew AI{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Quick Actions
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">‚ñº</span>
            </div>
            <div class="sidebar-content">
                <a href="/job/configure" class="sidebar-item">
                    <span class="sidebar-icon">‚ñ∂Ô∏è</span>
                    Run with Parameters
                </a>
                <a href="/job/quick-run" class="sidebar-item">
                    <span class="sidebar-icon">‚ö°</span>
                    Quick Health Check
                </a>
                <a href="/job/quick-sanity" class="sidebar-item">
                    <span class="sidebar-icon">üî•</span>
                    Quick Sanity Check
                </a>
                <a href="/job/quick-full" class="sidebar-item">
                    <span class="sidebar-icon">üèãÔ∏è</span>
                    Full CNV Regression
                </a>
                <a href="/job/history" class="sidebar-item">
                    <span class="sidebar-icon">üìã</span>
                    Run History
                </a>
            </div>
        </div>
        {% if user_templates %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                My Templates
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">‚ñº</span>
            </div>
            <div class="sidebar-content">
                {% for t in user_templates %}
                <div style="display:flex;align-items:center;position:relative;" class="tmpl-row">
                    <a href="/job/configure?template={{ t.id }}" class="sidebar-item" style="display:flex;align-items:center;gap:6px;flex:1;overflow:hidden;" title="{{ t.description }}">
                        <span class="sidebar-icon">{{ t.icon }}</span>
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ t.name }}</span>
                    </a>
                    {% if t.created_by_id == current_user.id %}
                    <span class="tmpl-menu-trigger" onclick="event.preventDefault();event.stopPropagation();toggleTmplMenu(this);" title="Actions" style="padding:2px 8px;cursor:pointer;opacity:0.7;font-size:15px;flex-shrink:0;">‚ãÆ</span>
                    <div class="tmpl-menu" style="display:none;position:absolute;right:0;top:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:100;min-width:140px;overflow:hidden;">
                        <div onclick="event.stopPropagation();openEditTemplateModal({{ t.id }});" style="padding:8px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--text);" onmouseenter="this.style.background='var(--bg-secondary)'" onmouseleave="this.style.background=''">‚úèÔ∏è Rename</div>
                        <div onclick="event.stopPropagation();deleteTemplate({{ t.id }}, '{{ t.name|e }}');" style="padding:8px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--danger);" onmouseenter="this.style.background='var(--bg-secondary)'" onmouseleave="this.style.background=''">üóëÔ∏è Delete</div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% if current_user.is_admin %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Cleanup
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">‚ñº</span>
            </div>
            <div class="sidebar-content">
                <a href="#" onclick="deleteBulk('stopped'); return false;" class="sidebar-item" style="color:var(--warning);">
                    <span class="sidebar-icon">‚èπÔ∏è</span>
                    Delete All Stopped
                </a>
                <a href="#" onclick="deleteBulk('failed'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">‚ùå</span>
                    Delete All Failed
                </a>
                <a href="#" onclick="deleteBulk('all'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">üóëÔ∏è</span>
                    Delete All Runs
                </a>
            </div>
        </div>
        {% endif %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Recent Runs
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">‚ñº</span>
            </div>
            <div class="sidebar-content">
                {% for build in recent_builds[:5] %}
                <a href="/job/{{ build.number }}" class="sidebar-item">
                    <span class="status-icon {{ build.status }}"></span>
                    #{{ build.number }}{% if build.name %} - {{ build.name[:20] }}{% else %} - {{ build.timestamp[:16] }}{% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </aside>
    
    <main class="main">
        <!-- Stats -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                üìä Run Statistics
                <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box info">
                        <div class="stat-value">{{ stats.total }}</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                    {% if stats.running > 0 %}
                    <div class="stat-box" style="border-left:4px solid var(--accent);animation:pulse 1.5s infinite;">
                        <div class="stat-value" style="color:var(--accent);">{{ stats.running }}</div>
                        <div class="stat-label">Running</div>
                    </div>
                    {% endif %}
                    <div class="stat-box success">
                        <div class="stat-value">{{ stats.success }}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="stat-value">{{ stats.unstable }}</div>
                        <div class="stat-label">Issues Found</div>
                    </div>
                    <div class="stat-box danger">
                        <div class="stat-value">{{ stats.failed }}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Build History -->
        <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
                üìã Recent Run History
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                    <a href="/?view=all" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view != 'mine' %}background:var(--accent);color:white;{% endif %}">All Runs</a>
                    <a href="/?view=mine" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view == 'mine' %}background:var(--accent);color:white;{% endif %}">My Runs</a>
                    <span class="collapse-icon" style="margin-left:8px;">‚ñº</span>
                </div>
                <button id="deleteSelectedBtn" onclick="event.stopPropagation(); deleteSelected()" class="btn btn-danger" style="margin-left:16px;display:none;">
                    üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)
                </button>
            </div>
            <div class="card-body" style="padding:0;">
                {% if builds %}
                <table class="build-table">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th style="width:60px;">Run</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Lab</th>
                            <th>Jump Host</th>
                            <th>Triggered By</th>
                            <th>Checks Run</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if running_build %}
                        <tr style="background:rgba(59,130,246,0.08);">
                            <td></td>
                            <td>
                                <a href="/job/{{ running_build.number }}/console" class="build-link" style="color:var(--accent);" title="View live console">
                                    <span class="status-icon running"></span>
                                    #{{ running_build.number }}
                                </a>
                            </td>
                            <td>
                                {% if running_build.options and running_build.options.task_type == 'cnv_combined' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;">üß¨ Combined</span>
                                {% elif running_build.options and running_build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">üî• CNV</span>
                                {% else %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">ü©∫ Health</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-running" style="animation:pulse 1.5s infinite;">
                                    üîÑ Running
                                </span>
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;">
                                {{ running_build.name or '‚Äî' }}
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                {{ running_build.options.server_host.split('.')[0] if running_build.options and running_build.options.server_host else '‚Äî' }}
                            </td>
                            <td style="font-size:12px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;">
                                    <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;font-weight:700;">{{ (running_build.triggered_by or 'S')[0]|upper }}</span>
                                    {{ running_build.triggered_by or 'system' }}
                                </span>
                            </td>
                            <td>
                                <span style="font-size:11px;">{{ running_build.checks_count or '‚Äî' }}</span>
                            </td>
                            <td>{{ running_build.timestamp or '‚Äî' }}</td>
                            <td><span id="running-row-elapsed" style="color:var(--accent);font-weight:600;">‚Äî</span></td>
                            <td>
                                {% if current_user.is_admin or running_build.user_id == current_user.id %}
                                <button onclick="stopBuild()" class="btn" style="color:var(--error);" title="Stop">‚èπÔ∏è</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% for build in builds %}
                        <tr>
                            <td>{% if current_user.is_admin or build.triggered_by == current_user.username %}<input type="checkbox" class="build-checkbox" value="{{ build.number }}" onchange="updateSelectedCount()">{% endif %}</td>
                            <td>
                                <a href="/job/{{ build.number }}" class="build-link">
                                    <span class="status-icon {{ build.status }}"></span>
                                    #{{ build.number }}
                                </a>
                            </td>
                            <td>
                                {% if build.options.task_type == 'cnv_combined' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;">üß¨ Combined</span>
                                {% elif build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">üî• CNV</span>
                                {% else %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">ü©∫ Health</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ build.status }}">
                                    {{ build.status_text }}
                                </span>
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;">
                                {{ build.name or '‚Äî' }}
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ build.options.server_host or '' }}">
                                {{ build.options.server_host.split('.')[0] if build.options.server_host else '‚Äî' }}
                            </td>
                            <td style="font-size:12px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;">
                                    <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;font-weight:700;">{{ (build.triggered_by or 'S')[0]|upper }}</span>
                                    {{ build.triggered_by or 'system' }}
                                </span>
                            </td>
                            <td>
                                {% if build.options.task_type in ['cnv_scenarios', 'cnv_combined'] %}
                                <span style="font-size:11px;">{{ build.checks_count }} tests</span>
                                {% else %}
                                {{ build.checks_count }} checks
                                {% endif %}
                            </td>
                            <td>{{ build.timestamp }}</td>
                            <td>{{ build.duration }}</td>
                            <td>
                                {% if build.report_file %}
                                <a href="/report/{{ build.report_file }}" class="btn" target="_blank">üìÑ Report</a>
                                {% endif %}
                                <a href="/job/{{ build.number }}/console" class="btn">üìù Console</a>
                                <a href="/job/rebuild/{{ build.number }}" class="btn" title="Rerun with same parameters">üîÑ Rerun</a>
                                {% if current_user.is_admin or build.triggered_by == current_user.username %}
                                <button onclick="deleteBuild({{ build.number }})" class="btn" style="color:var(--error);" title="Delete">üóëÔ∏è</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <h3>No builds yet</h3>
                    <p>Click "Run with Parameters" to run your first health check</p>
                </div>
                {% endif %}
            </div>
        </div>
    <!-- Edit Template Modal -->
    <div id="editTemplateModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;" onclick="if(event.target===this)closeEditTemplateModal()">
        <div style="background:var(--bg);border-radius:12px;padding:24px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                <h3 style="margin:0;font-size:18px;color:var(--text);">‚úèÔ∏è Rename Template</h3>
                <span onclick="closeEditTemplateModal()" style="cursor:pointer;font-size:20px;color:var(--text-muted);">&times;</span>
            </div>
            <input type="hidden" id="edit-tmpl-id">
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Template Name *</label>
                <input type="text" id="edit-tmpl-name" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Description</label>
                <input type="text" id="edit-tmpl-desc" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Icon</label>
                <div id="edit-tmpl-icon-picker" style="display:flex;gap:8px;flex-wrap:wrap;">
                    {% for icon in ['üìã','üöÄ','üî•','üèãÔ∏è','‚ö°','üß™','üéØ','üíª','üèóÔ∏è','üìä'] %}
                    <span class="edit-tmpl-icon-opt" data-icon="{{ icon }}" onclick="pickEditTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">{{ icon }}</span>
                    {% endfor %}
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="edit-tmpl-shared">
                    <span style="font-size:13px;color:var(--text);">Share with all team members</span>
                </label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" class="btn" onclick="closeEditTemplateModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditTemplate()" id="edit-tmpl-save-btn" style="padding:10px 24px;">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCard(header) {
        header.classList.toggle('collapsed');
        var body = header.nextElementSibling;
        if (body && body.classList.contains('card-body')) {
            body.classList.toggle('collapsed');
        }
    }
    
    function toggleSidebarSection(title) {
        title.classList.toggle('collapsed');
        var content = title.nextElementSibling;
        if (content && content.classList.contains('sidebar-content')) {
            content.classList.toggle('collapsed');
        }
    }
    
    function toggleSelectAll() {
        var selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.build-checkbox').forEach(function(cb) {
            cb.checked = selectAll;
        });
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        var count = document.querySelectorAll('.build-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('deleteSelectedBtn').style.display = count > 0 ? 'inline-flex' : 'none';
    }
    
    function deleteSelected() {
        var selected = [];
        document.querySelectorAll('.build-checkbox:checked').forEach(function(cb) {
            selected.push(cb.value);
        });
        
        if (selected.length === 0) return;
        
        if (confirm('Are you sure you want to delete ' + selected.length + ' build(s) and their reports?')) {
            Promise.all(selected.map(function(buildNum) {
                return fetch('/api/delete/' + buildNum, { method: 'POST' });
            })).then(function() {
                location.reload();
            });
        }
    }
    
    function deleteBuild(buildNum) {
        if (confirm('Are you sure you want to delete Run #' + buildNum + ' and its report?')) {
            fetch('/api/delete/' + buildNum, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete: ' + data.error);
                    }
                });
        }
    }
    
    function deleteBulk(filterType) {
        var messages = {
            'stopped': 'Are you sure you want to delete ALL STOPPED builds?',
            'failed': 'Are you sure you want to delete ALL FAILED builds?',
            'all': '‚ö†Ô∏è WARNING: This will delete ALL builds and their reports!\n\nAre you absolutely sure?'
        };
        
        if (confirm(messages[filterType])) {
            fetch('/api/delete-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filter: filterType})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Deleted ' + data.deleted + ' build(s)');
                    location.reload();
                } else {
                    alert('Failed to delete: ' + data.error);
                }
            });
        }
    }

    function toggleTmplMenu(trigger) {
        var menu = trigger.nextElementSibling;
        var isOpen = menu.style.display === 'block';
        document.querySelectorAll('.tmpl-menu').forEach(function(m) { m.style.display = 'none'; });
        if (!isOpen) menu.style.display = 'block';
    }

    document.addEventListener('click', function() {
        document.querySelectorAll('.tmpl-menu').forEach(function(m) { m.style.display = 'none'; });
    });

    var _editTemplateIcon = 'üìã';
    var _templateData = {{ user_templates | tojson }};

    function pickEditTemplateIcon(el) {
        document.querySelectorAll('.edit-tmpl-icon-opt').forEach(function(e) {
            e.style.borderColor = 'transparent';
        });
        el.style.borderColor = 'var(--accent)';
        _editTemplateIcon = el.getAttribute('data-icon');
    }

    function openEditTemplateModal(id) {
        document.querySelectorAll('.tmpl-menu').forEach(function(m) { m.style.display = 'none'; });
        var tmpl = _templateData.find(function(t) { return t.id === id; });
        if (!tmpl) return;
        document.getElementById('edit-tmpl-id').value = id;
        document.getElementById('edit-tmpl-name').value = tmpl.name;
        document.getElementById('edit-tmpl-desc').value = tmpl.description || '';
        document.getElementById('edit-tmpl-shared').checked = tmpl.shared;
        _editTemplateIcon = tmpl.icon || 'üìã';
        document.querySelectorAll('.edit-tmpl-icon-opt').forEach(function(e) {
            e.style.borderColor = e.getAttribute('data-icon') === _editTemplateIcon ? 'var(--accent)' : 'transparent';
        });
        document.getElementById('editTemplateModal').style.display = 'flex';
        document.getElementById('edit-tmpl-name').focus();
    }

    function closeEditTemplateModal() {
        document.getElementById('editTemplateModal').style.display = 'none';
    }

    function submitEditTemplate() {
        var id = document.getElementById('edit-tmpl-id').value;
        var name = document.getElementById('edit-tmpl-name').value.trim();
        if (!name) { alert('Name is required'); return; }
        var btn = document.getElementById('edit-tmpl-save-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        fetch('/api/templates/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: document.getElementById('edit-tmpl-desc').value.trim(),
                icon: _editTemplateIcon,
                shared: document.getElementById('edit-tmpl-shared').checked
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) { alert('Error: ' + data.error); }
            else { closeEditTemplateModal(); location.reload(); }
        })
        .catch(function(err) { alert('Save failed: ' + err); })
        .finally(function() { btn.disabled = false; btn.textContent = 'üíæ Save Changes'; });
    }

    function deleteTemplate(id, name) {
        document.querySelectorAll('.tmpl-menu').forEach(function(m) { m.style.display = 'none'; });
        if (!confirm('Delete template "' + name + '"?')) return;
        fetch('/api/templates/' + id, {method: 'DELETE'})
        .then(function(r) { return r.json(); })
        .then(function() { location.reload(); })
        .catch(function(err) { alert('Failed: ' + err); });
    }
</script>

<style>
    .tmpl-menu-trigger { opacity: 0.7 !important; font-weight: bold; }
    .tmpl-row:hover .tmpl-menu-trigger { opacity: 1 !important; }
</style>

{% if running_build %}
<script>
    var buildStartTime = {{ running_build.start_time }};
    
    function formatDuration(seconds) {
        if (seconds < 60) return seconds.toFixed(1) + 's';
        var mins = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        return mins + 'm ' + secs + 's';
    }
    
    function stopBuild() {
        if (confirm('Are you sure you want to stop the running build?')) {
            fetch('/api/stop', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to stop build: ' + data.error);
                    }
                });
        }
    }
    
    setInterval(function() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                if (data.running) {
                    var runningRowEl = document.getElementById('running-row-elapsed');
                    if (runningRowEl) {
                        var elapsed = Date.now() / 1000 - (data.start_time || buildStartTime);
                        runningRowEl.textContent = formatDuration(elapsed);
                    }
                } else {
                    location.reload();
                }
            });
    }, 2000);
</script>
{% endif %}
{% endblock %}
