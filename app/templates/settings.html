{% extends "base.html" %}

{% block title %}Settings - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>‚Ä∫</span>
<span>Settings</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a href="#thresholds" class="sidebar-item active">
                <span class="sidebar-icon">üìä</span>
                Alert Thresholds
            </a>
            <a href="#ssh" class="sidebar-item">
                <span class="sidebar-icon">üñ•Ô∏è</span>
                Jump Host
            </a>
            <a href="#ai" class="sidebar-item">
                <span class="sidebar-icon">ü§ñ</span>
                AI Configuration
            </a>
            <a href="#cnv" class="sidebar-item">
                <span class="sidebar-icon">üî•</span>
                CNV Scenarios
            </a>
            <a href="#jira" class="sidebar-item">
                <span class="sidebar-icon">üé´</span>
                Jira Configuration
            </a>
            <a href="#custom-checks" class="sidebar-item">
                <span class="sidebar-icon">üß™</span>
                Custom Checks
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Actions</div>
            <a href="#" onclick="resetDefaults(); return false;" class="sidebar-item" style="color:var(--warning);">
                <span class="sidebar-icon">üîÑ</span>
                Reset to Defaults
            </a>
        </div>
    </aside>
    
    <main class="main">
        {% if message %}
        <div style="background:var(--success-light);border:1px solid var(--success);border-radius:8px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
            <span style="font-size:24px;">‚úÖ</span>
            <div>
                <div style="font-weight:600;color:var(--success);font-size:16px;">Settings Saved</div>
                <div style="color:var(--text-secondary);font-size:13px;">{{ message }}</div>
            </div>
        </div>
        {% endif %}
        
        <form action="/settings" method="POST">
            <!-- Alert Thresholds -->
            <div class="card" id="thresholds">
                <div class="card-header">
                    üìä Alert Thresholds
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure the default thresholds used to determine when to flag resources as unhealthy. 
                        These values can be overridden per-run from the Build Configuration page.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üî• CPU Warning Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="range" name="cpu_warning" id="cpu_warning" 
                                    min="50" max="100" value="{{ thresholds.cpu_warning }}"
                                    style="flex:1;" oninput="document.getElementById('cpu_display').textContent=this.value+'%'">
                                <span id="cpu_display" style="width:50px;font-weight:600;font-size:18px;">{{ thresholds.cpu_warning }}%</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Nodes with CPU usage above this percentage will be flagged as high CPU.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üíæ Memory Warning Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="range" name="memory_warning" id="memory_warning" 
                                    min="50" max="100" value="{{ thresholds.memory_warning }}"
                                    style="flex:1;" oninput="document.getElementById('mem_display').textContent=this.value+'%'">
                                <span id="mem_display" style="width:50px;font-weight:600;font-size:18px;">{{ thresholds.memory_warning }}%</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Nodes with memory usage above this percentage will be flagged as high memory.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üíø Disk I/O Latency Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="disk_latency" id="disk_latency" 
                                    min="10" max="1000" value="{{ thresholds.disk_latency }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">ms</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Disk I/O operations taking longer than this will trigger a warning.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üóÑÔ∏è etcd Latency Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="etcd_latency" id="etcd_latency" 
                                    min="10" max="500" value="{{ thresholds.etcd_latency }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">ms</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                etcd latency above this is considered <strong style="color:var(--error);">CRITICAL</strong> - can cause cluster instability.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üì¶ Pod Density Warning
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="pod_density" id="pod_density" 
                                    min="10" max="250" value="{{ thresholds.pod_density }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">pods/node</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Warn when nodes have more than this many pods scheduled.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üîÅ Pod Restart Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="restart_count" id="restart_count" 
                                    min="1" max="50" value="{{ thresholds.restart_count }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">restarts</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Pods with more restarts than this will be flagged for attention.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üñ•Ô∏è virt-handler Memory Warning
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="virt_handler_memory" id="virt_handler_memory" 
                                    min="100" max="2000" value="{{ thresholds.virt_handler_memory }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">Mi</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                virt-handler pods using more than this memory will be flagged (CNV-66551 related).
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Jump Host -->
            <div class="card" id="ssh">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>üñ•Ô∏è Jump Host</span>
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-secondary);">
                        {{ saved_hosts|length }} host{{ 's' if saved_hosts|length != 1 else '' }}
                    </span>
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Add the target hosts that have <code>oc</code> access. These will appear in the build dropdown.
                    </p>
                    
                    <!-- Existing hosts list -->
                    <div id="hosts-list">
                        {% for h in saved_hosts %}
                        <div class="host-row" style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;">
                            <input type="hidden" name="host_id[]" value="{{ h.id }}">
                            <input type="hidden" name="host_password[]" value="">
                            <span style="font-size:18px;">üñ•Ô∏è</span>
                            <div style="flex:1;display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;">
                                <input type="text" name="host_name[]" value="{{ h.name }}" placeholder="Label"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-weight:600;">
                                <input type="text" name="host_addr[]" value="{{ h.host }}" placeholder="hostname or IP"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                                <input type="text" name="host_user[]" value="{{ h.user or 'root' }}" placeholder="user"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <button type="button" onclick="removeHost(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:18px;padding:4px 8px;" title="Remove host">
                                &times;
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Add host button ‚Äî adds a blank row to fill in -->
                    <button type="button" onclick="addBlankHostRow()" style="width:100%;padding:12px;border:2px dashed var(--border);border-radius:8px;background:transparent;color:var(--accent);cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        + Add Jump Host
                    </button>
                </div>
            </div>
            
            <!-- AI Configuration -->
            <div class="card" id="ai">
                <div class="card-header">
                    ü§ñ AI Configuration
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure the AI model used for root cause analysis.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Ollama Model
                            </label>
                            <input type="text" name="ollama_model" id="ollama_model" 
                                value="{{ ai_config.model }}"
                                placeholder="e.g., ollama/llama3.2:3b"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Ollama URL
                            </label>
                            <input type="text" name="ollama_url" id="ollama_url" 
                                value="{{ ai_config.url }}"
                                placeholder="e.g., http://localhost:11434"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CNV Scenarios Defaults -->
            <div class="card" id="cnv">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>üî• CNV Scenarios Defaults</span>
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:linear-gradient(135deg,#ff6b3520,#ff8c4220);color:#ff6b35;">
                        kube-burner workloads
                    </span>
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Set default values for CNV scenario execution. These will pre-fill the build configuration page.
                    </p>

                    <!-- Execution Defaults -->
                    <div style="margin-bottom:28px;">
                        <h4 style="margin:0 0 16px 0;font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);">
                            Execution Defaults
                        </h4>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    üìÇ CNV Scenarios Path
                                </label>
                                <input type="text" name="cnv_path" id="cnv_path"
                                    value="{{ cnv_config.cnv_path }}"
                                    placeholder="/home/kni/git/cnv-scenarios"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:monospace;">
                                <span style="font-size:11px;color:var(--text-secondary);display:block;margin-top:6px;">
                                    Path to cnv-scenarios repo on the jump host
                                </span>
                            </div>
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    üéØ Default Mode
                                </label>
                                <select name="cnv_mode" id="cnv_mode"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg);">
                                    <option value="sanity" {{ 'selected' if cnv_config.mode == 'sanity' }}>Sanity (quick)</option>
                                    <option value="full" {{ 'selected' if cnv_config.mode == 'full' }}>Full (complete)</option>
                                </select>
                                <span style="font-size:11px;color:var(--text-secondary);display:block;margin-top:6px;">
                                    Sanity runs a quick subset; Full runs all iterations
                                </span>
                            </div>
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    ‚ö° Parallel Execution
                                </label>
                                <div style="display:flex;align-items:center;gap:12px;padding:8px 0;">
                                    <label class="toggle-switch" style="position:relative;display:inline-block;width:48px;height:26px;">
                                        <input type="checkbox" name="cnv_parallel" id="cnv_parallel"
                                            {{ 'checked' if cnv_config.parallel }}
                                            style="opacity:0;width:0;height:0;">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size:13px;color:var(--text-secondary);" id="cnv_parallel_label">
                                        {{ 'Enabled' if cnv_config.parallel else 'Disabled' }}
                                    </span>
                                </div>
                                <span style="font-size:11px;color:var(--text-secondary);display:block;margin-top:2px;">
                                    Run selected scenarios in parallel
                                </span>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:16px;">
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    üìã kube-burner Log Level
                                </label>
                                <select name="cnv_kb_log_level" id="cnv_kb_log_level"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg);">
                                    <option value="" {{ 'selected' if not cnv_config.kb_log_level }}>Default</option>
                                    <option value="debug" {{ 'selected' if cnv_config.kb_log_level == 'debug' }}>Debug</option>
                                    <option value="info" {{ 'selected' if cnv_config.kb_log_level == 'info' }}>Info</option>
                                    <option value="warn" {{ 'selected' if cnv_config.kb_log_level == 'warn' }}>Warn</option>
                                    <option value="error" {{ 'selected' if cnv_config.kb_log_level == 'error' }}>Error</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    ‚è±Ô∏è kube-burner Timeout
                                </label>
                                <input type="text" name="cnv_kb_timeout" id="cnv_kb_timeout"
                                    value="{{ cnv_config.kb_timeout }}"
                                    placeholder="e.g. 4h, 8h (empty = default)"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;">
                            </div>
                        </div>
                    </div>

                    <!-- Global Variables -->
                    <div style="margin-bottom:28px;">
                        <h4 style="margin:0 0 16px 0;font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);">
                            üåç Global Variables
                        </h4>
                        <p style="color:var(--text-secondary);font-size:12px;margin-bottom:14px;">
                            These apply across all scenarios. Leave blank to use each scenario's built-in default.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
                            {% for var_name, var_info in cnv_global_vars.items() %}
                            <div class="setting-group">
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                    {{ var_info.icon }} {{ var_info.label }}
                                </label>
                                {% set def_val = var_info.default.sanity if var_info.default is mapping else var_info.default %}
                                {% set ph_val = var_info.placeholder.sanity if var_info.placeholder is mapping else var_info.placeholder %}
                                <input type="text" name="cnv_default_{{ var_name }}" id="cnv_default_{{ var_name }}"
                                    value="{{ cnv_config.global_vars[var_name] if cnv_config.global_vars is defined and var_name in cnv_config.global_vars else def_val }}"
                                    placeholder="{{ ph_val }}"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;">
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Per-Scenario Variable Defaults -->
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h4 style="margin:0;font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);">
                                üß™ Per-Scenario Variable Defaults
                            </h4>
                            <button type="button" onclick="toggleAllScenarioDefaults()" style="padding:6px 14px;border:1px solid var(--border);border-radius:6px;background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer;font-size:12px;">
                                Expand / Collapse All
                            </button>
                        </div>
                        <p style="color:var(--text-secondary);font-size:12px;margin-bottom:14px;">
                            Override defaults for each scenario's test-specific variables. Leave blank to use the built-in default.
                        </p>

                        {% for sid, scenario in cnv_scenarios.items() %}
                        {% if scenario.variables %}
                        {% set saved_sv = cnv_config.get('scenario_vars', {}).get(sid, {}) %}
                        <div class="cnv-settings-scenario" style="border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden;">
                            <div class="cnv-scenario-header" onclick="toggleScenarioDefaults('{{ sid }}')"
                                style="display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--bg-secondary);cursor:pointer;user-select:none;transition:background 0.2s;"
                                onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-secondary)'">
                                <span style="font-size:20px;">{{ scenario.icon }}</span>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:14px;">{{ scenario.name }}</div>
                                    <div style="font-size:11px;color:var(--text-secondary);">{{ scenario.category }} ¬∑ {{ scenario.variables|length }} parameters</div>
                                </div>
                                <span class="cnv-scenario-chevron" id="chevron-{{ sid }}" style="font-size:14px;color:var(--text-secondary);transition:transform 0.2s;">‚ñ∂</span>
                            </div>
                            <div class="cnv-scenario-vars" id="vars-{{ sid }}" style="display:none;padding:16px 18px;border-top:1px solid var(--border);">
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                                    {% for var_name, var_info in scenario.variables.items() %}
                                    {% set saved_val = saved_sv.get(var_name) if saved_sv else None %}
                                    {% set cur_val = saved_val if saved_val is not none else var_info.default %}
                                    <div class="setting-group" style="padding:12px;">
                                        <label style="display:block;font-weight:600;margin-bottom:6px;color:var(--text);font-size:12px;">
                                            {{ var_info.label }}
                                            <span style="font-weight:400;color:var(--text-secondary);font-size:11px;margin-left:4px;">({{ var_name }})</span>
                                        </label>
                                        {% if var_info.type == 'bool' %}
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <label class="toggle-switch" style="position:relative;display:inline-block;width:42px;height:22px;">
                                                <input type="hidden" name="cnv_var_{{ sid }}_{{ var_name }}" value="off">
                                                <input type="checkbox" name="cnv_var_{{ sid }}_{{ var_name }}" value="on"
                                                    {{ 'checked' if cur_val }}
                                                    style="opacity:0;width:0;height:0;">
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span style="font-size:12px;color:var(--text-secondary);">{{ 'On' if cur_val else 'Off' }} by default</span>
                                        </div>
                                        {% elif var_info.type == 'choice' %}
                                        <select name="cnv_var_{{ sid }}_{{ var_name }}"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg);">
                                            {% for ch in var_info.choices %}
                                            <option value="{{ ch }}" {{ 'selected' if ch == cur_val }}>{{ ch }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif var_info.type == 'int' %}
                                        <input type="number" name="cnv_var_{{ sid }}_{{ var_name }}"
                                            value="{{ cur_val }}"
                                            {% if var_info.min is defined %}min="{{ var_info.min }}"{% endif %}
                                            {% if var_info.max is defined %}max="{{ var_info.max }}"{% endif %}
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;">
                                        {% else %}
                                        <input type="text" name="cnv_var_{{ sid }}_{{ var_name }}"
                                            value="{{ cur_val }}"
                                            placeholder="{{ var_info.placeholder if var_info.placeholder is defined else '' }}"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Jira Configuration -->
            <div class="card" id="jira">
                <div class="card-header">
                    üé´ Jira Configuration
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure Jira integration for bug scanning and pattern learning.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Jira Projects to Scan
                            </label>
                            <input type="text" name="jira_projects" id="jira_projects" 
                                value="{{ jira_config.projects|join(', ') }}"
                                placeholder="e.g., CNV, OCPBUGS, ODF"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Comma-separated list of Jira project keys
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Bug Scan Period (days)
                            </label>
                            <input type="number" name="jira_scan_days" id="jira_scan_days" 
                                value="{{ jira_config.scan_days }}"
                                min="1" max="365"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                How far back to look for bugs when scanning
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Max Bugs to Analyze
                            </label>
                            <input type="number" name="jira_bug_limit" id="jira_bug_limit" 
                                value="{{ jira_config.bug_limit }}"
                                min="10" max="500"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Maximum number of bugs to analyze per scan
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Custom Health Checks -->
            <div class="card" id="custom-checks">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>üß™ Custom Health Checks</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-secondary);"
                            id="custom-check-count">{{ custom_checks|length }} check{{ 's' if custom_checks|length != 1 else '' }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <p style="color:var(--text-secondary);margin:0;">
                            Define your own health checks with custom commands or scripts. Export to share with others.
                        </p>
                        <div style="display:flex;gap:6px;flex-shrink:0;margin-left:16px;">
                            {% if custom_checks %}
                            <a href="/api/custom-checks/export"
                                style="padding:6px 14px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-weight:600;color:var(--accent);text-decoration:none;white-space:nowrap;transition:all 0.2s;"
                                onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                                üì§ Export
                            </a>
                            {% endif %}
                            <label id="import-btn"
                                style="padding:6px 14px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-weight:600;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all 0.2s;"
                                onmouseover="this.style.borderColor='var(--accent);this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'">
                                üì• Import
                                <input type="file" accept=".json" style="display:none;" onchange="importCustomChecks(this)">
                            </label>
                        </div>
                    </div>

                    <!-- Existing custom checks list -->
                    <div id="custom-checks-list">
                        {% for cc in custom_checks %}
                        <div class="custom-check-row" data-id="{{ cc.id }}"
                             style="border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden;transition:border-color 0.2s;">
                            <div style="display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--bg-secondary);cursor:pointer;user-select:none;"
                                 onclick="toggleCustomCheckEdit(this.parentElement)">
                                <span style="font-size:20px;">{% if cc.check_type == 'script' %}üìú{% else %}üß™{% endif %}</span>
                                <div style="flex:1;min-width:0;">
                                    <div style="font-weight:600;font-size:14px;color:var(--text);">{{ cc.name }}</div>
                                    <div style="font-size:11px;color:var(--text-secondary);font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                        {% if cc.check_type == 'script' %}üìú {{ cc.script_filename or 'script.sh' }}{% else %}{{ cc.command }}{% endif %}
                                    </div>
                                </div>
                                {% if cc.check_type == 'script' %}
                                <span style="font-size:11px;padding:3px 8px;border-radius:10px;background:#f0883e20;color:#f0883e;">Script</span>
                                {% endif %}
                                <span style="font-size:11px;padding:3px 10px;border-radius:10px;white-space:nowrap;
                                    {% if cc.run_with == 'health_check' %}background:#238636;color:#fff;
                                    {% elif cc.run_with == 'scenario' %}background:#1f6feb;color:#fff;
                                    {% else %}background:#8b5cf6;color:#fff;{% endif %}">
                                    {% if cc.run_with == 'health_check' %}Health Check
                                    {% elif cc.run_with == 'scenario' %}Scenario
                                    {% else %}Both{% endif %}
                                </span>
                                {% if not cc.enabled %}
                                <span style="font-size:11px;padding:3px 8px;border-radius:10px;background:var(--border);color:var(--text-secondary);">Disabled</span>
                                {% endif %}
                                <span class="cc-chevron" style="font-size:14px;color:var(--text-secondary);transition:transform 0.2s;">‚ñ∂</span>
                            </div>
                            <div class="cc-edit-panel" style="display:none;padding:16px 18px;border-top:1px solid var(--border);">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Name</label>
                                        <input type="text" class="cc-name" value="{{ cc.name }}"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Description</label>
                                        <input type="text" class="cc-desc" value="{{ cc.description }}" placeholder="Optional description"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                                    </div>
                                </div>
                                <!-- Check Type Toggle -->
                                <div style="margin-bottom:12px;">
                                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Type</label>
                                    <div style="display:flex;gap:8px;">
                                        <label class="cc-type-btn" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid {% if cc.check_type != 'script' %}var(--accent){% else %}var(--border){% endif %};border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;{% if cc.check_type != 'script' %}background:var(--accent-light);{% endif %}"
                                            onclick="switchCheckType(this.closest('.cc-edit-panel'), 'command')">
                                            <input type="radio" name="cc_type_{{ cc.id }}" value="command" {{ 'checked' if cc.check_type != 'script' }} style="display:none;" class="cc-type-radio">
                                            üß™ Command
                                        </label>
                                        <label class="cc-type-btn" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid {% if cc.check_type == 'script' %}var(--accent){% else %}var(--border){% endif %};border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;{% if cc.check_type == 'script' %}background:var(--accent-light);{% endif %}"
                                            onclick="switchCheckType(this.closest('.cc-edit-panel'), 'script')">
                                            <input type="radio" name="cc_type_{{ cc.id }}" value="script" {{ 'checked' if cc.check_type == 'script' }} style="display:none;" class="cc-type-radio">
                                            üìú Script
                                        </label>
                                    </div>
                                </div>
                                <!-- Command input -->
                                <div class="cc-command-section" style="margin-bottom:12px;{% if cc.check_type == 'script' %}display:none;{% endif %}">
                                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Command</label>
                                    <input type="text" class="cc-cmd" value="{{ cc.command }}"
                                        style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                                </div>
                                <!-- Script input -->
                                <div class="cc-script-section" style="margin-bottom:12px;{% if cc.check_type != 'script' %}display:none;{% endif %}">
                                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">
                                        Script
                                        {% if cc.script_filename %}<span style="font-weight:400;color:var(--text-secondary);margin-left:6px;">{{ cc.script_filename }}</span>{% endif %}
                                    </label>
                                    <textarea class="cc-script" rows="6" placeholder="#!/bin/bash&#10;# Your validation script here&#10;..."
                                        style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:monospace;resize:vertical;background:var(--bg);color:var(--text);">{{ cc.script_content }}</textarea>
                                    <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                                        <label style="padding:4px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px;color:var(--accent);font-weight:600;">
                                            üìÅ Upload Script
                                            <input type="file" class="cc-file-upload" accept=".sh,.bash,.py,.pl,.rb,.txt" style="display:none;"
                                                onchange="loadFileIntoTextarea(this, this.closest('.cc-script-section').querySelector('.cc-script'))">
                                        </label>
                                        <span class="cc-filename" style="font-size:11px;color:var(--text-secondary);">{{ cc.script_filename or '' }}</span>
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Expected Value</label>
                                        <input type="text" class="cc-expected" value="{{ cc.expected_value }}" placeholder="e.g. Ready, 0, ..."
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Match Type</label>
                                        <select class="cc-match"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                            <option value="contains" {{ 'selected' if cc.match_type == 'contains' }}>Contains</option>
                                            <option value="exact" {{ 'selected' if cc.match_type == 'exact' }}>Exact Match</option>
                                            <option value="regex" {{ 'selected' if cc.match_type == 'regex' }}>Regex</option>
                                            <option value="exit_code" {{ 'selected' if cc.match_type == 'exit_code' }}>Exit Code</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Run With</label>
                                        <select class="cc-runwith"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                            <option value="health_check" {{ 'selected' if cc.run_with == 'health_check' }}>Health Check</option>
                                            <option value="scenario" {{ 'selected' if cc.run_with == 'scenario' }}>Scenario Only</option>
                                            <option value="both" {{ 'selected' if cc.run_with == 'both' }}>Both</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Linked Scenario</label>
                                        <select class="cc-scenario"
                                            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                            <option value="">All / None</option>
                                            {% for sid, sc in cnv_scenarios.items() %}
                                            <option value="{{ sid }}" {{ 'selected' if cc.linked_scenario == sid }}>{{ sc.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;justify-content:space-between;">
                                    <div style="display:flex;align-items:center;gap:12px;">
                                        <label class="toggle-switch" style="position:relative;display:inline-block;width:42px;height:22px;">
                                            <input type="checkbox" class="cc-enabled" {{ 'checked' if cc.enabled }}
                                                style="opacity:0;width:0;height:0;">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span style="font-size:12px;color:var(--text-secondary);">{{ 'Enabled' if cc.enabled else 'Disabled' }}</span>
                                    </div>
                                    <div style="display:flex;gap:8px;">
                                        <button type="button" onclick="saveCustomCheck(this.closest('.custom-check-row'))"
                                            style="padding:6px 16px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:12px;font-weight:600;">
                                            Save
                                        </button>
                                        <button type="button" onclick="deleteCustomCheck(this.closest('.custom-check-row'))"
                                            style="padding:6px 16px;border:none;border-radius:6px;background:var(--error);color:#fff;cursor:pointer;font-size:12px;font-weight:600;">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Add New Check -->
                    <div id="new-check-form" style="display:none;border:2px solid var(--accent);border-radius:10px;padding:18px;margin-bottom:12px;background:var(--bg-secondary);">
                        <h4 style="margin:0 0 14px;font-size:14px;color:var(--accent);">New Custom Check</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Name *</label>
                                <input type="text" id="new-cc-name" placeholder="e.g. Check VM count"
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Description</label>
                                <input type="text" id="new-cc-desc" placeholder="What this check validates"
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                        </div>
                        <!-- Check Type Toggle -->
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Type</label>
                            <div style="display:flex;gap:8px;">
                                <label id="new-cc-type-cmd-btn" class="cc-type-btn" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid var(--accent);border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:var(--accent-light);"
                                    onclick="switchNewCheckType('command')">
                                    <input type="radio" name="new_cc_type" value="command" checked style="display:none;">
                                    üß™ Command
                                </label>
                                <label id="new-cc-type-script-btn" class="cc-type-btn" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;"
                                    onclick="switchNewCheckType('script')">
                                    <input type="radio" name="new_cc_type" value="script" style="display:none;">
                                    üìú Script
                                </label>
                            </div>
                        </div>
                        <!-- Command input -->
                        <div id="new-cc-command-section" style="margin-bottom:12px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Command *</label>
                            <input type="text" id="new-cc-cmd" placeholder="e.g. oc get vms -A --no-headers | wc -l"
                                style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                        </div>
                        <!-- Script input -->
                        <div id="new-cc-script-section" style="margin-bottom:12px;display:none;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Script *</label>
                            <textarea id="new-cc-script" rows="8" placeholder="#!/bin/bash&#10;# Your validation script here&#10;# The script's stdout output will be compared with the expected value&#10;# Example:&#10;COUNT=$(oc get vms -A --no-headers | wc -l)&#10;echo $COUNT"
                                style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:monospace;resize:vertical;background:var(--bg);color:var(--text);"></textarea>
                            <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                                <label style="padding:6px 14px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;color:var(--accent);font-weight:600;transition:all 0.2s;"
                                    onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                                    üìÅ Upload Script File
                                    <input type="file" id="new-cc-file" accept=".sh,.bash,.py,.pl,.rb,.txt" style="display:none;"
                                        onchange="loadFileIntoTextarea(this, document.getElementById('new-cc-script'))">
                                </label>
                                <span id="new-cc-filename" style="font-size:11px;color:var(--text-secondary);"></span>
                            </div>
                            <div style="margin-top:6px;padding:8px 12px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--text-secondary);">
                                üí° The script will be uploaded to the jump host and executed. Its stdout output is compared against the expected value.
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:14px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Expected Value</label>
                                <input type="text" id="new-cc-expected" placeholder="e.g. 0, Ready, ..."
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Match Type</label>
                                <select id="new-cc-match"
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                    <option value="contains">Contains</option>
                                    <option value="exact">Exact Match</option>
                                    <option value="regex">Regex</option>
                                    <option value="exit_code">Exit Code</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Run With</label>
                                <select id="new-cc-runwith"
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                    <option value="health_check">Health Check</option>
                                    <option value="scenario">Scenario Only</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:12px;color:var(--text);">Linked Scenario</label>
                                <select id="new-cc-scenario"
                                    style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg);">
                                    <option value="">All / None</option>
                                    {% for sid, sc in cnv_scenarios.items() %}
                                    <option value="{{ sid }}">{{ sc.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button type="button" onclick="createCustomCheck()"
                                style="padding:8px 24px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:13px;font-weight:600;">
                                Create Check
                            </button>
                            <button type="button" onclick="document.getElementById('new-check-form').style.display='none';document.getElementById('add-check-btn').style.display='block';"
                                style="padding:8px 24px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:13px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <button type="button" id="add-check-btn" onclick="document.getElementById('new-check-form').style.display='block';this.style.display='none';document.getElementById('new-cc-name').focus();"
                        style="width:100%;padding:12px;border:2px dashed var(--border);border-radius:8px;background:transparent;color:var(--accent);cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        + Add Custom Check
                    </button>
                </div>
            </div>

            <!-- Save Button -->
            <div style="display:flex;gap:12px;margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;padding:16px;font-size:16px;">
                    üíæ Save Settings
                </button>
            </div>
        </form>
    </main>
</div>

<script>
function addBlankHostRow() {
    var list = document.getElementById('hosts-list');
    var row = document.createElement('div');
    row.className = 'host-row';
    row.style.cssText = 'padding:14px;background:var(--bg-secondary);border:1px solid var(--accent);border-radius:8px;margin-bottom:10px;';
    row.innerHTML = '<input type="hidden" name="host_id[]" value="">' +
        '<input type="hidden" name="host_password[]" value="">' +
        '<div style="display:flex;align-items:center;gap:12px;">' +
            '<span style="font-size:18px;">üñ•Ô∏è</span>' +
            '<div style="flex:1;display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;">' +
                '<input type="text" name="host_name[]" value="" placeholder="Label (e.g. Lab Cluster)" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-weight:600;">' +
                '<input type="text" name="host_addr[]" value="" placeholder="hostname or IP" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">' +
                '<input type="text" name="host_user[]" value="root" placeholder="user" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">' +
            '</div>' +
            '<button type="button" onclick="removeHost(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:18px;padding:4px 8px;" title="Remove host">&times;</button>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:8px;margin-top:10px;padding-left:30px;">' +
            '<span style="font-size:14px;">üîë</span>' +
            '<input type="password" class="host-pwd-input" value="" placeholder="Password (optional ‚Äî for passwordless SSH setup)" style="flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">' +
            '<button type="submit" class="btn btn-primary" style="padding:8px 20px;font-size:13px;white-space:nowrap;" onclick="copyPwdToHidden(this)">+ Add</button>' +
        '</div>';
    list.appendChild(row);
    row.querySelector('input[name="host_addr[]"]').focus();
}

function copyPwdToHidden(btn) {
    var row = btn.closest('.host-row');
    var pwdInput = row.querySelector('.host-pwd-input');
    var hiddenPwd = row.querySelector('input[name="host_password[]"]');
    if (pwdInput && hiddenPwd) {
        hiddenPwd.value = pwdInput.value;
    }
}

function removeHost(btn) {
    btn.closest('.host-row').remove();
}

function resetDefaults() {
    if (!confirm('Reset all settings to their default values?')) return;
    
    // Reset threshold values
    document.getElementById('cpu_warning').value = 85;
    document.getElementById('cpu_display').textContent = '85%';
    document.getElementById('memory_warning').value = 80;
    document.getElementById('mem_display').textContent = '80%';
    document.getElementById('disk_latency').value = 100;
    document.getElementById('etcd_latency').value = 100;
    document.getElementById('pod_density').value = 50;
    document.getElementById('restart_count').value = 5;
    document.getElementById('virt_handler_memory').value = 500;
    
    // Reset AI config
    document.getElementById('ollama_model').value = 'ollama/llama3.2:3b';
    document.getElementById('ollama_url').value = 'http://localhost:11434';
    
    // Reset Jira config
    document.getElementById('jira_projects').value = 'CNV, OCPBUGS, ODF';
    document.getElementById('jira_scan_days').value = 30;
    document.getElementById('jira_bug_limit').value = 50;

    // Reset CNV Scenarios defaults
    document.getElementById('cnv_path').value = '/home/kni/git/cnv-scenarios';
    document.getElementById('cnv_mode').value = 'sanity';
    var parEl = document.getElementById('cnv_parallel');
    if (parEl) { parEl.checked = false; }
    document.getElementById('cnv_parallel_label').textContent = 'Disabled';
    document.getElementById('cnv_kb_log_level').value = '';
    document.getElementById('cnv_kb_timeout').value = '';
    var gvDefaults = {{ cnv_global_vars | tojson }};
    for (var k in gvDefaults) {
        var el = document.getElementById('cnv_default_' + k);
        if (el) el.value = gvDefaults[k].default || '';
    }
    // Reset per-scenario vars to built-in defaults
    var scenarioDefaults = {{ cnv_scenarios | tojson }};
    for (var sid in scenarioDefaults) {
        var vars = scenarioDefaults[sid].variables || {};
        for (var vn in vars) {
            var inp = document.querySelector('[name="cnv_var_' + sid + '_' + vn + '"]');
            if (!inp) continue;
            if (inp.type === 'checkbox') {
                inp.checked = !!vars[vn].default;
            } else {
                inp.value = vars[vn].default !== undefined ? vars[vn].default : '';
            }
        }
    }
    
    alert('Default values restored. Click "Save Settings" to apply.');
}

/* ‚îÄ‚îÄ CNV Scenarios Defaults: Expand/Collapse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleScenarioDefaults(sid) {
    var panel = document.getElementById('vars-' + sid);
    var chevron = document.getElementById('chevron-' + sid);
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        chevron.textContent = '‚ñº';
    } else {
        panel.style.display = 'none';
        chevron.textContent = '‚ñ∂';
    }
}

var _allScenariosExpanded = false;
function toggleAllScenarioDefaults() {
    _allScenariosExpanded = !_allScenariosExpanded;
    document.querySelectorAll('.cnv-scenario-vars').forEach(function(el) {
        el.style.display = _allScenariosExpanded ? 'block' : 'none';
    });
    document.querySelectorAll('.cnv-scenario-chevron').forEach(function(el) {
        el.textContent = _allScenariosExpanded ? '‚ñº' : '‚ñ∂';
    });
}

/* Toggle switch label update */
document.addEventListener('DOMContentLoaded', function() {
    var par = document.getElementById('cnv_parallel');
    if (par) {
        par.addEventListener('change', function() {
            document.getElementById('cnv_parallel_label').textContent = this.checked ? 'Enabled' : 'Disabled';
        });
    }
});

/* ‚îÄ‚îÄ Custom Checks CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleCustomCheckEdit(row) {
    var panel = row.querySelector('.cc-edit-panel');
    var chevron = row.querySelector('.cc-chevron');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        chevron.textContent = '‚ñº';
        row.style.borderColor = 'var(--accent)';
    } else {
        panel.style.display = 'none';
        chevron.textContent = '‚ñ∂';
        row.style.borderColor = 'var(--border)';
    }
}

/* Toggle between command / script mode in edit panels */
function switchCheckType(panel, type) {
    var cmdSection = panel.querySelector('.cc-command-section');
    var scriptSection = panel.querySelector('.cc-script-section');
    var btns = panel.querySelectorAll('.cc-type-btn');
    btns.forEach(function(b) {
        var radio = b.querySelector('.cc-type-radio');
        if (radio && radio.value === type) {
            b.style.borderColor = 'var(--accent)';
            b.style.background = 'var(--accent-light)';
            radio.checked = true;
        } else {
            b.style.borderColor = 'var(--border)';
            b.style.background = '';
        }
    });
    if (type === 'script') {
        cmdSection.style.display = 'none';
        scriptSection.style.display = 'block';
    } else {
        cmdSection.style.display = 'block';
        scriptSection.style.display = 'none';
    }
}

/* Toggle for the "New Check" form */
function switchNewCheckType(type) {
    var cmdBtn = document.getElementById('new-cc-type-cmd-btn');
    var scriptBtn = document.getElementById('new-cc-type-script-btn');
    var cmdSection = document.getElementById('new-cc-command-section');
    var scriptSection = document.getElementById('new-cc-script-section');
    if (type === 'script') {
        cmdBtn.style.borderColor = 'var(--border)'; cmdBtn.style.background = '';
        scriptBtn.style.borderColor = 'var(--accent)'; scriptBtn.style.background = 'var(--accent-light)';
        cmdSection.style.display = 'none';
        scriptSection.style.display = 'block';
    } else {
        scriptBtn.style.borderColor = 'var(--border)'; scriptBtn.style.background = '';
        cmdBtn.style.borderColor = 'var(--accent)'; cmdBtn.style.background = 'var(--accent-light)';
        scriptSection.style.display = 'none';
        cmdSection.style.display = 'block';
    }
}

/* Read file content into textarea */
function loadFileIntoTextarea(fileInput, textarea) {
    var file = fileInput.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        textarea.value = e.target.result;
        // Show filename
        var label = fileInput.closest('div').querySelector('.cc-filename') ||
                    document.getElementById('new-cc-filename');
        if (label) label.textContent = file.name;
    };
    reader.readAsText(file);
}

function createCustomCheck() {
    var name = document.getElementById('new-cc-name').value.trim();
    var isScript = document.getElementById('new-cc-type-script-btn').style.borderColor.indexOf('accent') >= 0 ||
                   document.querySelector('input[name="new_cc_type"][value="script"]').checked;
    var cmd = document.getElementById('new-cc-cmd').value.trim();
    var scriptContent = (document.getElementById('new-cc-script') || {}).value || '';
    scriptContent = scriptContent.trim();
    var checkType = isScript ? 'script' : 'command';

    if (!name) { alert('Name is required.'); return; }
    if (checkType === 'command' && !cmd) { alert('Command is required.'); return; }
    if (checkType === 'script' && !scriptContent) { alert('Script content is required (paste or upload a file).'); return; }

    // Get filename if uploaded
    var fileInput = document.getElementById('new-cc-file');
    var scriptFilename = '';
    if (fileInput && fileInput.files[0]) scriptFilename = fileInput.files[0].name;

    fetch('/api/custom-checks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            check_type: checkType,
            command: cmd,
            script_content: scriptContent,
            script_filename: scriptFilename,
            description: document.getElementById('new-cc-desc').value.trim(),
            expected_value: document.getElementById('new-cc-expected').value.trim(),
            match_type: document.getElementById('new-cc-match').value,
            run_with: document.getElementById('new-cc-runwith').value,
            linked_scenario: document.getElementById('new-cc-scenario').value,
            enabled: true
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function saveCustomCheck(row) {
    var id = row.getAttribute('data-id');
    var panel = row.querySelector('.cc-edit-panel');
    var checkedRadio = panel.querySelector('.cc-type-radio:checked');
    var checkType = checkedRadio ? checkedRadio.value : 'command';
    var scriptEl = panel.querySelector('.cc-script');

    fetch('/api/custom-checks/' + id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: row.querySelector('.cc-name').value.trim(),
            check_type: checkType,
            command: row.querySelector('.cc-cmd').value.trim(),
            script_content: scriptEl ? scriptEl.value.trim() : '',
            description: row.querySelector('.cc-desc').value.trim(),
            expected_value: row.querySelector('.cc-expected').value.trim(),
            match_type: row.querySelector('.cc-match').value,
            run_with: row.querySelector('.cc-runwith').value,
            linked_scenario: row.querySelector('.cc-scenario').value,
            enabled: row.querySelector('.cc-enabled').checked
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function deleteCustomCheck(row) {
    if (!confirm('Delete this custom check?')) return;
    var id = row.getAttribute('data-id');
    fetch('/api/custom-checks/' + id, { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            row.remove();
            updateCustomCheckCount();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function updateCustomCheckCount() {
    var cnt = document.querySelectorAll('.custom-check-row').length;
    document.getElementById('custom-check-count').textContent = cnt + ' check' + (cnt !== 1 ? 's' : '');
}

/* ‚îÄ‚îÄ Import custom checks from JSON file ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function importCustomChecks(fileInput) {
    var file = fileInput.files[0];
    if (!file) return;

    var mode = 'merge';
    if (document.querySelectorAll('.custom-check-row').length > 0) {
        var choice = confirm(
            'You already have custom checks.\n\n' +
            'OK = Merge (skip duplicates by name)\n' +
            'Cancel = Replace all existing checks'
        );
        mode = choice ? 'merge' : 'replace';
        if (mode === 'replace' && !confirm('Are you sure? This will delete ALL existing checks and replace with the imported ones.')) {
            fileInput.value = '';
            return;
        }
    }

    var formData = new FormData();
    formData.append('file', file);
    formData.append('mode', mode);

    fetch('/api/custom-checks/import', {
        method: 'POST',
        body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            alert('Import complete!\n\n' +
                  'Imported: ' + data.imported + '\n' +
                  'Skipped: ' + data.skipped + ' (duplicates or invalid)\n' +
                  'Total in file: ' + data.total);
            location.reload();
        } else {
            alert('Import failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(function(e) {
        alert('Import error: ' + e);
    });

    fileInput.value = '';
}

// Track unsaved changes ‚Äî warn before leaving the page
(function() {
    var form = document.querySelector('form[action="/settings"]');
    var saved = true;

    function markDirty() { saved = false; }

    // Listen for any input change inside the form
    form.addEventListener('input', markDirty);
    form.addEventListener('change', markDirty);

    // Adding/removing host rows counts as a change
    var origRemove = window.removeHost;
    window.removeHost = function(btn) { markDirty(); origRemove(btn); };
    var origAdd = window.addBlankHostRow;
    window.addBlankHostRow = function() { markDirty(); origAdd(); };

    // When the form is submitted, it's being saved ‚Äî don't warn
    form.addEventListener('submit', function() { saved = true; });

    window.addEventListener('beforeunload', function(e) {
        if (!saved) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
})();
</script>

<style>
.setting-group {
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border);
}

input[type="range"] {
    -webkit-appearance: none;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    outline: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

/* Toggle switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--border);
    border-radius: 26px;
    transition: 0.3s;
}
.toggle-slider:before {
    content: "";
    position: absolute;
    height: 20px; width: 20px;
    left: 3px; bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
}
.toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
}
.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(22px);
}
</style>
{% endblock %}
