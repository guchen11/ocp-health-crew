{% extends "base.html" %}

{% block title %}Settings - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>‚Ä∫</span>
<span>Settings</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a href="#thresholds" class="sidebar-item active">
                <span class="sidebar-icon">üìä</span>
                Alert Thresholds
            </a>
            <a href="#ssh" class="sidebar-item">
                <span class="sidebar-icon">üñ•Ô∏è</span>
                Target Hosts
            </a>
            <a href="#jumphost" class="sidebar-item">
                <span class="sidebar-icon">üîÄ</span>
                Jumphost / Bastion
            </a>
            <a href="#ai" class="sidebar-item">
                <span class="sidebar-icon">ü§ñ</span>
                AI Configuration
            </a>
            <a href="#jira" class="sidebar-item">
                <span class="sidebar-icon">üé´</span>
                Jira Configuration
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Actions</div>
            <a href="#" onclick="resetDefaults(); return false;" class="sidebar-item" style="color:var(--warning);">
                <span class="sidebar-icon">üîÑ</span>
                Reset to Defaults
            </a>
        </div>
    </aside>
    
    <main class="main">
        {% if message %}
        <div style="background:var(--success-light);border:1px solid var(--success);border-radius:8px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
            <span style="font-size:24px;">‚úÖ</span>
            <div>
                <div style="font-weight:600;color:var(--success);font-size:16px;">Settings Saved</div>
                <div style="color:var(--text-secondary);font-size:13px;">{{ message }}</div>
            </div>
        </div>
        {% endif %}
        
        <form action="/settings" method="POST">
            <!-- Alert Thresholds -->
            <div class="card" id="thresholds">
                <div class="card-header">
                    üìä Alert Thresholds
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure the default thresholds used to determine when to flag resources as unhealthy. 
                        These values can be overridden per-run from the Build Configuration page.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üî• CPU Warning Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="range" name="cpu_warning" id="cpu_warning" 
                                    min="50" max="100" value="{{ thresholds.cpu_warning }}"
                                    style="flex:1;" oninput="document.getElementById('cpu_display').textContent=this.value+'%'">
                                <span id="cpu_display" style="width:50px;font-weight:600;font-size:18px;">{{ thresholds.cpu_warning }}%</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Nodes with CPU usage above this percentage will be flagged as high CPU.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üíæ Memory Warning Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="range" name="memory_warning" id="memory_warning" 
                                    min="50" max="100" value="{{ thresholds.memory_warning }}"
                                    style="flex:1;" oninput="document.getElementById('mem_display').textContent=this.value+'%'">
                                <span id="mem_display" style="width:50px;font-weight:600;font-size:18px;">{{ thresholds.memory_warning }}%</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Nodes with memory usage above this percentage will be flagged as high memory.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üíø Disk I/O Latency Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="disk_latency" id="disk_latency" 
                                    min="10" max="1000" value="{{ thresholds.disk_latency }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">ms</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Disk I/O operations taking longer than this will trigger a warning.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üóÑÔ∏è etcd Latency Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="etcd_latency" id="etcd_latency" 
                                    min="10" max="500" value="{{ thresholds.etcd_latency }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">ms</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                etcd latency above this is considered <strong style="color:var(--error);">CRITICAL</strong> - can cause cluster instability.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üì¶ Pod Density Warning
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="pod_density" id="pod_density" 
                                    min="10" max="250" value="{{ thresholds.pod_density }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">pods/node</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Warn when nodes have more than this many pods scheduled.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üîÅ Pod Restart Threshold
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="restart_count" id="restart_count" 
                                    min="1" max="50" value="{{ thresholds.restart_count }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">restarts</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Pods with more restarts than this will be flagged for attention.
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                üñ•Ô∏è virt-handler Memory Warning
                            </label>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <input type="number" name="virt_handler_memory" id="virt_handler_memory" 
                                    min="100" max="2000" value="{{ thresholds.virt_handler_memory }}"
                                    style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;">
                                <span style="font-weight:600;font-size:16px;">Mi</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                virt-handler pods using more than this memory will be flagged (CNV-66551 related).
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Target Hosts -->
            <div class="card" id="ssh">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>üñ•Ô∏è Target Hosts</span>
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-secondary);">
                        {{ saved_hosts|length }} host{{ 's' if saved_hosts|length != 1 else '' }}
                    </span>
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Add the target hosts that have <code>oc</code> access. These will appear in the build dropdown.
                        All connections go through the jumphost.
                    </p>
                    
                    <!-- Existing hosts list -->
                    <div id="hosts-list">
                        {% for h in saved_hosts %}
                        <div class="host-row" data-index="{{ loop.index0 }}" style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;">
                            <span style="font-size:18px;">üñ•Ô∏è</span>
                            <div style="flex:1;display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;">
                                <input type="text" name="host_name[]" value="{{ h.name }}" placeholder="Label"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-weight:600;">
                                <input type="text" name="host_addr[]" value="{{ h.host }}" placeholder="hostname or IP"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                                <input type="text" name="host_user[]" value="{{ h.user or 'root' }}" placeholder="user"
                                    style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <button type="button" onclick="removeHost(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:18px;padding:4px 8px;" title="Remove host">
                                &times;
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Add host button -->
                    <button type="button" onclick="addHost()" style="width:100%;padding:12px;border:2px dashed var(--border);border-radius:8px;background:transparent;color:var(--accent);cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        + Add Target Host
                    </button>
                    
                    <!-- First-time setup: make target host passwordless (hidden by default) -->
                    <div id="ssh_setup_section" style="display:none;margin-top:24px;padding:20px;background:var(--bg-secondary);border-radius:12px;border:1px solid var(--border);">
                        <div style="font-weight:600;margin-bottom:12px;color:var(--text);font-size:15px;">
                            üîë Make Host Passwordless
                        </div>
                        <p style="color:var(--text-secondary);margin-bottom:16px;font-size:13px;">
                            Enter the host address, user and password. This generates an SSH key (if needed) and copies it to the host. The password is <strong>never saved</strong>.
                        </p>
                        
                        <div style="display:grid;grid-template-columns:2fr 1fr 2fr auto;gap:10px;align-items:flex-end;">
                            <div>
                                <label style="display:block;font-weight:500;margin-bottom:6px;color:var(--text);font-size:13px;">Host</label>
                                <input type="text" id="ssh_setup_host_input" placeholder="hostname or IP"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:500;margin-bottom:6px;color:var(--text);font-size:13px;">User</label>
                                <input type="text" id="ssh_setup_user_input" placeholder="root" value="root"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:500;margin-bottom:6px;color:var(--text);font-size:13px;">Password (one-time)</label>
                                <input type="password" id="ssh_password" placeholder="Enter password"
                                    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                            </div>
                            <button type="button" id="setup_ssh_btn" onclick="setupSSH(); return false;" 
                                class="btn btn-primary" style="padding:10px 20px;white-space:nowrap;margin-bottom:0;">
                                üîë Setup Key
                            </button>
                        </div>
                        
                        <div id="ssh_setup_result" style="margin-top:16px;display:none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Jumphost Configuration -->
            <div class="card" id="jumphost">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>üîÄ Jumphost / Bastion</span>
                    <span id="jumphost_status" style="font-size:12px;padding:4px 12px;border-radius:12px;
                        {% if ssh_config.jumphost_host %}background:var(--success-light);color:var(--success);{% else %}background:var(--bg-secondary);color:var(--text-secondary);{% endif %}">
                        {% if ssh_config.jumphost_host %}Configured{% else %}Not configured{% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        If your cluster host is behind a bastion/jumphost, configure it here.
                        The connection will tunnel through: <strong>You &rarr; Jumphost &rarr; Target Host</strong>.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Jumphost Address
                            </label>
                            <input type="text" name="jumphost_host" id="jumphost_host" 
                                value="{{ ssh_config.jumphost_host or '' }}"
                                placeholder="e.g., jumphost.example.com"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Leave empty to connect directly (no jumphost). Env: <code>JUMPHOST_HOST</code>
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Jumphost User
                            </label>
                            <input type="text" name="jumphost_user" id="jumphost_user" 
                                value="{{ ssh_config.jumphost_user or '' }}"
                                placeholder="e.g., fedora"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Env: <code>JUMPHOST_USER</code>
                            </span>
                        </div>
                    </div>
                    
                    <!-- First-time setup section -->
                    <div id="jumphost_setup_section" style="margin-top:24px;padding:20px;background:var(--bg-secondary);border-radius:12px;border:1px solid var(--border);">
                        <div style="font-weight:600;margin-bottom:12px;color:var(--text);font-size:15px;">
                            üîë First-Time Setup: Make Jumphost Passwordless
                        </div>
                        <p style="color:var(--text-secondary);margin-bottom:16px;font-size:13px;">
                            Enter the jumphost password once below. This will generate an SSH key pair (if needed),
                            copy it to the jumphost, and configure passwordless SSH access. The password is <strong>never saved</strong>.
                        </p>
                        
                        <div style="display:flex;gap:12px;align-items:flex-end;">
                            <div style="flex:1;">
                                <label style="display:block;font-weight:500;margin-bottom:6px;color:var(--text);font-size:13px;">
                                    Jumphost Password (one-time use)
                                </label>
                                <input type="password" id="jumphost_password" 
                                    placeholder="Enter password to set up passwordless SSH"
                                    style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            </div>
                            <button type="button" id="setup_jumphost_btn" onclick="setupJumphost()" 
                                class="btn btn-primary" style="padding:12px 24px;white-space:nowrap;">
                                üîë Setup Passwordless SSH
                            </button>
                        </div>
                        
                        <div id="jumphost_setup_result" style="margin-top:16px;display:none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI Configuration -->
            <div class="card" id="ai">
                <div class="card-header">
                    ü§ñ AI Configuration
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure the AI model used for root cause analysis.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Ollama Model
                            </label>
                            <input type="text" name="ollama_model" id="ollama_model" 
                                value="{{ ai_config.model }}"
                                placeholder="e.g., ollama/llama3.2:3b"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Ollama URL
                            </label>
                            <input type="text" name="ollama_url" id="ollama_url" 
                                value="{{ ai_config.url }}"
                                placeholder="e.g., http://localhost:11434"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Jira Configuration -->
            <div class="card" id="jira">
                <div class="card-header">
                    üé´ Jira Configuration
                </div>
                <div class="card-body">
                    <p style="color:var(--text-secondary);margin-bottom:20px;">
                        Configure Jira integration for bug scanning and pattern learning.
                    </p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px;">
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Jira Projects to Scan
                            </label>
                            <input type="text" name="jira_projects" id="jira_projects" 
                                value="{{ jira_config.projects|join(', ') }}"
                                placeholder="e.g., CNV, OCPBUGS, ODF"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Comma-separated list of Jira project keys
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Bug Scan Period (days)
                            </label>
                            <input type="number" name="jira_scan_days" id="jira_scan_days" 
                                value="{{ jira_config.scan_days }}"
                                min="1" max="365"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                How far back to look for bugs when scanning
                            </span>
                        </div>
                        
                        <div class="setting-group">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">
                                Max Bugs to Analyze
                            </label>
                            <input type="number" name="jira_bug_limit" id="jira_bug_limit" 
                                value="{{ jira_config.bug_limit }}"
                                min="10" max="500"
                                style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                            <span style="font-size:12px;color:var(--text-secondary);display:block;margin-top:8px;">
                                Maximum number of bugs to analyze per scan
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Button -->
            <div style="display:flex;gap:12px;margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;padding:16px;font-size:16px;">
                    üíæ Save Settings
                </button>
            </div>
        </form>
    </main>
</div>

<script>
function addHostRow(name, addr, user) {
    var list = document.getElementById('hosts-list');
    var row = document.createElement('div');
    row.className = 'host-row';
    row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-secondary);border:1px solid var(--success);border-radius:8px;margin-bottom:10px;';
    row.innerHTML = '<span style="font-size:18px;">üñ•Ô∏è</span>' +
        '<div style="flex:1;display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;">' +
            '<input type="text" name="host_name[]" value="' + name + '" placeholder="Label" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-weight:600;">' +
            '<input type="text" name="host_addr[]" value="' + addr + '" placeholder="hostname or IP" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">' +
            '<input type="text" name="host_user[]" value="' + user + '" placeholder="user" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">' +
        '</div>' +
        '<button type="button" onclick="removeHost(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:18px;padding:4px 8px;" title="Remove host">&times;</button>';
    list.appendChild(row);
}

function addHost() {
    // Show the passwordless setup section and focus the host field
    var section = document.getElementById('ssh_setup_section');
    section.style.display = 'block';
    document.getElementById('ssh_setup_host_input').focus();
}

function removeHost(btn) {
    btn.closest('.host-row').remove();
}

function setupSSH() {
    var host = document.getElementById('ssh_setup_host_input').value.trim();
    var user = document.getElementById('ssh_setup_user_input').value.trim() || 'root';
    var password = document.getElementById('ssh_password').value;
    var resultDiv = document.getElementById('ssh_setup_result');
    var btn = document.getElementById('setup_ssh_btn');
    
    resultDiv.style.display = 'block';
    
    if (!host) {
        resultDiv.innerHTML = '<div style="color:var(--warning);font-size:13px;">Please enter the host address.</div>';
        return;
    }
    if (!password) {
        resultDiv.innerHTML = '<div style="color:var(--warning);font-size:13px;">Please enter the password.</div>';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Setting up...';
    resultDiv.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">Generating key and copying to ' + user + '@' + host + '...</div>';
    
    fetch('/api/ssh/setup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({host: host, user: user, password: password})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'üîë Setup Key';
        document.getElementById('ssh_password').value = '';
        
        if (data.success) {
            resultDiv.innerHTML = '<div style="background:var(--success-light);border:1px solid var(--success);border-radius:8px;padding:12px 16px;"><div style="font-weight:600;color:var(--success);">‚úÖ Passwordless SSH to ' + user + '@' + host + ' configured!</div><div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Key: <code>' + (data.key_path || '') + '</code></div></div>';
            // Add the host to the list
            addHostRow(host, host, user);
            document.getElementById('ssh_setup_host_input').value = '';
            document.getElementById('ssh_setup_user_input').value = 'root';
        } else {
            resultDiv.innerHTML = '<div style="background:rgba(255,107,107,0.1);border:1px solid var(--error);border-radius:8px;padding:12px 16px;"><div style="font-weight:600;color:var(--error);">‚ùå Setup failed</div><div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">' + data.error + '</div></div>';
        }
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'üîë Setup Key';
        resultDiv.innerHTML = '<div style="color:var(--error);font-size:13px;">Network error: ' + err.message + '</div>';
    });
}

function setupJumphost() {
    const host = document.getElementById('jumphost_host').value.trim();
    const user = document.getElementById('jumphost_user').value.trim();
    const password = document.getElementById('jumphost_password').value;
    const resultDiv = document.getElementById('jumphost_setup_result');
    const btn = document.getElementById('setup_jumphost_btn');
    
    if (!host || !user) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color:var(--warning);font-size:13px;">Please fill in the Jumphost Address and User fields above first, then save settings.</div>';
        return;
    }
    if (!password) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color:var(--warning);font-size:13px;">Please enter the jumphost password.</div>';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Setting up...';
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div style="color:var(--text-secondary);font-size:13px;">Generating SSH key and copying to jumphost... This may take a few seconds.</div>';
    
    fetch('/api/jumphost/setup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({host: host, user: user, password: password})
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'üîë Setup Passwordless SSH';
        document.getElementById('jumphost_password').value = '';
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div style="background:var(--success-light);border:1px solid var(--success);border-radius:8px;padding:12px 16px;">
                    <div style="font-weight:600;color:var(--success);">‚úÖ Passwordless SSH configured!</div>
                    <div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${data.message}</div>
                    <div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Key: <code>${data.key_path || ''}</code></div>
                </div>`;
        } else {
            resultDiv.innerHTML = `
                <div style="background:rgba(255,107,107,0.1);border:1px solid var(--error);border-radius:8px;padding:12px 16px;">
                    <div style="font-weight:600;color:var(--error);">‚ùå Setup failed</div>
                    <div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${data.error}</div>
                </div>`;
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'üîë Setup Passwordless SSH';
        resultDiv.innerHTML = `<div style="color:var(--error);font-size:13px;">Network error: ${err.message}</div>`;
    });
}

function resetDefaults() {
    if (!confirm('Reset all settings to their default values?')) return;
    
    // Reset threshold values
    document.getElementById('cpu_warning').value = 85;
    document.getElementById('cpu_display').textContent = '85%';
    document.getElementById('memory_warning').value = 80;
    document.getElementById('mem_display').textContent = '80%';
    document.getElementById('disk_latency').value = 100;
    document.getElementById('etcd_latency').value = 100;
    document.getElementById('pod_density').value = 50;
    document.getElementById('restart_count').value = 5;
    document.getElementById('virt_handler_memory').value = 500;
    
    // Reset AI config
    document.getElementById('ollama_model').value = 'ollama/llama3.2:3b';
    document.getElementById('ollama_url').value = 'http://localhost:11434';
    
    // Reset Jira config
    document.getElementById('jira_projects').value = 'CNV, OCPBUGS, ODF';
    document.getElementById('jira_scan_days').value = 30;
    document.getElementById('jira_bug_limit').value = 50;
    
    alert('Default values restored. Click "Save Settings" to apply.');
}
</script>

<style>
.setting-group {
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border);
}

input[type="range"] {
    -webkit-appearance: none;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    outline: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}
</style>
{% endblock %}
