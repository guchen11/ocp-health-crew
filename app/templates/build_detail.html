{% extends "base.html" %}

{% block title %}Build #{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %} - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>â€º</span>
<a href="/job/history">Builds</a>
<span>â€º</span>
<span>#{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %}</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Build #{{ build.number }}</div>
            {% if build.name %}
            <div style="padding:8px 12px;font-size:13px;color:var(--text-secondary);background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;">
                ğŸ·ï¸ {{ build.name }}
            </div>
            {% endif %}
            <a href="/job/{{ build.number }}" class="sidebar-item active">
                <span class="sidebar-icon">ğŸ“Š</span>
                Build Summary
            </a>
            <a href="/job/{{ build.number }}/console" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“</span>
                Console Output
            </a>
            {% if build.report_file %}
            <a href="/report/{{ build.report_file }}" class="sidebar-item" target="_blank">
                <span class="sidebar-icon">ğŸ“„</span>
                View Report
            </a>
            {% endif %}
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Actions</div>
            <a href="/job/rebuild/{{ build.number }}" class="sidebar-item">
                <span class="sidebar-icon">ğŸ”„</span>
                Rebuild
            </a>
            <a href="/job/configure" class="sidebar-item">
                <span class="sidebar-icon">â–¶ï¸</span>
                New Build
            </a>
        </div>
    </aside>
    
    <main class="main">
        <div class="card">
            <div class="card-header">
                <span class="status-icon {{ build.status }}"></span>
                Build #{{ build.number }}{% if build.name %} "{{ build.name }}"{% endif %} - {{ build.status_text }}
            </div>
            <div class="card-body">
                {% if build.name %}
                <div style="background:linear-gradient(90deg, var(--accent-light), transparent);padding:12px 16px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:20px;">ğŸ·ï¸</span>
                    <div>
                        <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Run Name</div>
                        <div style="font-weight:600;color:var(--text);">{{ build.name }}</div>
                    </div>
                </div>
                {% endif %}
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:20px;margin-bottom:20px;">
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Task Type</strong>
                        <div style="margin-top:4px;">
                            {% if build.options.task_type == 'cnv_scenarios' %}
                            <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV Scenarios</span>
                            {% else %}
                            <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:linear-gradient(135deg,var(--accent),#1565c0);color:white;">ğŸ©º Health Check</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Triggered By</strong>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:2px;">
                            <span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--accent);color:white;font-size:11px;font-weight:700;">{{ (build.triggered_by or 'S')[0]|upper }}</span>
                            {{ build.triggered_by or 'system' }}
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Started</strong>
                        <div>{{ build.timestamp }}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Duration</strong>
                        <div>{{ build.duration }}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Server</strong>
                        <div style="font-family:monospace;font-size:12px;">{{ build.options.server_host or 'Default (env)' }}</div>
                    </div>
                    {% if build.options.task_type == 'cnv_scenarios' %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Mode</strong>
                        <div>{{ build.options.scenario_mode or 'sanity' }}{% if build.options.scenario_parallel %} (parallel){% endif %}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Scenarios</strong>
                        <div>{{ build.checks_count }} tests</div>
                    </div>
                    {% else %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Checks Run</strong>
                        <div>{{ build.checks_count }} checks</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Options</strong>
                        <div>
                            {% if build.options.rca_level == 'full' %}ğŸ” Full RCA {% elif build.options.rca_level == 'bugs' %}ğŸ› Bug Match {% else %}ğŸ“‹ Checks {% endif %}
                            {% if build.options.rca_jira %}ğŸ« Jira {% endif %}
                            {% if build.options.rca_email %}ğŸ“§ Email {% endif %}
                            {% if build.options.rca_web %}ğŸŒ Web {% endif %}
                            {% if build.options.jira %}ğŸ” Suggest {% endif %}
                            {% if build.options.email %}ğŸ“¤ {{ build.options.email_to or 'Send' }} {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if build.options.task_type == 'cnv_scenarios' %}
                <h4 style="margin-bottom:15px;">Scenarios Executed:</h4>
                <div class="checkbox-grid">
                    {% for test in build.checks %}
                    <div class="checkbox-item" style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 14px;">
                        <span>ğŸ”¥</span>
                        <span style="font-weight:600;">{{ test }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% elif build.checks %}
                <h4 style="margin-bottom:15px;">Checks Executed:</h4>
                <div class="checkbox-grid">
                    {% for check in build.checks %}
                    <div class="checkbox-item" style="background:{% if check in checks %}#e8f5e9{% else %}#f5f5f5{% endif %};">
                        <span>{% if check in checks %}âœ…{% else %}â¬œ{% endif %}</span>
                        <span>{{ checks.get(check, {}).get('name', check) }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if build.report_file %}
        <div class="card">
            <div class="card-header">ğŸ“„ Report Preview</div>
            <div class="card-body" style="padding:0;">
                <div class="report-preview">
                    <iframe src="/report/{{ build.report_file }}"></iframe>
                </div>
            </div>
        </div>
        {% endif %}
    </main>
</div>
{% endblock %}
