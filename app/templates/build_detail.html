{% extends "base.html" %}

{% block title %}Build #{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %} - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>â€º</span>
<a href="/job/history">Builds</a>
<span>â€º</span>
<span>#{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %}</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Build #{{ build.number }}</div>
            {% if build.name %}
            <div style="padding:8px 12px;font-size:13px;color:var(--text-secondary);background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;">
                ğŸ·ï¸ {{ build.name }}
            </div>
            {% endif %}
            <a href="/job/{{ build.number }}" class="sidebar-item active">
                <span class="sidebar-icon">ğŸ“Š</span>
                Build Summary
            </a>
            <a href="/job/{{ build.number }}/console" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“</span>
                Console Output
            </a>
            {% if build.report_file %}
            <a href="/report/{{ build.report_file }}" class="sidebar-item" target="_blank">
                <span class="sidebar-icon">ğŸ“„</span>
                View Report
            </a>
            {% endif %}
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Actions</div>
            <a href="/job/rebuild/{{ build.number }}" class="sidebar-item">
                <span class="sidebar-icon">ğŸ”„</span>
                Rebuild
            </a>
            <a href="/job/configure" class="sidebar-item">
                <span class="sidebar-icon">â–¶ï¸</span>
                New Build
            </a>
            <a href="#" onclick="event.preventDefault();openBuildTemplateModal();" class="sidebar-item">
                <span class="sidebar-icon">ğŸ’¾</span>
                Save as Template
            </a>
        </div>
    </aside>
    
    <main class="main">
        <div class="card">
            <div class="card-header">
                <span class="status-icon {{ build.status }}"></span>
                Build #{{ build.number }}{% if build.name %} "{{ build.name }}"{% endif %} - {{ build.status_text }}
            </div>
            <div class="card-body">
                {% if build.name %}
                <div style="background:linear-gradient(90deg, var(--accent-light), transparent);padding:12px 16px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:20px;">ğŸ·ï¸</span>
                    <div>
                        <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Run Name</div>
                        <div style="font-weight:600;color:var(--text);">{{ build.name }}</div>
                    </div>
                </div>
                {% endif %}
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:20px;margin-bottom:20px;">
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Task Type</strong>
                        <div style="margin-top:4px;">
                            {% if build.options.task_type == 'cnv_combined' %}
                            <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;">ğŸ§¬ CNV Combined</span>
                            {% elif build.options.task_type == 'cnv_scenarios' %}
                            <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV Scenarios</span>
                            {% else %}
                            <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;background:linear-gradient(135deg,var(--accent),#1565c0);color:white;">ğŸ©º Health Check</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Triggered By</strong>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:2px;">
                            <span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--accent);color:white;font-size:11px;font-weight:700;">{{ (build.triggered_by or 'S')[0]|upper }}</span>
                            {{ build.triggered_by or 'system' }}
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Started</strong>
                        <div>{{ build.timestamp }}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Duration</strong>
                        <div id="build-duration">{{ build.duration }}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Server</strong>
                        <div style="font-family:monospace;font-size:12px;">{{ build.options.server_host or 'Default (env)' }}</div>
                    </div>
                    {% if build.options.task_type in ['cnv_scenarios', 'cnv_combined'] %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Mode</strong>
                        <div>{{ build.options.scenario_mode or 'sanity' }}{% if build.options.scenario_parallel %} (parallel){% endif %}</div>
                    </div>
                    {% if build.options.task_type == 'cnv_combined' %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Pipeline</strong>
                        <div>Scenarios + Health Check{% if build.options.combined_cleanup %} + Cleanup{% endif %}</div>
                    </div>
                    {% endif %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Scenarios</strong>
                        <div>{{ build.checks_count }} tests</div>
                    </div>
                    {% else %}
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Checks Run</strong>
                        <div>{{ build.checks_count }} checks</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted);font-size:11px;text-transform:uppercase;">Options</strong>
                        <div>
                            {% if build.options.rca_level == 'full' %}ğŸ” Full RCA {% elif build.options.rca_level == 'bugs' %}ğŸ› Bug Match {% else %}ğŸ“‹ Checks {% endif %}
                            {% if build.options.rca_jira %}ğŸ« Jira {% endif %}
                            {% if build.options.rca_email %}ğŸ“§ Email {% endif %}
                            {% if build.options.rca_web %}ğŸŒ Web {% endif %}
                            {% if build.options.jira %}ğŸ” Suggest {% endif %}
                            {% if build.options.email %}ğŸ“¤ {{ build.options.email_to or 'Send' }} {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if build.options.task_type in ['cnv_scenarios', 'cnv_combined'] %}
                <h4 style="margin-bottom:15px;">Scenarios{% if build.status == 'running' %} Progress{% else %} Executed{% endif %}:</h4>
                <div id="test-progress-grid" class="checkbox-grid">
                    {% for test in build.checks %}
                    {% set meta = cnv_meta.get(test, {}) %}
                    <div class="test-progress-card" data-test="{{ test }}"
                         style="background:#1a1d23;border:1px solid #2c3235;border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:10px;transition:border-color 0.3s;">
                        <span style="font-size:18px;">{{ meta.get('icon', 'ğŸ”¥') }}</span>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;font-size:13px;color:#e6edf3;">{{ meta.get('name', test) }}</div>
                            <div style="font-size:11px;color:#8b949e;margin-top:2px;">{{ test }}{% if meta.get('category') %} Â· {{ meta.get('category') }}{% endif %}</div>
                        </div>
                        <div class="test-status-badge" data-test-status="{{ test }}"
                             style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;white-space:nowrap;">
                            {% if build.status == 'running' %}
                            <span style="color:#8b949e;">â³ Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif build.checks %}
                <h4 style="margin-bottom:15px;">Checks Executed:</h4>
                <div class="checkbox-grid">
                    {% for check in build.checks %}
                    <div class="checkbox-item" style="background:{% if check in checks %}#e8f5e9{% else %}#f5f5f5{% endif %};">
                        <span>{% if check in checks %}âœ…{% else %}â¬œ{% endif %}</span>
                        <span>{{ checks.get(check, {}).get('name', check) }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if build.custom_check_results is defined and build.custom_check_results %}
        <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span>ğŸ§ª Custom Health Checks</span>
                {% set cc_passed = build.custom_check_results|selectattr('passed')|list|length %}
                {% set cc_total = build.custom_check_results|length %}
                <span style="font-size:12px;padding:4px 12px;border-radius:12px;
                    {% if cc_passed == cc_total %}background:#23863620;color:#238636;{% else %}background:#da363320;color:#da3633;{% endif %}">
                    {{ cc_passed }}/{{ cc_total }} passed
                </span>
            </div>
            <div class="card-body" style="padding:0;">
                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                        <tr style="background:var(--bg-secondary);border-bottom:1px solid var(--border);">
                            <th style="padding:10px 16px;text-align:left;font-weight:600;width:30px;">Status</th>
                            <th style="padding:10px 8px;text-align:left;font-weight:600;">Name</th>
                            <th style="padding:10px 8px;text-align:left;font-weight:600;font-family:monospace;">Command / Script</th>
                            <th style="padding:10px 8px;text-align:left;font-weight:600;">Expected</th>
                            <th style="padding:10px 8px;text-align:left;font-weight:600;">Actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cc in build.custom_check_results %}
                        <tr style="border-bottom:1px solid var(--border);{% if not cc.passed %}background:#da363308;{% endif %}">
                            <td style="padding:10px 16px;text-align:center;">
                                {% if cc.passed %}
                                <span style="color:#238636;font-size:16px;">âœ“</span>
                                {% else %}
                                <span style="color:#da3633;font-size:16px;">âœ—</span>
                                {% endif %}
                            </td>
                            <td style="padding:10px 8px;font-weight:600;">
                                {% if cc.check_type == 'script' %}ğŸ“œ{% else %}ğŸ§ª{% endif %} {{ cc.name }}
                            </td>
                            <td style="padding:10px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ cc.command }}</td>
                            <td style="padding:10px 8px;font-size:12px;color:var(--text-secondary);">
                                {{ cc.expected or '(any)' }}
                                <span style="font-size:10px;color:var(--text-muted);">({{ cc.match_type }})</span>
                            </td>
                            <td style="padding:10px 8px;font-family:monospace;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                                title="{{ cc.actual }}">
                                {{ cc.actual[:100] if cc.actual else cc.error or '' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if build.report_file %}
        <div class="card">
            <div class="card-header">ğŸ“„ Report Preview</div>
            <div class="card-body" style="padding:0;">
                <div class="report-preview">
                    <iframe src="/report/{{ build.report_file }}"></iframe>
                </div>
            </div>
        </div>
        {% endif %}
    </main>
</div>

{% if build.status == 'running' and build.options.task_type in ['cnv_scenarios', 'cnv_combined'] %}
<script>
(function() {
    var buildNum = {{ build.number }};
    var pollInterval = 3000;
    var timer = null;

    function statusHtml(status, elapsed, duration, exitCode) {
        if (status === 'running') {
            return '<span style="color:#58a6ff;"><span class="status-icon running" style="display:inline-block;width:8px;height:8px;margin-right:4px;"></span> Running' + (elapsed ? ' (' + elapsed + ')' : '') + '</span>';
        } else if (status === 'passed') {
            return '<span style="background:#238636;color:#fff;padding:2px 8px;border-radius:10px;">âœ“ Passed</span>' + (duration ? ' <span style="color:#8b949e;font-size:10px;">' + duration + '</span>' : '');
        } else if (status === 'failed') {
            return '<span style="background:#da3633;color:#fff;padding:2px 8px;border-radius:10px;">âœ— Failed</span>' + (duration ? ' <span style="color:#8b949e;font-size:10px;">' + duration + '</span>' : '');
        } else if (status === 'queued') {
            return '<span style="color:#8b949e;">ğŸ“‹ Queued</span>';
        }
        return '<span style="color:#8b949e;">â³ Pending</span>';
    }

    function borderColor(status) {
        if (status === 'running') return '#58a6ff';
        if (status === 'passed') return '#238636';
        if (status === 'failed') return '#da3633';
        if (status === 'queued') return '#6e7681';
        return '#2c3235';
    }

    function poll() {
        fetch('/api/test-progress/' + buildNum)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.running) {
                    clearInterval(timer);
                    setTimeout(function() { location.reload(); }, 1500);
                    return;
                }
                var tp = data.test_progress || {};
                document.querySelectorAll('.test-progress-card').forEach(function(card) {
                    var tname = card.getAttribute('data-test');
                    var badge = card.querySelector('.test-status-badge');
                    var info = tp[tname];
                    if (info) {
                        badge.innerHTML = statusHtml(info.status, info.elapsed, info.duration, info.exit_code);
                        card.style.borderColor = borderColor(info.status);
                    }
                });
            })
            .catch(function() {});
    }

    timer = setInterval(poll, pollInterval);
    poll();
})();
</script>
{% endif %}

{% if build.status == 'running' %}
<script>
(function() {
    var startTime = new Date('{{ build.started_at_iso }}');
    var durationEl = document.getElementById('build-duration');
    if (!durationEl || isNaN(startTime.getTime())) return;

    function formatElapsed(ms) {
        var totalSec = Math.floor(ms / 1000);
        var h = Math.floor(totalSec / 3600);
        var m = Math.floor((totalSec % 3600) / 60);
        var s = totalSec % 60;
        if (h > 0) return h + 'h ' + m + 'm ' + s + 's';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
    }

    function tick() {
        var elapsed = Date.now() - startTime.getTime();
        if (elapsed < 0) elapsed = 0;
        durationEl.textContent = formatElapsed(elapsed);
    }

    tick();
    setInterval(tick, 1000);
})();
</script>
{% endif %}

<!-- Save as Template Modal -->
<div id="buildTemplateModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;" onclick="if(event.target===this)closeBuildTemplateModal()">
    <div style="background:var(--bg);border-radius:12px;padding:24px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
            <h3 style="margin:0;font-size:18px;color:var(--text);">ğŸ’¾ Save Build Config as Template</h3>
            <span onclick="closeBuildTemplateModal()" style="cursor:pointer;font-size:20px;color:var(--text-muted);">&times;</span>
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;">Template Name *</label>
            <input type="text" id="build-tmpl-name" placeholder="e.g. Scale test 10K" value="From Build #{{ build.number }}" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;">Description</label>
            <input type="text" id="build-tmpl-desc" placeholder="Short description" value="Saved from build #{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %}" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;">Icon</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <span class="build-tmpl-icon" data-icon="ğŸ“‹" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid var(--accent);border-radius:8px;">ğŸ“‹</span>
                <span class="build-tmpl-icon" data-icon="ğŸš€" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">ğŸš€</span>
                <span class="build-tmpl-icon" data-icon="ğŸ”¥" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">ğŸ”¥</span>
                <span class="build-tmpl-icon" data-icon="ğŸ‹ï¸" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">ğŸ‹ï¸</span>
                <span class="build-tmpl-icon" data-icon="âš¡" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">âš¡</span>
                <span class="build-tmpl-icon" data-icon="ğŸ§ª" onclick="pickBuildTmplIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">ğŸ§ª</span>
            </div>
        </div>
        <div style="margin-bottom:20px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" id="build-tmpl-shared">
                <span style="font-size:13px;">Share with team</span>
            </label>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="closeBuildTemplateModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBuildTemplate()" id="build-tmpl-save-btn" style="padding:10px 24px;">ğŸ’¾ Save</button>
        </div>
    </div>
</div>

<script>
var _buildTmplIcon = 'ğŸ“‹';

function pickBuildTmplIcon(el) {
    document.querySelectorAll('.build-tmpl-icon').forEach(function(e) { e.style.borderColor = 'transparent'; });
    el.style.borderColor = 'var(--accent)';
    _buildTmplIcon = el.getAttribute('data-icon');
}

function openBuildTemplateModal() {
    document.getElementById('buildTemplateModal').style.display = 'flex';
    document.getElementById('build-tmpl-name').focus();
}

function closeBuildTemplateModal() {
    document.getElementById('buildTemplateModal').style.display = 'none';
}

function saveBuildTemplate() {
    var name = document.getElementById('build-tmpl-name').value.trim();
    if (!name) { alert('Please enter a name'); return; }
    var btn = document.getElementById('build-tmpl-save-btn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    fetch('/api/templates/from-build/{{ build.number }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            description: document.getElementById('build-tmpl-desc').value.trim(),
            icon: _buildTmplIcon,
            shared: document.getElementById('build-tmpl-shared').checked
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { alert('Error: ' + data.error); }
        else {
            closeBuildTemplateModal();
            alert('Template "' + data.name + '" saved! You can find it in the Configure page sidebar.');
        }
    })
    .catch(function(err) { alert('Failed: ' + err); })
    .finally(function() {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Save';
    });
}
</script>
{% endblock %}
