{% extends "base.html" %}

{% block title %}{% if preset == 'all' %}Quick Run{% elif preset == 'cnv_full' %}Full CNV Regression Test{% elif preset == '10k_density' %}Create 10K VMs{% else %}Run with Parameters{% endif %} - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>‚Ä∫</span>
<a href="/job/configure">Run with Parameters</a>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Run Options</div>
            <a href="/job/configure" class="sidebar-item active">
                <span class="sidebar-icon">‚öôÔ∏è</span>
                Configure Run
            </a>
            <a href="/job/quick-run" class="sidebar-item">
                <span class="sidebar-icon">‚ö°</span>
                Quick Run
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">Presets</div>
            <a href="#" onclick="selectAll()" class="sidebar-item">
                <span class="sidebar-icon">‚úÖ</span>
                Select All Checks
            </a>
            <a href="#" onclick="selectNone()" class="sidebar-item">
                <span class="sidebar-icon">‚¨ú</span>
                Deselect All
            </a>
            <a href="#" onclick="selectInfra()" class="sidebar-item">
                <span class="sidebar-icon">üèóÔ∏è</span>
                Infrastructure Only
            </a>
            <a href="#" onclick="selectVirt()" class="sidebar-item">
                <span class="sidebar-icon">üíª</span>
                Virtualization Only
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                My Templates
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">‚ñº</span>
            </div>
            <div class="sidebar-content">
                {% if user_templates %}
                {% for t in user_templates %}
                <a href="/job/configure?template={{ t.id }}" class="sidebar-item" style="display:flex;align-items:center;gap:6px;" title="{{ t.description }}">
                    <span class="sidebar-icon">{{ t.icon }}</span>
                    <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ t.name }}</span>
                    {% if t.created_by_id == current_user.id %}
                    <span onclick="event.preventDefault();event.stopPropagation();deleteTemplate({{ t.id }}, '{{ t.name|e }}');" style="opacity:0.4;cursor:pointer;font-size:11px;" title="Delete">&times;</span>
                    {% endif %}
                </a>
                {% endfor %}
                {% else %}
                <div style="padding:8px 12px;font-size:12px;color:var(--text-muted);">No saved templates yet</div>
                {% endif %}
            </div>
        </div>
    </aside>
    
    <main class="main">
        {% if preset == 'all' %}
        <div style="background:var(--success-light);border:1px solid var(--success);border-radius:8px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
            <span style="font-size:24px;">‚ö°</span>
            <div>
                <div style="font-weight:600;color:var(--success);font-size:16px;">Quick Run Mode</div>
                <div style="color:var(--text-secondary);font-size:13px;">All checks are pre-selected. Review and click "Run Now" to start.</div>
            </div>
        </div>
        {% elif preset == 'cnv_full' %}
        <div style="background:var(--bg-secondary);border:1px solid var(--accent);border-radius:12px;margin-bottom:20px;overflow:hidden;">
            <div style="background:linear-gradient(135deg, var(--accent), #1565c0);padding:16px 24px;display:flex;align-items:center;gap:12px;">
                <span style="font-size:26px;">üèãÔ∏è</span>
                <div>
                    <div style="font-weight:700;color:#fff;font-size:17px;">Full CNV Regression Test</div>
                    <div style="color:rgba(255,255,255,0.8);font-size:12px;">Reference column is read-only. Edit <strong>Test Value</strong> to customize your run.</div>
                </div>
            </div>
            <div style="padding:0;overflow-x:auto;">
                <style>
                    #fcnv-tbl { width:100%; border-collapse:separate; border-spacing:0; font-size:13px; table-layout:fixed; }
                    #fcnv-tbl th { padding:12px 12px; text-align:center; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; background:#f8f9fa; border-bottom:2px solid #dee2e6; color:#37474f; }
                    #fcnv-tbl td { padding:11px 12px; border-bottom:1px solid #eee; vertical-align:middle; }
                    #fcnv-tbl tbody tr { transition:all 0.2s ease; }
                    #fcnv-tbl tbody tr.data-row:hover { background:#f0f7ff !important; }
                    #fcnv-tbl .obj { text-align:left; font-size:13px; color:#333; padding-left:20px; font-weight:500; word-wrap:break-word; overflow-wrap:break-word; }
                    #fcnv-tbl .badge { font-size:11px; padding:4px 10px; border-radius:6px; font-weight:600; white-space:nowrap; display:inline-block; letter-spacing:0.2px; }
                    #fcnv-tbl .param { text-align:center; }
                    #fcnv-tbl .param code { font-family:'SF Mono',Monaco,Consolas,'Courier New',monospace; font-size:11px; background:#f1f3f5; padding:3px 8px; border-radius:4px; color:#37474f; border:1px solid #e9ecef; }
                    #fcnv-tbl .ref { text-align:center; font-weight:600; font-size:13px; }
                    #fcnv-tbl .ref-theo { color:#78909c; }
                    #fcnv-tbl .ref-4x { color:#7c3aed; }
                    #fcnv-tbl .ref-420 { color:#ea580c; }
                    #fcnv-tbl .ref-421 { color:#1976d2; font-weight:700; }
                    #fcnv-tbl .grp td { padding:8px 20px; background:linear-gradient(135deg,#f8f9fa,#f1f3f5); border-bottom:1px solid #dee2e6; border-top:1px solid #dee2e6; font-size:12px; font-weight:700; color:#37474f; text-transform:uppercase; letter-spacing:1px; }
                    #fcnv-tbl .tv-cell { padding:6px 8px !important; }
                    #fcnv-tbl .tv-input { width:100%; padding:7px 8px; border:2px solid #22c55e; border-radius:8px; font-size:13px; font-weight:700; background:#fff; text-align:center; color:#1a1a1a; outline:none; transition:all 0.2s ease; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
                    #fcnv-tbl .tv-input:focus { border-color:#16a34a; box-shadow:0 0 0 3px rgba(34,197,94,0.2),0 1px 2px rgba(0,0,0,0.04); }
                    #fcnv-tbl .tv-input:hover { border-color:#16a34a; }
                </style>
                <table id="fcnv-tbl">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding-left:20px;width:22%;">Objective</th>
                            <th style="width:13%;">Test</th>
                            <th style="width:11%;">Parameter</th>
                            <th style="color:#546e7a;width:10%;">Theoretical</th>
                            <th style="color:#7c3aed;width:10%;">4.x Max</th>
                            <th style="color:#ea580c;width:10%;">4.20.0</th>
                            <th style="color:#1976d2;width:10%;">4.21.0</th>
                            <th style="color:#16a34a;width:14%;">Test Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ‚îÄ‚îÄ Category: Resource Limits ‚îÄ‚îÄ -->
                        <tr class="grp"><td colspan="8">üìè Resource Limits</td></tr>
                        <tr class="data-row">
                            <td class="obj">Maximum virtual CPUs per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#fff7ed;color:#c2410c;border:1px solid #fed7aa;">üî• CPU Limits</span></td>
                            <td class="param"><code>cpuCores</code></td>
                            <td class="ref ref-theo">255</td>
                            <td class="ref ref-4x">216</td>
                            <td class="ref ref-420">512</td>
                            <td class="ref ref-421">512</td>
                            <td class="tv-cell"><input type="number" class="full-cnv-input tv-input" data-target-scenario="cpu_limits" data-target-var="cpuCores" value="512" min="1" max="1024"></td>
                        </tr>
                        <tr class="data-row" style="background:#fafafa;">
                            <td class="obj">Maximum memory per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;">üíæ Memory Limits</span></td>
                            <td class="param"><code>memorySize</code></td>
                            <td class="ref ref-theo">16 TiB</td>
                            <td class="ref ref-4x">6 TiB</td>
                            <td class="ref ref-420">450 GiB</td>
                            <td class="ref ref-421">350 GiB</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="memory_limits" data-target-var="memorySize" value="350Gi"></td>
                        </tr>

                        <!-- ‚îÄ‚îÄ Category: Performance ‚îÄ‚îÄ -->
                        <tr class="grp"><td colspan="8">‚ö° Performance</td></tr>
                        <tr class="data-row">
                            <td class="obj">Maximum memory (high memory)</td>
                            <td style="text-align:center;"><span class="badge" style="background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;">üìà High Memory</span></td>
                            <td class="param"><code>highMemory</code></td>
                            <td class="ref ref-theo">16 TiB</td>
                            <td class="ref ref-4x">6 TiB</td>
                            <td class="ref ref-420">450 GiB</td>
                            <td class="ref ref-421">350 GiB</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="high_memory" data-target-var="highMemory" value="350Gi"></td>
                        </tr>
                        <tr class="data-row" style="background:#fafafa;">
                            <td class="obj">Maximum single disk size per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#f0fdfa;color:#115e59;border:1px solid #99f6e4;">üóÑÔ∏è Large Disk</span></td>
                            <td class="param"><code>largeDiskSize</code></td>
                            <td class="ref ref-theo">100 TB</td>
                            <td class="ref ref-4x">20 TB</td>
                            <td class="ref ref-420">100 TB</td>
                            <td class="ref ref-421">100 TB</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="large_disk" data-target-var="largeDiskSize" value="100Ti"></td>
                        </tr>
                        <tr class="data-row">
                            <td class="obj">Minimum CPU per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#faf5ff;color:#7e22ce;border:1px solid #e9d5ff;">ü™∂ Minimal Resources</span></td>
                            <td class="param"><code>minCpu</code></td>
                            <td class="ref ref-theo">‚Äî</td>
                            <td class="ref ref-4x">New</td>
                            <td class="ref ref-420">100m</td>
                            <td class="ref ref-421">256m</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="minimal_resources" data-target-var="minCpu" value="256m"></td>
                        </tr>
                        <tr class="data-row" style="background:#fafafa;">
                            <td class="obj">Minimum memory per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#faf5ff;color:#7e22ce;border:1px solid #e9d5ff;">ü™∂ Minimal Resources</span></td>
                            <td class="param"><code>minMemory</code></td>
                            <td class="ref ref-theo">‚Äî</td>
                            <td class="ref ref-4x">512 MB</td>
                            <td class="ref ref-420">64M</td>
                            <td class="ref ref-421">256m</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="minimal_resources" data-target-var="minMemory" value="256Mi"></td>
                        </tr>
                        <tr class="data-row">
                            <td class="obj">Minimum disk per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#faf5ff;color:#7e22ce;border:1px solid #e9d5ff;">ü™∂ Minimal Resources</span></td>
                            <td class="param"><code>minStorage</code></td>
                            <td class="ref ref-theo">‚Äî</td>
                            <td class="ref ref-4x">New</td>
                            <td class="ref ref-420">100m</td>
                            <td class="ref ref-421">256m</td>
                            <td class="tv-cell"><input type="text" class="full-cnv-input tv-input" data-target-scenario="minimal_resources" data-target-var="minStorage" value="256Mi"></td>
                        </tr>

                        <!-- ‚îÄ‚îÄ Category: Hot-plug ‚îÄ‚îÄ -->
                        <tr class="grp"><td colspan="8">üîå Hot-plug</td></tr>
                        <tr class="data-row">
                            <td class="obj">Maximum hot-pluggable disks per VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#fff1f2;color:#be123c;border:1px solid #fecdd3;">üîå Disk Hot-plug</span></td>
                            <td class="param"><code>diskCount</code></td>
                            <td class="ref ref-theo">‚Äî</td>
                            <td class="ref ref-4x">255</td>
                            <td class="ref ref-420">255</td>
                            <td class="ref ref-421">255</td>
                            <td class="tv-cell"><input type="number" class="full-cnv-input tv-input" data-target-scenario="disk_hotplug" data-target-var="diskCount" value="255" min="1" max="256"></td>
                        </tr>
                        <tr class="data-row" style="background:#fafafa;">
                            <td class="obj">Add vNICs to a VM</td>
                            <td style="text-align:center;"><span class="badge" style="background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;">üåê NIC Hot-plug</span></td>
                            <td class="param"><code>nicCount</code></td>
                            <td class="ref ref-theo">‚Äî</td>
                            <td class="ref ref-4x">‚Äî</td>
                            <td class="ref ref-420">‚Äî</td>
                            <td class="ref ref-421">28</td>
                            <td class="tv-cell"><input type="number" class="full-cnv-input tv-input" data-target-scenario="nic_hotplug" data-target-var="nicCount" value="28" min="1" max="28"></td>
                        </tr>

                        <!-- ‚îÄ‚îÄ Category: Scale ‚îÄ‚îÄ -->
                        <tr class="grp"><td colspan="8">üìä Scale</td></tr>
                        <tr class="data-row">
                            <td class="obj">Maximum number of defined VMs</td>
                            <td style="text-align:center;"><span class="badge" style="background:#fefce8;color:#a16207;border:1px solid #fde68a;">üìä Per-Host Density</span></td>
                            <td class="param"><code>vmsPerNamespace</code></td>
                            <td class="ref ref-theo">10000</td>
                            <td class="ref ref-4x">10000</td>
                            <td class="ref ref-420">5000</td>
                            <td class="ref ref-421">10000</td>
                            <td class="tv-cell"><input type="number" class="full-cnv-input tv-input" data-target-scenario="per_host_density" data-target-var="vmsPerNamespace" data-extra-scenario="per_host_density" data-extra-var="namespaceCount" data-extra-value="20" value="500" min="1" max="10000" title="VMs per namespace (x20 namespaces = 10,000 total)"></td>
                        </tr>
                        <tr class="data-row" style="background:#fafafa;">
                            <td class="obj">Maximum VMs per host</td>
                            <td style="text-align:center;"><span class="badge" style="background:#fefce8;color:#a16207;border:1px solid #fde68a;">üìä Per-Host Density</span></td>
                            <td class="param"><code>namespaceCount</code></td>
                            <td class="ref ref-theo">1K</td>
                            <td class="ref ref-4x">460</td>
                            <td class="ref ref-420">460</td>
                            <td class="ref ref-421">460</td>
                            <td class="tv-cell"><input type="number" class="full-cnv-input tv-input" data-target-scenario="per_host_density" data-target-var="namespaceCount" value="20" min="1" max="100" title="Namespace count"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Global Variable Overrides -->
            <div style="border-top:2px solid var(--border);padding:16px 24px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                    <span style="font-size:16px;">üîß</span>
                    <span style="font-weight:700;font-size:14px;color:var(--text);">Global Variable Overrides</span>
                    <span style="font-size:12px;color:#546e7a;margin-left:4px;">Apply to all scenarios</span>
                </div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
                    <div>
                        <label style="display:block;font-size:12px;color:#455a64;margin-bottom:4px;">
                            üíø <strong>Storage Class</strong>
                        </label>
                        <input type="text" class="full-cnv-global-input" data-global-var="storageClassName"
                            value="" placeholder="ocs-storagecluster-ceph-rbd-virtualization"
                            style="width:100%;padding:7px 10px;border:2px solid var(--success);border-radius:8px;font-size:12px;font-weight:600;background:var(--bg);color:var(--text);">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#455a64;margin-bottom:4px;">
                            üéØ <strong>Node Selector</strong>
                        </label>
                        <input type="text" class="full-cnv-global-input" data-global-var="nodeSelector"
                            value="" placeholder="e.g. node-role.kubernetes.io/worker="
                            style="width:100%;padding:7px 10px;border:2px solid var(--success);border-radius:8px;font-size:12px;font-weight:600;background:var(--bg);color:var(--text);">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#455a64;margin-bottom:4px;">
                            ‚è±Ô∏è <strong>Max Wait Timeout</strong>
                        </label>
                        <input type="text" class="full-cnv-global-input" data-global-var="maxWaitTimeout"
                            value="30m" placeholder="Full default: 30m"
                            style="width:100%;padding:7px 10px;border:2px solid var(--success);border-radius:8px;font-size:12px;font-weight:600;background:var(--bg);color:var(--text);">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#455a64;margin-bottom:4px;">
                            ‚è∏Ô∏è <strong>Job Pause</strong>
                        </label>
                        <input type="text" class="full-cnv-global-input" data-global-var="jobPause"
                            value="2m" placeholder="Full default: 2m"
                            style="width:100%;padding:7px 10px;border:2px solid var(--success);border-radius:8px;font-size:12px;font-weight:600;background:var(--bg);color:var(--text);">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#455a64;margin-bottom:4px;">
                            üßπ <strong>Cleanup After Test</strong>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 10px;border:2px solid var(--success);border-radius:8px;background:var(--bg);">
                            <input type="checkbox" class="full-cnv-global-input" data-global-var="cleanup" data-is-bool="true" checked
                                style="width:18px;height:18px;accent-color:var(--success);cursor:pointer;">
                            <span style="font-size:12px;font-weight:600;color:var(--text);">Enabled</span>
                        </label>
                    </div>
                </div>
            </div>
            <!-- Test-Specific Parameters (collapsible) -->
            <div style="border-top:2px solid var(--border);padding:16px 24px;">
                <div onclick="var b=this.nextElementSibling;var ic=this.querySelector('.tsp-icon');if(b.style.display==='none'){b.style.display='block';ic.textContent='‚ñº';}else{b.style.display='none';ic.textContent='‚ñ∂';}" style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;">
                    <span style="font-size:16px;">üéõÔ∏è</span>
                    <span style="font-weight:700;font-size:14px;color:var(--text);">Test-Specific Parameters</span>
                    <span style="font-size:12px;color:#546e7a;margin-left:4px;">Fine-tune each scenario</span>
                    <span class="tsp-icon" style="margin-left:auto;font-size:12px;color:#455a64;font-weight:700;">‚ñ∂</span>
                </div>
                <div style="display:none;">
                <p style="font-size:12px;color:#546e7a;margin:10px 0 14px 0;">Changes here sync to the form below automatically.</p>

                {% for sid, sc in cnv_scenarios.items() %}
                {% if sc.variables %}
                <div style="margin-bottom:14px;padding:12px 14px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);">
                    <div style="font-weight:600;font-size:13px;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                        {{ sc.icon }} {{ sc.name }}
                        <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:var(--success-light);color:var(--success);margin-left:auto;">SELECTED</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                        {% for var_name, var_info in sc.variables.items() %}
                        <div>
                            <label style="display:block;font-size:12px;color:#455a64;margin-bottom:3px;">
                                <strong>{{ var_info.label }}</strong>
                            </label>
                            {% if var_info.type == 'bool' %}
                            <select class="full-cnv-scenario-input" data-sync-scenario="{{ sid }}" data-sync-var="{{ var_name }}" data-sync-type="select"
                                style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg);">
                                <option value="">Default ({{ 'true' if var_info.default else 'false' }})</option>
                                <option value="true">true</option>
                                <option value="false">false</option>
                            </select>
                            {% elif var_info.type == 'choice' %}
                            <select class="full-cnv-scenario-input" data-sync-scenario="{{ sid }}" data-sync-var="{{ var_name }}" data-sync-type="select"
                                style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg);">
                                <option value="">Default ({{ var_info.default }})</option>
                                {% for choice in var_info.choices %}
                                <option value="{{ choice }}">{{ choice }}</option>
                                {% endfor %}
                            </select>
                            {% elif var_info.type == 'int' %}
                            <input type="number" class="full-cnv-scenario-input" data-sync-scenario="{{ sid }}" data-sync-var="{{ var_name }}" data-sync-type="input"
                                placeholder="Default: {{ var_info.default }}"
                                {% if var_info.min is defined %}min="{{ var_info.min }}"{% endif %}
                                {% if var_info.max is defined %}max="{{ var_info.max }}"{% endif %}
                                style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg);">
                            {% else %}
                            <input type="text" class="full-cnv-scenario-input" data-sync-scenario="{{ sid }}" data-sync-var="{{ var_name }}" data-sync-type="input"
                                placeholder="{{ var_info.placeholder or ('Default: ' + (var_info.default|string)) }}"
                                style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg);">
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                </div>
            </div>
        </div>
        {% elif preset == '10k_density' %}
        <div style="background:var(--bg-secondary);border:1px solid #f59e0b;border-radius:12px;margin-bottom:20px;overflow:hidden;">
            <div style="background:linear-gradient(135deg, #f59e0b, #d97706);padding:16px 24px;display:flex;align-items:center;gap:12px;">
                <span style="font-size:26px;">üöÄ</span>
                <div>
                    <div style="font-weight:700;color:#fff;font-size:17px;">Create 10K VMs</div>
                    <div style="color:rgba(255,255,255,0.85);font-size:12px;">Per-Host Density preset: 10,000 VMs in 1 namespace, create-only (no shutdown/restart), multi-node.</div>
                </div>
            </div>
            <div style="padding:16px 24px;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;font-size:13px;">
                    <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;">
                        <div style="font-weight:700;color:#92400e;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Total VMs</div>
                        <div style="font-weight:800;font-size:22px;color:#d97706;">10,000</div>
                        <div style="color:#92400e;font-size:11px;">10,000/ns x 1 namespace</div>
                    </div>
                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;">
                        <div style="font-weight:700;color:#166534;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Timeouts</div>
                        <div style="font-weight:800;font-size:22px;color:#16a34a;">48h</div>
                        <div style="color:#166534;font-size:11px;">Max wait + kube-burner</div>
                    </div>
                    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px 14px;">
                        <div style="font-weight:700;color:#1e40af;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Validation</div>
                        <div style="font-weight:800;font-size:22px;color:#2563eb;">0%</div>
                        <div style="color:#1e40af;font-size:11px;">SSH validation skipped</div>
                    </div>
                    <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:8px;padding:10px 14px;">
                        <div style="font-weight:700;color:#6b21a8;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Mode</div>
                        <div style="font-weight:800;font-size:22px;color:#7c3aed;">Create-only</div>
                        <div style="color:#6b21a8;font-size:11px;">Shutdown + restart skipped</div>
                    </div>
                </div>
                <div style="margin-top:12px;font-size:12px;color:var(--text-secondary);">Review the settings below and click <strong>Run Now</strong> to start. All values are pre-filled but editable.</div>
            </div>
        </div>
        {% endif %}
        
        <form action="/job/run" method="POST" id="buildForm" onsubmit="return checkJiraSuggestionsBeforeRun(event)">
            <!-- Run Name -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üè∑Ô∏è Run Information
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="margin-bottom:12px;">
                        <label for="run_name" style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">Run Name (optional)</label>
                        <input type="text" id="run_name" name="run_name" 
                            placeholder="e.g. Pre-upgrade check, Daily health scan, Scale test validation" 
                            style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
                        <span style="font-size:12px;color:var(--text-secondary);margin-top:6px;display:block;">
                            üí° Give this run a descriptive name to easily identify it later in history
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Jump Host -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üñ•Ô∏è Jump Host
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <label for="server_host" style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);">Select Jump Host</label>
                    {% if saved_hosts %}
                    <select name="server_host" id="server_host" 
                        style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);cursor:pointer;">
                        {% for h in saved_hosts %}
                        <option value="{{ h.host }}" {% if h.host == server_host %}selected{% endif %}>
                            {{ h.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <span style="font-size:12px;color:var(--text-secondary);margin-top:8px;display:block;">
                        Manage hosts in <a href="/settings#ssh" style="color:var(--accent);">Settings</a>
                    </span>
                    {% else %}
                    <div style="padding:20px;border:2px dashed var(--border);border-radius:8px;text-align:center;">
                        <span style="font-size:24px;display:block;margin-bottom:8px;">üñ•Ô∏è</span>
                        <span style="color:var(--text-secondary);font-size:14px;">No hosts configured yet.</span><br>
                        <a href="/settings#ssh" style="color:var(--accent);font-size:13px;">Go to Settings to add a host</a>
                    </div>
                    <input type="hidden" name="server_host" value="">
                    {% endif %}
                </div>
            </div>
            
            <input type="hidden" name="agent" value="all">

            <!-- Task Type Selector -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üéØ Task Type
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                        <label class="task-type-option" style="display:flex;flex-direction:column;padding:20px;border:2px solid {{ 'var(--border)' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else 'var(--accent)' }};border-radius:10px;cursor:pointer;transition:all 0.2s;{{ '' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else 'background:var(--accent-light);' }}">
                            <input type="radio" name="task_type" value="health_check" style="margin-bottom:10px;" onchange="switchTaskType()" {{ '' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else 'checked' }}>
                            <span style="font-size:28px;margin-bottom:8px;">ü©∫</span>
                            <span style="font-weight:700;color:var(--text);font-size:15px;">Health Check</span>
                            <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run OCP/CNV health diagnostics with optional root cause analysis</span>
                        </label>
                        <label class="task-type-option" style="display:flex;flex-direction:column;padding:20px;border:2px solid {{ 'var(--accent)' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else 'var(--border)' }};border-radius:10px;cursor:pointer;transition:all 0.2s;{{ 'background:var(--accent-light);' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else '' }}">
                            <input type="radio" name="task_type" value="cnv_scenarios" style="margin-bottom:10px;" onchange="switchTaskType()" {{ 'checked' if preset in ('cnv_sanity', 'cnv_full', '10k_density') else '' }}>
                            <span style="font-size:28px;margin-bottom:8px;">üî•</span>
                            <span style="font-weight:700;color:var(--text);font-size:15px;">CNV Scenarios</span>
                            <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run kube-burner workload tests: CPU, memory, disk, hot-plug, scale</span>
                        </label>
                        <label class="task-type-option" style="display:flex;flex-direction:column;padding:20px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s;">
                            <input type="radio" name="task_type" value="cnv_combined" style="margin-bottom:10px;" onchange="switchTaskType()">
                            <span style="font-size:28px;margin-bottom:8px;">üß¨</span>
                            <span style="font-weight:700;color:var(--text);font-size:15px;">CNV Combined</span>
                            <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run scenarios, then health check, then cleanup -- all in one report</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- COMBINED RUN INFO BANNER (hidden by default) -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="combined-run-banner" style="display:none;">
                <div class="card" style="border:2px solid #8b5cf6;background:linear-gradient(135deg,rgba(139,92,246,0.08),rgba(99,102,241,0.05));">
                    <div class="card-body" style="padding:20px;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <span style="font-size:24px;">üß¨</span>
                            <div>
                                <div style="font-weight:700;color:var(--text);font-size:16px;">Combined Run Pipeline</div>
                                <div style="color:var(--text-secondary);font-size:13px;">Scenarios + Health Check + Cleanup in a single build</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <div style="padding:14px;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--border);text-align:center;">
                                <div style="font-size:22px;margin-bottom:4px;">1</div>
                                <div style="font-weight:600;font-size:13px;color:var(--text);">Run Scenarios</div>
                                <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">cleanup=false (resources kept)</div>
                            </div>
                            <div style="padding:14px;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--border);text-align:center;">
                                <div style="font-size:22px;margin-bottom:4px;">2</div>
                                <div style="font-weight:600;font-size:13px;color:var(--text);">Health Check</div>
                                <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Inspect cluster with test resources</div>
                            </div>
                            <div style="padding:14px;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--border);text-align:center;">
                                <div style="font-size:22px;margin-bottom:4px;">3</div>
                                <div style="font-weight:600;font-size:13px;color:var(--text);">Cleanup</div>
                                <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Remove test resources (optional)</div>
                            </div>
                        </div>
                        <div style="margin-top:16px;padding:14px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="combined_cleanup" name="combined_cleanup" checked
                                    style="width:18px;height:18px;accent-color:#8b5cf6;cursor:pointer;">
                                <label for="combined_cleanup" style="cursor:pointer;flex:1;">
                                    <span style="font-weight:600;font-size:14px;color:var(--text);">Cleanup After Health Check</span>
                                    <span style="display:block;font-size:12px;color:var(--text-secondary);margin-top:2px;">Re-run scenarios with cleanup=true to remove all test resources after the health check completes</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- CNV SCENARIOS SECTION (hidden by default) -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="cnv-scenarios-section" style="display:none;">
                <!-- Test Selection -->
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        üß™ Select Scenarios
                        <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex;gap:8px;margin-bottom:16px;">
                            <button type="button" class="btn" onclick="selectAllScenarios()" style="font-size:12px;">‚úÖ Select All</button>
                            <button type="button" class="btn" onclick="deselectAllScenarios()" style="font-size:12px;">‚¨ú Deselect All</button>
                            <button type="button" class="btn" onclick="selectDefaultScenarios()" style="font-size:12px;">üéØ Defaults</button>
                        </div>
                        {% for cat in cnv_category_order %}
                        <div class="category-header" onclick="toggleCategory(this)" style="cursor:pointer;display:flex;align-items:center;">
                            {{ cnv_categories[cat].icon }} {{ cat }}
                            <span style="margin-left:8px;font-size:11px;color:var(--text-muted);font-weight:400;">{{ cnv_categories[cat].description }}</span>
                            <span class="collapse-icon" style="margin-left:auto;font-size:12px;">‚ñº</span>
                        </div>
                        <div class="checkbox-grid category-content">
                            {% for sid, sc in cnv_scenarios.items() %}
                            {% if sc.category == cat %}
                            <div class="checkbox-item">
                                <input type="checkbox" id="scenario_{{ sid }}" name="scenario_tests" value="{{ sc.remote_name }}"
                                    class="scenario-input" data-category="{{ sc.category }}">
                                <label for="scenario_{{ sid }}">
                                    <span class="check-name">{{ sc.icon }} {{ sc.name }}</span>
                                    <span class="check-desc">{{ sc.description }}</span>
                                </label>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}

                        <!-- Custom Checks linked to scenarios -->
                        {% set scenario_customs = [] %}
                        {% for cc in custom_checks %}
                            {% if cc.run_with in ['scenario', 'both'] %}
                                {% if scenario_customs.append(cc) %}{% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if scenario_customs %}
                        <div class="category-header" onclick="toggleCategory(this)" style="cursor:pointer;display:flex;align-items:center;">
                            üß™ Custom Checks
                            <span style="margin-left:8px;font-size:11px;color:var(--text-muted);font-weight:400;">User-defined validations</span>
                            <span style="font-size:11px;padding:2px 8px;border-radius:8px;background:#8b5cf620;color:#8b5cf6;margin-left:8px;">{{ scenario_customs|length }}</span>
                            <span class="collapse-icon" style="margin-left:auto;font-size:12px;">‚ñº</span>
                        </div>
                        <div class="checkbox-grid category-content">
                            {% for cc in scenario_customs %}
                            <div class="checkbox-item has-commands">
                                <input type="checkbox" id="scenario_custom_{{ cc.id }}" name="scenario_custom_checks" value="{{ cc.id }}"
                                    class="scenario-input" data-category="Custom">
                                <label for="scenario_custom_{{ cc.id }}">
                                    <span class="check-name">{% if cc.check_type == 'script' %}üìú{% else %}üß™{% endif %} {{ cc.name }}</span>
                                    <span class="check-desc">{{ cc.description or 'Custom check' }}{% if cc.check_type == 'script' %} <em>(script)</em>{% endif %}{% if cc.linked_scenario %} ¬∑ linked to {{ cc.linked_scenario }}{% endif %}</span>
                                </label>
                                <button type="button" class="cmd-toggle-btn" onclick="event.stopPropagation();this.closest('.checkbox-item').classList.toggle('show-cmds');" title="Show details">‚åò</button>
                                <div class="cmd-panel">
                                    <div class="cmd-panel-label">{% if cc.check_type == 'script' %}Script{% else %}Command{% endif %} Details</div>
                                    <div class="cmd-entry">
                                        {% if cc.check_type == 'script' %}
                                        <code class="cmd-line" style="white-space:pre-wrap;font-size:11px;">{{ cc.script_content[:300] }}{% if cc.script_content|length > 300 %}...{% endif %}</code>
                                        {% else %}
                                        <code class="cmd-line">{{ cc.command }}</code>
                                        {% endif %}
                                        <div class="cmd-validates">Expected: {{ cc.expected_value or '(any)' }} ({{ cc.match_type }})</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Execution Options -->
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        ‚öôÔ∏è Execution Options
                        <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);font-size:14px;">Test Mode</label>
                                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                                    <label class="mode-option" style="display:flex;flex-direction:column;padding:14px;border:2px solid {{ 'var(--accent)' if cnv_config.mode == 'sanity' else 'var(--border)' }};border-radius:8px;cursor:pointer;{{ 'background:var(--accent-light);' if cnv_config.mode == 'sanity' else '' }}">
                                        <input type="radio" name="scenario_mode" value="sanity" {{ 'checked' if cnv_config.mode == 'sanity' }} style="margin-bottom:6px;" onchange="updateModeStyles()">
                                        <span style="font-weight:600;font-size:13px;">‚ö° Sanity</span>
                                        <span style="color:var(--text-secondary);font-size:11px;">Quick validation (~5 min)</span>
                                    </label>
                                    <label class="mode-option" style="display:flex;flex-direction:column;padding:14px;border:2px solid {{ 'var(--accent)' if cnv_config.mode == 'full' else 'var(--border)' }};border-radius:8px;cursor:pointer;{{ 'background:var(--accent-light);' if cnv_config.mode == 'full' else '' }}">
                                        <input type="radio" name="scenario_mode" value="full" {{ 'checked' if cnv_config.mode == 'full' }} style="margin-bottom:6px;" onchange="updateModeStyles()">
                                        <span style="font-weight:600;font-size:13px;">üî¨ Full</span>
                                        <span style="color:var(--text-secondary);font-size:11px;">Complete test suite (~30+ min)</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);font-size:14px;">Execution</label>
                                <div class="checkbox-item" style="padding:14px;border:1px solid var(--border);border-radius:8px;">
                                    <input type="checkbox" id="scenario_parallel" name="scenario_parallel" {{ 'checked' if cnv_config.parallel }}>
                                    <label for="scenario_parallel">
                                        <span class="check-name">üöÄ Parallel Execution</span>
                                        <span class="check-desc">Run selected scenarios in parallel (faster but more resource-intensive)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);font-size:14px;">CNV Scenarios Path</label>
                                <input type="text" name="cnv_path" value="{{ cnv_config.cnv_path }}"
                                    style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:monospace;background:var(--bg-secondary);">
                                <span style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                                    Path to cnv-scenarios on the jump host
                                </span>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);font-size:14px;">kube-burner Log Level</label>
                                <select name="kb_log_level"
                                    style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg-secondary);">
                                    <option value="" {{ 'selected' if not cnv_config.kb_log_level }}>Default (info)</option>
                                    <option value="debug" {{ 'selected' if cnv_config.kb_log_level == 'debug' }}>debug</option>
                                    <option value="info" {{ 'selected' if cnv_config.kb_log_level == 'info' }}>info</option>
                                    <option value="warn" {{ 'selected' if cnv_config.kb_log_level == 'warn' }}>warn</option>
                                    <option value="error" {{ 'selected' if cnv_config.kb_log_level == 'error' }}>error</option>
                                </select>
                                <span style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                                    Passed to kube-burner --log-level
                                </span>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--text);font-size:14px;">kube-burner Timeout</label>
                                <input type="text" name="kb_timeout" value="{{ cnv_config.kb_timeout }}" placeholder="e.g. 1h, 2h, 30m"
                                    style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg-secondary);">
                                <span style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                                    Passed to kube-burner --timeout
                                </span>
                            </div>
                        </div>

                        <!-- Email Report -->
                        <div style="margin-top:20px;padding:16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);">
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <input type="checkbox" id="cnv_send_email" name="cnv_send_email" style="margin-top:3px;">
                                <label for="cnv_send_email" style="flex:1;">
                                    <span style="font-weight:600;font-size:14px;display:block;">üìß Email Report When Done</span>
                                    <span style="color:var(--text-secondary);font-size:12px;">Send a summary report to your email when the run completes</span>
                                </label>
                            </div>
                            <div id="cnv-email-field" style="display:none;margin-top:12px;padding-left:28px;">
                                <input type="email" name="cnv_email_to" id="cnv_email_to" placeholder="Enter email address"
                                    value="{{ current_user.email }}"
                                    style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variable Overrides -->
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        üîß Variable Overrides (Advanced)
                        <span class="collapse-icon" style="margin-left:auto;">‚ñ≤</span>
                    </div>
                    <div class="card-body">
                        <!-- ‚îÄ‚îÄ Global Parameters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="margin-bottom:24px;">
                            <div style="font-weight:700;font-size:14px;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                                üåç Global Parameters
                            </div>
                            <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">
                                Apply to all selected scenarios. Leave empty to use defaults.
                            </p>
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
                                {% for var_name, var_info in cnv_global_vars.items() %}
                                <div>
                                    <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:4px;">
                                        {{ var_info.icon }} <strong>{{ var_info.label }}</strong>
                                    </label>
                                    {% if var_info.type == 'bool' %}
                                    {% set def_sanity = var_info.default.sanity if var_info.default is mapping else var_info.default %}
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg-secondary);">
                                        <input type="hidden" name="cnv_var_{{ var_name }}" value="false">
                                        <input type="checkbox" name="cnv_var_{{ var_name }}" value="true"
                                            {% if cnv_config.global_vars is defined and var_name in cnv_config.global_vars %}
                                                {% if cnv_config.global_vars[var_name] in [true, 'true', 'True', '1'] %}checked{% endif %}
                                            {% elif def_sanity %}checked{% endif %}
                                            style="width:18px;height:18px;accent-color:var(--accent);cursor:pointer;">
                                        <span style="font-size:13px;color:var(--text);">Enabled</span>
                                    </label>
                                    {% else %}
                                    {% set ph_sanity = var_info.placeholder.sanity if var_info.placeholder is mapping else (var_info.placeholder or '') %}
                                    {% set ph_full = var_info.placeholder.full if var_info.placeholder is mapping else (var_info.placeholder or '') %}
                                    {% set cur_ph = ph_full if cnv_config.mode == 'full' else ph_sanity %}
                                    <input type="text" name="cnv_var_{{ var_name }}"
                                        class="cnv-global-var-input"
                                        value="{{ cnv_config.global_vars[var_name] if cnv_config.global_vars is defined and var_name in cnv_config.global_vars and cnv_config.global_vars[var_name] else '' }}"
                                        placeholder="{{ cur_ph }}"
                                        data-placeholder-sanity="{{ ph_sanity }}"
                                        data-placeholder-full="{{ ph_full }}"
                                        style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--bg-secondary);">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">

                        <!-- ‚îÄ‚îÄ Test-Specific Parameters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="font-weight:700;font-size:14px;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                            üéõÔ∏è Test-Specific Parameters
                        </div>
                        <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">
                            Parameters for individual scenarios. Sections for unselected tests are grayed out.
                        </p>

                        {% for sid, sc in cnv_scenarios.items() %}
                        {% if sc.variables %}
                        <div class="cnv-test-vars-group" data-scenario="{{ sid }}" style="margin-bottom:16px;padding:14px 16px;border:1px solid var(--border);border-radius:8px;transition:opacity 0.25s, filter 0.25s;">
                            <div style="font-weight:600;font-size:13px;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px;">
                                {{ sc.icon }} {{ sc.name }}
                                <span class="cnv-test-badge" style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:var(--success-light);color:var(--success);margin-left:auto;">SELECTED</span>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                                {% for var_name, var_info in sc.variables.items() %}
                                <div>
                                    <label style="display:block;font-size:11px;color:var(--text-secondary);margin-bottom:3px;">
                                        <strong>{{ var_info.label }}</strong>
                                    </label>
                                    {% if var_info.type == 'bool' %}
                                    <select name="cnv_var_{{ var_name }}" class="cnv-var-input" data-scenario="{{ sid }}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg-secondary);">
                                        <option value="">Default ({{ 'true' if var_info.default else 'false' }})</option>
                                        <option value="true">true</option>
                                        <option value="false">false</option>
                                    </select>
                                    {% elif var_info.type == 'choice' %}
                                    <select name="cnv_var_{{ var_name }}" class="cnv-var-input" data-scenario="{{ sid }}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg-secondary);">
                                        <option value="">Default ({{ var_info.default }})</option>
                                        {% for choice in var_info.choices %}
                                        <option value="{{ choice }}">{{ choice }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif var_info.type == 'int' %}
                                    <input type="number" name="cnv_var_{{ var_name }}" class="cnv-var-input" data-scenario="{{ sid }}" placeholder="Default: {{ var_info.default }}"
                                        {% if var_info.min is defined %}min="{{ var_info.min }}"{% endif %}
                                        {% if var_info.max is defined %}max="{{ var_info.max }}"{% endif %}
                                        style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg-secondary);">
                                    {% else %}
                                    <input type="text" name="cnv_var_{{ var_name }}" class="cnv-var-input" data-scenario="{{ sid }}" placeholder="{{ var_info.placeholder or ('Default: ' + (var_info.default|string)) }}"
                                        style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg-secondary);">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- HEALTH CHECK SECTIONS (shown by default) -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="health-check-section">
            <!-- General Options -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    ‚öôÔ∏è Build Options
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
                        <div class="checkbox-item" style="flex-direction:column;align-items:stretch;{% if not current_user.is_admin %}opacity:0.45;pointer-events:none;{% endif %}" {% if not current_user.is_admin %}title="Admin only"{% endif %}>
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <input type="checkbox" id="opt_jira" name="check_jira" {{ 'checked' if preset == 'all' and current_user.is_admin else '' }} onchange="toggleJiraScan()" {% if not current_user.is_admin %}disabled{% endif %}>
                                <label for="opt_jira">
                                    <span class="check-name">üîç Jira Integration{% if not current_user.is_admin %} (Admin only){% endif %}</span>
                                    <span class="check-desc">Check Jira for recent bugs & suggest adding new tests</span>
                                </label>
                            </div>
                            <div id="jira-scan-section" style="display:none;margin-top:12px;padding:12px;background:var(--bg-tertiary);border-radius:8px;">
                                <button type="button" onclick="scanJiraForTests()" class="btn" style="background:var(--accent);color:white;width:100%;">
                                    üîç Scan Jira for New Test Suggestions
                                </button>
                                <div id="jira-scan-status" style="margin-top:8px;font-size:12px;color:var(--text-secondary);text-align:center;"></div>
                            </div>
                        </div>
                        <div class="checkbox-item" style="flex-direction:column;align-items:stretch;">
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <input type="checkbox" id="opt_email" name="send_email" style="margin-top:3px;" {{ 'checked' if preset == 'all' else '' }}>
                                <label for="opt_email">
                                    <span class="check-name">üì§ Email Report</span>
                                    <span class="check-desc">Send report via email</span>
                                </label>
                            </div>
                            <input type="email" name="email_to" id="email_to" placeholder="Enter email address (e.g. user@redhat.com)" 
                                style="margin-top:10px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;width:100%;"
                                value="{{ current_user.email }}">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Root Cause Analysis -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üî¨ Root Cause Analysis
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="margin-bottom:20px;">
                        <div style="font-weight:600;color:var(--text);margin-bottom:12px;font-size:14px;">Analysis Level</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <label class="rca-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="rca_level" value="none" style="margin-bottom:8px;" onchange="toggleRcaSources()" {{ '' if preset == 'all' else 'checked' }}>
                                <span style="font-weight:600;color:var(--text);font-size:14px;">üìã Checks Only</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run health checks without analysis</span>
                            </label>
                            <label class="rca-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="rca_level" value="bugs" style="margin-bottom:8px;" onchange="toggleRcaSources()">
                                <span style="font-weight:600;color:var(--text);font-size:14px;">üêõ Bug Digging</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Match failures to known bugs</span>
                            </label>
                            <label class="rca-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="rca_level" value="full" style="margin-bottom:8px;" onchange="toggleRcaSources()" {{ 'checked' if preset == 'all' else '' }}>
                                <span style="font-weight:600;color:var(--text);font-size:14px;">üîç Full RCA</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Deep investigation & root cause</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="rca-sources" style="display:none;">
                        <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
                        <div style="font-weight:600;color:var(--text);margin-bottom:12px;font-size:14px;">üìö Data Sources for Bug Digging</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <div class="checkbox-item" style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                                <input type="checkbox" id="opt_jira_rca" name="rca_jira" {{ 'checked' if preset == 'all' else 'checked' }}>
                                <label for="opt_jira_rca">
                                    <span class="check-name">üé´ Jira Bugs</span>
                                    <span class="check-desc">Search Jira for matching bugs & known issues</span>
                                </label>
                            </div>
                            <div class="checkbox-item" style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                                <input type="checkbox" id="opt_email_rca" name="rca_email" {{ 'checked' if preset == 'all' else '' }}>
                                <label for="opt_email_rca">
                                    <span class="check-name">üìß Email Search</span>
                                    <span class="check-desc">Search Gmail for related discussions & alerts</span>
                                </label>
                            </div>
                            <div class="checkbox-item" style="padding:12px;border:1px solid var(--border);border-radius:8px;opacity:0.45;pointer-events:none;" title="Not available yet">
                                <input type="checkbox" id="opt_web_rca" name="rca_web" disabled>
                                <label for="opt_web_rca">
                                    <span class="check-name">üåê Web Search (Coming soon)</span>
                                    <span class="check-desc">Search docs, forums & knowledge bases</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Thresholds Configuration -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üìä Alert Thresholds
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="margin-bottom:16px;">
                        <div class="checkbox-item" style="padding:0;">
                            <input type="checkbox" id="use_custom_thresholds" name="use_custom_thresholds" onchange="toggleThresholdInputs()">
                            <label for="use_custom_thresholds">
                                <span class="check-name">‚öôÔ∏è Use Custom Thresholds</span>
                                <span class="check-desc">Override default thresholds for this run only</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="threshold-inputs" style="display:none;padding-top:16px;border-top:1px solid var(--border);">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üî• CPU Warning Threshold (%)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="range" name="cpu_threshold" id="cpu_threshold" 
                                        min="50" max="100" value="{{ thresholds.cpu_warning }}"
                                        style="flex:1;" oninput="document.getElementById('cpu_val').textContent=this.value+'%'">
                                    <span id="cpu_val" style="width:45px;text-align:right;font-weight:600;">{{ thresholds.cpu_warning }}%</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.cpu_warning }}% - Flag nodes above this</span>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üíæ Memory Warning Threshold (%)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="range" name="memory_threshold" id="memory_threshold" 
                                        min="50" max="100" value="{{ thresholds.memory_warning }}"
                                        style="flex:1;" oninput="document.getElementById('mem_val').textContent=this.value+'%'">
                                    <span id="mem_val" style="width:45px;text-align:right;font-weight:600;">{{ thresholds.memory_warning }}%</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.memory_warning }}% - Flag nodes above this</span>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üíø Disk I/O Latency Threshold (ms)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="number" name="disk_latency_threshold" id="disk_latency_threshold" 
                                        min="10" max="1000" value="{{ thresholds.disk_latency }}"
                                        style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;">
                                    <span style="width:30px;">ms</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.disk_latency }}ms - Flag I/O above this</span>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üóÑÔ∏è etcd Latency Threshold (ms)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="number" name="etcd_latency_threshold" id="etcd_latency_threshold" 
                                        min="10" max="500" value="{{ thresholds.etcd_latency }}"
                                        style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;">
                                    <span style="width:30px;">ms</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.etcd_latency }}ms - Critical above this</span>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üì¶ Pod Density Warning (pods/node)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="number" name="pod_density_threshold" id="pod_density_threshold" 
                                        min="10" max="250" value="{{ thresholds.pod_density }}"
                                        style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;">
                                    <span style="width:70px;">pods/node</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.pod_density }} - Warn above this</span>
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">
                                    üîÅ Pod Restart Threshold (count)
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="number" name="restart_threshold" id="restart_threshold" 
                                        min="1" max="50" value="{{ thresholds.restart_count }}"
                                        style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;">
                                    <span style="width:70px;">restarts</span>
                                </div>
                                <span style="font-size:11px;color:var(--text-muted);">Default: {{ thresholds.restart_count }} - Flag pods with more restarts</span>
                            </div>
                        </div>
                        <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                <span style="font-size:16px;">üí°</span>
                                <span style="font-weight:600;font-size:13px;">Tip: Change Defaults</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);">
                                These overrides only apply to this run. To change the defaults permanently, 
                                go to <a href="/settings" style="color:var(--accent);">Settings</a>.
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Health Checks Selection -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üîç Select Health Checks to Run
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    {% for category in categories %}
                    <div class="category-header" onclick="toggleCategory(this)" style="cursor:pointer;display:flex;align-items:center;">
                        {{ category_icons.get(category, '') }} {{ category }}
                        <span class="collapse-icon" style="margin-left:auto;font-size:12px;">‚ñº</span>
                    </div>
                    <div class="checkbox-grid category-content">
                        {% for check_id, check in checks.items() %}
                        {% if check.category == category %}
                        <div class="checkbox-item has-commands">
                            <input type="checkbox" id="check_{{ check_id }}" name="checks" value="{{ check_id }}" 
                                {{ 'checked' if (preset == 'all' or check.default) else '' }} class="check-input" data-category="{{ check.category }}">
                            <label for="check_{{ check_id }}">
                                <span class="check-name">{{ check.name }}</span>
                                <span class="check-desc">{{ check.description }}</span>
                            </label>
                            {% if check.commands is defined and check.commands %}
                            <button type="button" class="cmd-toggle-btn" onclick="event.stopPropagation();this.closest('.checkbox-item').classList.toggle('show-cmds');" title="Show validation details">‚åò</button>
                            <div class="cmd-panel">
                                <div class="cmd-panel-label">Validation Details</div>
                                {% for entry in check.commands %}
                                <div class="cmd-entry">
                                    <code class="cmd-line">{{ entry.cmd }}</code>
                                    <div class="cmd-validates">{{ entry.validates }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}

                    <!-- Custom Checks -->
                    {% if custom_checks %}
                    <div class="category-header" onclick="toggleCategory(this)" style="cursor:pointer;display:flex;align-items:center;">
                        üß™ Custom Checks
                        <span style="font-size:11px;padding:2px 8px;border-radius:8px;background:#8b5cf620;color:#8b5cf6;margin-left:8px;">{{ custom_checks|length }}</span>
                        <span class="collapse-icon" style="margin-left:auto;font-size:12px;">‚ñº</span>
                    </div>
                    <div class="checkbox-grid category-content">
                        {% for cc in custom_checks %}
                        {% if cc.run_with in ['health_check', 'both'] %}
                        <div class="checkbox-item has-commands">
                            <input type="checkbox" id="custom_{{ cc.id }}" name="custom_checks" value="{{ cc.id }}"
                                class="check-input" data-category="Custom">
                            <label for="custom_{{ cc.id }}">
                                <span class="check-name">{% if cc.check_type == 'script' %}üìú{% else %}üß™{% endif %} {{ cc.name }}</span>
                                <span class="check-desc">{{ cc.description or 'Custom check' }}{% if cc.check_type == 'script' %} <em>(script{% if cc.script_filename %}: {{ cc.script_filename }}{% endif %})</em>{% endif %}</span>
                            </label>
                            <button type="button" class="cmd-toggle-btn" onclick="event.stopPropagation();this.closest('.checkbox-item').classList.toggle('show-cmds');" title="Show details">‚åò</button>
                            <div class="cmd-panel">
                                <div class="cmd-panel-label">{% if cc.check_type == 'script' %}Script{% else %}Command{% endif %} Details</div>
                                <div class="cmd-entry">
                                    {% if cc.check_type == 'script' %}
                                    <code class="cmd-line" style="white-space:pre-wrap;font-size:11px;">{{ cc.script_content[:300] }}{% if cc.script_content|length > 300 %}...{% endif %}</code>
                                    {% else %}
                                    <code class="cmd-line">{{ cc.command }}</code>
                                    {% endif %}
                                    <div class="cmd-validates">Expected: {{ cc.expected_value or '(any)' }} ({{ cc.match_type }})</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            </div><!-- /health-check-section -->

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- SCHEDULING OPTIONS (always visible, all task types) -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    üïê Schedule Build
                    <span class="collapse-icon" style="margin-left:auto;">‚ñº</span>
                </div>
                <div class="card-body">
                    <div style="margin-bottom:20px;">
                        <div style="font-weight:600;color:var(--text);margin-bottom:12px;font-size:14px;">Run Type</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                            <label class="schedule-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="schedule_type" value="now" style="margin-bottom:8px;" onchange="toggleScheduleOptions()" checked>
                                <span style="font-weight:600;color:var(--text);font-size:14px;">‚ñ∂Ô∏è Run Now</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Execute immediately</span>
                            </label>
                            <label class="schedule-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="schedule_type" value="once" style="margin-bottom:8px;" onchange="toggleScheduleOptions()">
                                <span style="font-weight:600;color:var(--text);font-size:14px;">üìÖ Schedule Once</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run at specific date/time</span>
                            </label>
                            <label class="schedule-option" style="display:flex;flex-direction:column;padding:16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;">
                                <input type="radio" name="schedule_type" value="recurring" style="margin-bottom:8px;" onchange="toggleScheduleOptions()">
                                <span style="font-weight:600;color:var(--text);font-size:14px;">üîÑ Recurring</span>
                                <span style="color:var(--text-secondary);font-size:12px;margin-top:4px;">Run on a schedule</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Schedule Once Options -->
                    <div id="schedule-once-options" style="display:none;">
                        <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
                        <div style="font-weight:600;color:var(--text);margin-bottom:12px;font-size:14px;">üìÖ Schedule Date & Time</div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Date</label>
                                <input type="date" name="schedule_date" id="schedule_date" 
                                    style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Time</label>
                                <input type="time" name="schedule_time" id="schedule_time" 
                                    style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recurring Options -->
                    <div id="schedule-recurring-options" style="display:none;">
                        <hr style="border:none;border-top:1px solid var(--border);margin:20px 0;">
                        <div style="font-weight:600;color:var(--text);margin-bottom:12px;font-size:14px;">üîÑ Recurring Schedule</div>
                        
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Frequency</label>
                            <select name="recurring_frequency" id="recurring_frequency" onchange="toggleRecurringDetails()"
                                style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:var(--bg-secondary);">
                                <option value="hourly">Every Hour</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom (Cron)</option>
                            </select>
                        </div>
                        
                        <!-- Time for daily/weekly/monthly -->
                        <div id="recurring-time" style="margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Time of Day</label>
                            <input type="time" name="recurring_time" id="recurring_time" value="06:00"
                                style="width:200px;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;">
                        </div>
                        
                        <!-- Days for weekly -->
                        <div id="recurring-days" style="display:none;margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Days of Week</label>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="mon" checked> Mon
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="tue"> Tue
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="wed"> Wed
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="thu"> Thu
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="fri" checked> Fri
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="sat"> Sat
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                                    <input type="checkbox" name="recurring_days" value="sun"> Sun
                                </label>
                            </div>
                        </div>
                        
                        <!-- Day of month for monthly -->
                        <div id="recurring-dayofmonth" style="display:none;margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Day of Month</label>
                            <input type="number" name="recurring_dayofmonth" id="recurring_dayofmonth" value="1" min="1" max="28"
                                style="width:100px;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;">
                        </div>
                        
                        <!-- Custom cron -->
                        <div id="recurring-cron" style="display:none;margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Cron Expression</label>
                            <input type="text" name="recurring_cron" id="recurring_cron" placeholder="0 6 * * *" 
                                style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;font-family:monospace;">
                            <span style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                                Format: minute hour day month weekday (e.g., "0 6 * * 1-5" = 6AM weekdays)
                            </span>
                        </div>
                        
                        <!-- Schedule name -->
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px;">Schedule Name (optional)</label>
                            <input type="text" name="schedule_name" id="schedule_name" placeholder="e.g., Daily Morning Check"
                                style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit -->
            <div style="display:flex;gap:12px;margin-top:20px;align-items:center;">
                <button type="submit" id="submit-btn" class="btn btn-primary" style="padding:12px 30px;font-size:14px;">
                    ‚ñ∂Ô∏è Run Now
                </button>
                <button type="button" class="btn" style="padding:12px 20px;font-size:14px;" onclick="openSaveTemplateModal()">
                    üíæ Save as Template
                </button>
                <a href="/" class="btn">Cancel</a>
                <a href="/schedules" class="btn" style="margin-left:auto;">üìÖ View Scheduled Tasks</a>
            </div>
        </form>

    <!-- Save Template Modal -->
    <div id="saveTemplateModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;" onclick="if(event.target===this)closeSaveTemplateModal()">
        <div style="background:var(--bg);border-radius:12px;padding:24px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                <h3 style="margin:0;font-size:18px;color:var(--text);">üíæ Save as Template</h3>
                <span onclick="closeSaveTemplateModal()" style="cursor:pointer;font-size:20px;color:var(--text-muted);">&times;</span>
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Template Name *</label>
                <input type="text" id="tmpl-name" placeholder="e.g. My 10K VMs Test" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Description (optional)</label>
                <input type="text" id="tmpl-desc" placeholder="Short description of this test configuration" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);">
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);">Icon</label>
                <div id="tmpl-icon-picker" style="display:flex;gap:8px;flex-wrap:wrap;">
                    <span class="tmpl-icon-opt" data-icon="üìã" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid var(--accent);border-radius:8px;">üìã</span>
                    <span class="tmpl-icon-opt" data-icon="üöÄ" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üöÄ</span>
                    <span class="tmpl-icon-opt" data-icon="üî•" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üî•</span>
                    <span class="tmpl-icon-opt" data-icon="üèãÔ∏è" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üèãÔ∏è</span>
                    <span class="tmpl-icon-opt" data-icon="‚ö°" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">‚ö°</span>
                    <span class="tmpl-icon-opt" data-icon="üß™" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üß™</span>
                    <span class="tmpl-icon-opt" data-icon="üéØ" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üéØ</span>
                    <span class="tmpl-icon-opt" data-icon="üíª" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üíª</span>
                    <span class="tmpl-icon-opt" data-icon="üèóÔ∏è" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üèóÔ∏è</span>
                    <span class="tmpl-icon-opt" data-icon="üìä" onclick="pickTemplateIcon(this)" style="cursor:pointer;font-size:22px;padding:6px;border:2px solid transparent;border-radius:8px;">üìä</span>
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="tmpl-shared">
                    <span style="font-size:13px;color:var(--text);">Share with all team members</span>
                </label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" class="btn" onclick="closeSaveTemplateModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()" id="tmpl-save-btn" style="padding:10px 24px;">üíæ Save Template</button>
            </div>
        </div>
    </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCard(header) {
        header.classList.toggle('collapsed');
        var body = header.nextElementSibling;
        if (body && body.classList.contains('card-body')) {
            body.classList.toggle('collapsed');
        }
    }
    
    function toggleCategory(header) {
        header.classList.toggle('collapsed');
        var content = header.nextElementSibling;
        if (content && content.classList.contains('category-content')) {
            content.classList.toggle('collapsed');
        }
    }
    
    function selectAll() {
        document.querySelectorAll('.check-input').forEach(cb => cb.checked = true);
        document.querySelector('input[name="rca_level"][value="full"]').checked = true;
        document.getElementById('opt_jira_rca').checked = true;
        document.getElementById('opt_email_rca').checked = true;
        var jiraOpt = document.getElementById('opt_jira');
        if (!jiraOpt.disabled) jiraOpt.checked = true;
        document.getElementById('opt_email').checked = true;
        toggleRcaSources();
        return false;
    }
    
    function selectNone() {
        document.querySelectorAll('.check-input').forEach(cb => cb.checked = false);
        document.querySelector('input[name="rca_level"][value="none"]').checked = true;
        document.getElementById('opt_jira_rca').checked = false;
        document.getElementById('opt_email_rca').checked = false;
        document.getElementById('opt_jira').checked = false;
        document.getElementById('opt_email').checked = false;
        toggleRcaSources();
        return false;
    }
    
    function updateRcaStyles() {
        document.querySelectorAll('.rca-option').forEach(opt => {
            var radio = opt.querySelector('input[type="radio"]');
            if (radio.checked) {
                opt.style.borderColor = 'var(--accent)';
                opt.style.background = 'var(--accent-light)';
            } else {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            }
        });
    }
    
    function toggleRcaSources() {
        var rcaLevel = document.querySelector('input[name="rca_level"]:checked').value;
        var sourcesDiv = document.getElementById('rca-sources');
        if (rcaLevel === 'bugs' || rcaLevel === 'full') {
            sourcesDiv.style.display = 'block';
        } else {
            sourcesDiv.style.display = 'none';
        }
        updateRcaStyles();
    }
    
    document.querySelectorAll('input[name="rca_level"]').forEach(r => r.addEventListener('change', toggleRcaSources));
    toggleRcaSources();
    
    function selectInfra() {
        document.querySelectorAll('.check-input').forEach(cb => {
            cb.checked = cb.dataset.category === 'Infrastructure';
        });
        return false;
    }
    
    function selectVirt() {
        document.querySelectorAll('.check-input').forEach(cb => {
            cb.checked = cb.dataset.category === 'Virtualization';
        });
        return false;
    }
    
    // Schedule functions
    function toggleScheduleOptions() {
        var scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
        var onceOptions = document.getElementById('schedule-once-options');
        var recurringOptions = document.getElementById('schedule-recurring-options');
        var submitBtn = document.getElementById('submit-btn');
        
        onceOptions.style.display = 'none';
        recurringOptions.style.display = 'none';
        
        if (scheduleType === 'now') {
            submitBtn.innerHTML = '‚ñ∂Ô∏è Run Now';
        } else if (scheduleType === 'once') {
            onceOptions.style.display = 'block';
            submitBtn.innerHTML = 'üìÖ Schedule Build';
            // Set default date/time to tomorrow at 6 AM
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('schedule_date').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('schedule_time').value = '06:00';
        } else if (scheduleType === 'recurring') {
            recurringOptions.style.display = 'block';
            submitBtn.innerHTML = 'üîÑ Create Schedule';
        }
        
        updateScheduleStyles();
    }
    
    function updateScheduleStyles() {
        document.querySelectorAll('.schedule-option').forEach(opt => {
            var radio = opt.querySelector('input[type="radio"]');
            if (radio.checked) {
                opt.style.borderColor = 'var(--accent)';
                opt.style.background = 'var(--accent-light)';
            } else {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            }
        });
    }
    
    function toggleRecurringDetails() {
        var frequency = document.getElementById('recurring_frequency').value;
        var timeDiv = document.getElementById('recurring-time');
        var daysDiv = document.getElementById('recurring-days');
        var dayOfMonthDiv = document.getElementById('recurring-dayofmonth');
        var cronDiv = document.getElementById('recurring-cron');
        
        // Hide all
        timeDiv.style.display = 'none';
        daysDiv.style.display = 'none';
        dayOfMonthDiv.style.display = 'none';
        cronDiv.style.display = 'none';
        
        // Show relevant options
        if (frequency === 'hourly') {
            // No additional options needed
        } else if (frequency === 'daily') {
            timeDiv.style.display = 'block';
        } else if (frequency === 'weekly') {
            timeDiv.style.display = 'block';
            daysDiv.style.display = 'block';
        } else if (frequency === 'monthly') {
            timeDiv.style.display = 'block';
            dayOfMonthDiv.style.display = 'block';
        } else if (frequency === 'custom') {
            cronDiv.style.display = 'block';
        }
    }
    
    // Initialize
    document.querySelectorAll('input[name="schedule_type"]').forEach(r => r.addEventListener('change', toggleScheduleOptions));
    toggleScheduleOptions();
    toggleRecurringDetails();
    
    // Threshold toggle function
    function toggleThresholdInputs() {
        var checkbox = document.getElementById('use_custom_thresholds');
        var inputs = document.getElementById('threshold-inputs');
        if (checkbox.checked) {
            inputs.style.display = 'block';
        } else {
            inputs.style.display = 'none';
        }
    }
    
    // Initialize threshold section
    toggleThresholdInputs();

    // ‚îÄ‚îÄ Task Type Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchTaskType() {
        var taskType = document.querySelector('input[name="task_type"]:checked').value;
        var hcSection = document.getElementById('health-check-section');
        var cnvSection = document.getElementById('cnv-scenarios-section');
        var combinedBanner = document.getElementById('combined-run-banner');
        var submitBtn = document.getElementById('submit-btn');

        if (taskType === 'cnv_scenarios') {
            hcSection.style.display = 'none';
            cnvSection.style.display = 'block';
            combinedBanner.style.display = 'none';
            submitBtn.innerHTML = 'üî• Run Scenarios';
        } else if (taskType === 'cnv_combined') {
            hcSection.style.display = 'block';
            cnvSection.style.display = 'block';
            combinedBanner.style.display = 'block';
            submitBtn.innerHTML = 'üß¨ Run Combined';
        } else {
            hcSection.style.display = 'block';
            cnvSection.style.display = 'none';
            combinedBanner.style.display = 'none';
            submitBtn.innerHTML = '‚ñ∂Ô∏è Run Now';
        }
        updateTaskTypeStyles();
    }

    function updateTaskTypeStyles() {
        document.querySelectorAll('.task-type-option').forEach(function(opt) {
            var radio = opt.querySelector('input[type="radio"]');
            if (radio.checked) {
                opt.style.borderColor = 'var(--accent)';
                opt.style.background = 'var(--accent-light)';
            } else {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            }
        });
    }

    function selectAllScenarios() {
        document.querySelectorAll('.scenario-input').forEach(function(cb) { cb.checked = true; });
        return false;
    }
    function deselectAllScenarios() {
        document.querySelectorAll('.scenario-input').forEach(function(cb) { cb.checked = false; });
        return false;
    }
    function selectDefaultScenarios() {
        document.querySelectorAll('.scenario-input').forEach(function(cb) { cb.checked = false; });
        {% for sid, sc in cnv_scenarios.items() %}
        {% if sc.default %}
        var el = document.getElementById('scenario_{{ sid }}');
        if (el) el.checked = true;
        {% endif %}
        {% endfor %}
        return false;
    }

    function updateModeStyles() {
        document.querySelectorAll('.mode-option').forEach(function(opt) {
            var radio = opt.querySelector('input[type="radio"]');
            if (radio.checked) {
                opt.style.borderColor = 'var(--accent)';
                opt.style.background = 'var(--accent-light)';
            } else {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            }
        });
        // Update global var placeholders based on selected mode
        var mode = document.querySelector('input[name="scenario_mode"]:checked');
        var modeVal = mode ? mode.value : 'sanity';
        document.querySelectorAll('.cnv-global-var-input').forEach(function(inp) {
            var ph = inp.getAttribute('data-placeholder-' + modeVal);
            if (ph !== null) {
                inp.placeholder = ph;
            }
        });
    }

    // ‚îÄ‚îÄ Show only selected test-specific variable groups ‚îÄ
    function updateScenarioVarGroups() {
        document.querySelectorAll('.cnv-test-vars-group').forEach(function(group) {
            var sid = group.getAttribute('data-scenario');
            var cb = document.getElementById('scenario_' + sid);
            var inputs = group.querySelectorAll('.cnv-var-input');
            if (cb && cb.checked) {
                group.style.display = '';
                inputs.forEach(function(inp) { inp.disabled = false; });
            } else {
                group.style.display = 'none';
                inputs.forEach(function(inp) { inp.disabled = true; });
            }
        });
    }

    // Attach to all scenario checkboxes
    document.querySelectorAll('.scenario-input').forEach(function(cb) {
        cb.addEventListener('change', updateScenarioVarGroups);
    });

    // Also update when select-all/deselect/defaults are clicked
    var _origSelectAll = selectAllScenarios;
    selectAllScenarios = function() { _origSelectAll(); updateScenarioVarGroups(); return false; };
    var _origDeselect = deselectAllScenarios;
    deselectAllScenarios = function() { _origDeselect(); updateScenarioVarGroups(); return false; };
    var _origDefaults = selectDefaultScenarios;
    selectDefaultScenarios = function() { _origDefaults(); updateScenarioVarGroups(); return false; };

    // Initial state
    updateScenarioVarGroups();
    updateModeStyles();

    // Init task type
    document.querySelectorAll('input[name="task_type"]').forEach(function(r) { r.addEventListener('change', switchTaskType); });
    switchTaskType();

    // Quick Sanity preset: select all scenario tests + sanity mode
    {% if preset == 'cnv_sanity' %}
    (function() {
        // Select sanity mode
        var sanityRadio = document.querySelector('input[name="scenario_mode"][value="sanity"]');
        if (sanityRadio) { sanityRadio.checked = true; updateModeStyles(); }
        // Select all scenario tests
        document.querySelectorAll('input.scenario-input[name="scenario_tests"]').forEach(function(cb) { cb.checked = true; });
    })();
    {% endif %}

    // Full CNV Regression preset: select all scenarios in full mode, sync table to fields
    {% if preset == 'cnv_full' %}
    (function() {
        // Select full mode
        var fullRadio = document.querySelector('input[name="scenario_mode"][value="full"]');
        if (fullRadio) { fullRadio.checked = true; updateModeStyles(); }

        // Set full-mode global variable defaults
        var globalFullDefaults = { 'maxWaitTimeout': '30m', 'jobPause': '2m' };
        for (var gName in globalFullDefaults) {
            var gInput = document.querySelector('input[name="cnv_var_' + gName + '"].cnv-global-var-input');
            if (gInput) { gInput.value = globalFullDefaults[gName]; }
        }

        // Select all scenario tests
        document.querySelectorAll('input.scenario-input[name="scenario_tests"]').forEach(function(cb) { cb.checked = true; });

        // Sync a table input value to its target scenario field
        function syncToScenarioField(tableInput) {
            var scenario = tableInput.getAttribute('data-target-scenario');
            var varName = tableInput.getAttribute('data-target-var');
            var value = tableInput.value;
            // Find the scenario field
            var field = document.querySelector('[name="cnv_var_' + varName + '"][data-scenario="' + scenario + '"]');
            if (!field) field = document.querySelector('[name="cnv_var_' + varName + '"]');
            if (field) {
                if (field.tagName === 'SELECT') {
                    for (var i = 0; i < field.options.length; i++) {
                        if (field.options[i].value === value) { field.selectedIndex = i; break; }
                    }
                } else {
                    field.value = value;
                }
            }
            // Handle extra linked field (e.g. namespaceCount for per_host_density)
            var extraScenario = tableInput.getAttribute('data-extra-scenario');
            var extraVar = tableInput.getAttribute('data-extra-var');
            var extraVal = tableInput.getAttribute('data-extra-value');
            if (extraScenario && extraVar && extraVal) {
                var extraField = document.querySelector('[name="cnv_var_' + extraVar + '"][data-scenario="' + extraScenario + '"]');
                if (!extraField) extraField = document.querySelector('[name="cnv_var_' + extraVar + '"]');
                if (extraField) extraField.value = extraVal;
            }
        }

        // Helper: find matching Test-Specific param input for a table input
        function findMatchingScenarioInput(tableInput) {
            var sc = tableInput.getAttribute('data-target-scenario');
            var vn = tableInput.getAttribute('data-target-var');
            return document.querySelector('.full-cnv-scenario-input[data-sync-scenario="' + sc + '"][data-sync-var="' + vn + '"]');
        }
        // Helper: find matching table input for a Test-Specific param input
        function findMatchingTableInput(scenarioInput) {
            var sc = scenarioInput.getAttribute('data-sync-scenario');
            var vn = scenarioInput.getAttribute('data-sync-var');
            return document.querySelector('.full-cnv-input[data-target-scenario="' + sc + '"][data-target-var="' + vn + '"]');
        }

        // Initial sync: push all table values into scenario fields AND test-specific params
        document.querySelectorAll('.full-cnv-input').forEach(function(inp) {
            syncToScenarioField(inp);
            // Also push value into test-specific param input
            var match = findMatchingScenarioInput(inp);
            if (match) {
                if (match.tagName === 'SELECT') { match.value = inp.value; }
                else { match.value = inp.value; }
            }
            // Live sync on change: table ‚Üí form + test-specific params
            inp.addEventListener('input', function() {
                syncToScenarioField(this);
                var m = findMatchingScenarioInput(this);
                if (m) { m.value = this.value; syncScenarioParam(m); }
            });
            inp.addEventListener('change', function() {
                syncToScenarioField(this);
                var m = findMatchingScenarioInput(this);
                if (m) { m.value = this.value; syncScenarioParam(m); }
            });
        });

        // Sync global variable overrides from the top card to the form fields below
        function syncGlobalOverride(topInput) {
            var varName = topInput.getAttribute('data-global-var');
            var isBool = topInput.getAttribute('data-is-bool') === 'true';
            var formField = document.querySelector('input[name="cnv_var_' + varName + '"].cnv-global-var-input');
            var formCheckbox = document.querySelector('#cnv-scenarios-section input[name="cnv_var_' + varName + '"][type="checkbox"]');
            if (isBool && formCheckbox) {
                formCheckbox.checked = topInput.checked;
                // Also update the hidden sibling
                var hidden = formCheckbox.previousElementSibling;
                if (hidden && hidden.type === 'hidden') hidden.value = topInput.checked ? 'true' : 'false';
            } else if (formField) {
                formField.value = topInput.value;
            }
        }

        // Initial sync + live listeners for global overrides
        document.querySelectorAll('.full-cnv-global-input').forEach(function(inp) {
            syncGlobalOverride(inp);
            inp.addEventListener('input', function() { syncGlobalOverride(this); });
            inp.addEventListener('change', function() { syncGlobalOverride(this); });
        });

        // Sync test-specific parameter inputs from top card to form fields below
        function syncScenarioParam(topInput) {
            var scenario = topInput.getAttribute('data-sync-scenario');
            var varName = topInput.getAttribute('data-sync-var');
            var syncType = topInput.getAttribute('data-sync-type');
            // Find the matching form field
            var formField = document.querySelector('[name="cnv_var_' + varName + '"][data-scenario="' + scenario + '"]');
            if (!formField) return;
            if (syncType === 'select' && formField.tagName === 'SELECT') {
                formField.value = topInput.value;
            } else if (formField.tagName === 'SELECT') {
                for (var i = 0; i < formField.options.length; i++) {
                    if (formField.options[i].value === topInput.value) { formField.selectedIndex = i; break; }
                }
            } else {
                formField.value = topInput.value;
            }
        }

        // Initial sync + live listeners for test-specific parameters (bidirectional)
        document.querySelectorAll('.full-cnv-scenario-input').forEach(function(inp) {
            inp.addEventListener('input', function() {
                syncScenarioParam(this);
                var tbl = findMatchingTableInput(this);
                if (tbl) { tbl.value = this.value; syncToScenarioField(tbl); }
            });
            inp.addEventListener('change', function() {
                syncScenarioParam(this);
                var tbl = findMatchingTableInput(this);
                if (tbl) { tbl.value = this.value; syncToScenarioField(tbl); }
            });
        });

        // Expand the Variable Overrides card so it's visible
        var varOverridesCard = document.querySelector('#cnv-scenarios-section .card-header');
        var cards = document.querySelectorAll('#cnv-scenarios-section .card-header');
        cards.forEach(function(hdr) {
            var txt = hdr.textContent || '';
            if (txt.indexOf('Variable Overrides') !== -1) {
                // If collapsed (has ‚ñ≤), click to expand
                var icon = hdr.querySelector('.collapse-icon');
                if (icon && icon.textContent.trim() === '‚ñ≤') {
                    hdr.click();
                }
            }
        });
    })();
    {% endif %}

    {% if preset == '10k_density' %}
    (function() {
        // Select full mode
        var fullRadio = document.querySelector('input[name="scenario_mode"][value="full"]');
        if (fullRadio) { fullRadio.checked = true; updateModeStyles(); }

        // Select only per-host-density test
        document.querySelectorAll('input.scenario-input[name="scenario_tests"]').forEach(function(cb) {
            cb.checked = (cb.value === 'per-host-density');
        });

        // Helper to set a scenario variable field by name and optional scenario
        function setVar(varName, value, scenario) {
            var sel = scenario
                ? '[name="cnv_var_' + varName + '"][data-scenario="' + scenario + '"]'
                : '[name="cnv_var_' + varName + '"]';
            var field = document.querySelector(sel);
            if (!field) return;
            if (field.tagName === 'SELECT') {
                for (var i = 0; i < field.options.length; i++) {
                    if (field.options[i].value === value) { field.selectedIndex = i; break; }
                }
            } else if (field.type === 'checkbox') {
                field.checked = (value === 'true');
                var hidden = field.previousElementSibling;
                if (hidden && hidden.type === 'hidden') hidden.value = value;
            } else {
                field.value = value;
            }
        }

        // Per-Host Density - every field filled in
        setVar('vmsPerNamespace', '10000', 'per_host_density');
        setVar('namespaceCount', '1', 'per_host_density');
        setVar('scaleMode', 'multi-node', 'per_host_density');
        setVar('targetNode', '', 'per_host_density');
        setVar('cleanup', 'false', 'per_host_density');
        setVar('percentage_of_vms_to_validate', '0', 'per_host_density');
        setVar('max_ssh_retries', '240', 'per_host_density');
        setVar('vmMemory', '256Mi', 'per_host_density');
        setVar('vmCpuCores', '100', 'per_host_density');
        setVar('vmCpuRequest', '100m', 'per_host_density');
        setVar('vmCpuLimit', '1000m', 'per_host_density');
        setVar('sourceStorageSize', '256', 'per_host_density');
        setVar('vmStorageSize', '256', 'per_host_density');
        setVar('imageUrl', '', 'per_host_density');
        setVar('shutdownBatchSize', '50', 'per_host_density');
        setVar('sleepBetweenPhases', '2m', 'per_host_density');
        setVar('skipVmShutdown', 'true', 'per_host_density');
        setVar('skipVmRestart', 'true', 'per_host_density');
        setVar('qpsCreate', '20', 'per_host_density');
        setVar('burstCreate', '40', 'per_host_density');
        setVar('qpsShutdown', '10', 'per_host_density');
        setVar('burstShutdown', '20', 'per_host_density');
        setVar('qpsStartup', '30', 'per_host_density');
        setVar('burstStartup', '60', 'per_host_density');

        // Global overrides
        setVar('storageClassName', '');
        setVar('nodeSelector', '');
        setVar('maxWaitTimeout', '48h');
        setVar('jobPause', '2m');

        // Uncheck global cleanup
        var cleanupCheckboxes = document.querySelectorAll('input[name="cnv_var_cleanup"]');
        cleanupCheckboxes.forEach(function(cb) {
            if (cb.type === 'checkbox') {
                cb.checked = false;
                var hidden = cb.previousElementSibling;
                if (hidden && hidden.type === 'hidden') hidden.value = 'false';
            }
        });

        // kube-burner timeout
        var kbTimeout = document.querySelector('input[name="kb_timeout"]');
        if (kbTimeout) kbTimeout.value = '48h';

        // Enable email report
        var emailCb = document.querySelector('input[name="cnv_send_email"]');
        if (emailCb) emailCb.checked = true;

        // Refresh UI: show CNV section and make per-host-density fields visible
        switchTaskType();
        updateScenarioVarGroups();

        // Expand the Variable Overrides card so all fields are visible
        document.querySelectorAll('#cnv-scenarios-section .card-header').forEach(function(hdr) {
            var txt = hdr.textContent || '';
            if (txt.indexOf('Variable Overrides') !== -1) {
                var body = hdr.nextElementSibling;
                var icon = hdr.querySelector('.collapse-icon');
                if (body && body.style.display === 'none') {
                    hdr.click();
                } else if (icon && icon.textContent.trim() === '‚ñ≤') {
                    hdr.click();
                }
            }
        });
    })();
    {% endif %}

    {% if load_template %}
    (function() {
        loadTemplateConfig({{ load_template.config | tojson }});
    })();
    {% endif %}

    // CNV email toggle
    var cnvEmailCb = document.getElementById('cnv_send_email');
    if (cnvEmailCb) {
        cnvEmailCb.addEventListener('change', function() {
            document.getElementById('cnv-email-field').style.display = this.checked ? 'block' : 'none';
        });
    }
    
    // Jira Integration functions
    function toggleJiraScan() {
        var jiraCheckbox = document.getElementById('opt_jira');
        var scanSection = document.getElementById('jira-scan-section');
        if (jiraCheckbox.checked) {
            scanSection.style.display = 'block';
        } else {
            scanSection.style.display = 'none';
        }
    }
    
    // Initialize Jira scan section
    toggleJiraScan();
    
    var jiraSuggestions = [];
    var currentSuggestionIndex = 0;
    
    function scanJiraForTests() {
        var statusDiv = document.getElementById('jira-scan-status');
        statusDiv.innerHTML = '<span style="color:var(--accent);">üîç Scanning Jira for recent bugs...</span>';
        
        fetch('/api/jira/suggestions')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    jiraSuggestions = data.suggestions;
                    currentSuggestionIndex = 0;
                    statusDiv.innerHTML = '<span style="color:var(--success);">‚úÖ Found ' + data.count + ' suggestions from ' + data.bugs_analyzed + ' bugs</span>';
                    showJiraSuggestionModal();
                } else {
                    statusDiv.innerHTML = '<span style="color:var(--text-muted);">No new test suggestions found</span>';
                }
            })
            .catch(err => {
                statusDiv.innerHTML = '<span style="color:var(--error);">‚ùå Error: ' + err.message + '</span>';
            });
    }
    
    function showJiraSuggestionModal() {
        if (currentSuggestionIndex >= jiraSuggestions.length) {
            closeJiraModal();
            var statusDiv = document.getElementById('jira-scan-status');
            statusDiv.innerHTML = '<span style="color:var(--success);">‚úÖ All suggestions reviewed</span>';
            return;
        }
        
        var suggestion = jiraSuggestions[currentSuggestionIndex];
        var modal = document.getElementById('jira-suggestion-modal');
        
        // Update modal content
        document.getElementById('modal-check-name').textContent = suggestion.suggested_check;
        document.getElementById('modal-jira-key').textContent = suggestion.jira_key;
        document.getElementById('modal-jira-key').href = 'https://issues.redhat.com/browse/' + suggestion.jira_key;
        document.getElementById('modal-priority').textContent = suggestion.priority;
        document.getElementById('modal-priority').className = 'priority-badge priority-' + suggestion.priority.toLowerCase();
        document.getElementById('modal-summary').textContent = suggestion.summary;
        document.getElementById('modal-description').textContent = suggestion.check_description;
        document.getElementById('modal-reason').textContent = suggestion.reason;
        document.getElementById('modal-counter').textContent = (currentSuggestionIndex + 1) + ' of ' + jiraSuggestions.length;
        
        // Command
        var cmdSection = document.getElementById('modal-cmd-section');
        if (suggestion.command) {
            document.getElementById('modal-command').textContent = suggestion.command;
            cmdSection.style.display = 'block';
        } else {
            cmdSection.style.display = 'none';
        }
        
        // Show modal
        modal.style.display = 'flex';
    }
    
    function acceptJiraSuggestion() {
        var suggestion = jiraSuggestions[currentSuggestionIndex];
        
        fetch('/api/jira/accept-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: suggestion.suggested_check,
                jira_key: suggestion.jira_key,
                description: suggestion.check_description,
                category: 'Custom'
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Add the check to the form
                addCustomCheckToForm(suggestion);
                showToast('‚úÖ Check "' + suggestion.suggested_check + '" added!', 'success');
            }
            currentSuggestionIndex++;
            showJiraSuggestionModal();
        });
    }
    
    function rejectJiraSuggestion() {
        var suggestion = jiraSuggestions[currentSuggestionIndex];
        
        fetch('/api/jira/reject-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: suggestion.suggested_check })
        })
        .then(r => r.json())
        .then(data => {
            showToast('‚è≠Ô∏è Skipped "' + suggestion.suggested_check + '"', 'info');
            currentSuggestionIndex++;
            showJiraSuggestionModal();
        });
    }
    
    function skipAllJiraSuggestions() {
        closeJiraModal();
        var statusDiv = document.getElementById('jira-scan-status');
        statusDiv.innerHTML = '<span style="color:var(--text-muted);">Skipped all suggestions</span>';
    }
    
    function closeJiraModal() {
        document.getElementById('jira-suggestion-modal').style.display = 'none';
    }
    
    function addCustomCheckToForm(suggestion) {
        // Check if custom checks section exists, if not create it
        var customSection = document.getElementById('custom-checks-section');
        if (!customSection) {
            // Find the health checks card and add a custom section
            var checksCard = document.querySelector('.card-body .checkbox-grid').parentElement;
            var newSection = document.createElement('div');
            newSection.innerHTML = '<div class="category-header" onclick="toggleCategory(this)" style="cursor:pointer;display:flex;align-items:center;margin-top:20px;background:linear-gradient(90deg,var(--purple),var(--accent));color:white;padding:10px 15px;border-radius:8px;">ü§ñ AI-Suggested Checks (from Jira)<span class="collapse-icon" style="margin-left:auto;font-size:12px;">‚ñº</span></div><div class="checkbox-grid category-content" id="custom-checks-section"></div>';
            checksCard.appendChild(newSection);
            customSection = document.getElementById('custom-checks-section');
        }
        
        // Add the check
        var checkDiv = document.createElement('div');
        checkDiv.className = 'checkbox-item';
        checkDiv.style.background = 'linear-gradient(135deg, rgba(106,27,154,0.1), rgba(0,112,204,0.1))';
        checkDiv.style.border = '1px solid var(--purple)';
        checkDiv.style.borderRadius = '8px';
        checkDiv.style.padding = '12px';
        checkDiv.innerHTML = '<input type="checkbox" id="check_' + suggestion.suggested_check + '" name="checks" value="' + suggestion.suggested_check + '" checked class="check-input" data-category="Custom">' +
            '<label for="check_' + suggestion.suggested_check + '">' +
            '<span class="check-name">ü§ñ ' + suggestion.suggested_check.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</span>' +
            '<span class="check-desc">' + suggestion.check_description + ' <a href="https://issues.redhat.com/browse/' + suggestion.jira_key + '" target="_blank" style="color:var(--accent);">' + suggestion.jira_key + '</a></span>' +
            '</label>';
        customSection.appendChild(checkDiv);
    }
    
    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 24px;border-radius:8px;color:white;font-weight:500;z-index:10000;animation:slideIn 0.3s ease;';
        toast.style.background = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--accent)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Pre-run Jira suggestions check
    var preRunSuggestions = [];
    var preRunSuggestionIndex = 0;
    var proceedWithRun = false;
    
    function checkJiraSuggestionsBeforeRun(event) {
        // If we already processed suggestions, proceed with submit
        if (proceedWithRun) {
            proceedWithRun = false;
            return true;
        }
        
        // Check if Jira integration is enabled
        var jiraCheckbox = document.getElementById('opt_jira');
        if (!jiraCheckbox || !jiraCheckbox.checked) {
            return true; // No Jira, proceed normally
        }
        
        // Prevent form submission while we check
        event.preventDefault();
        
        // Show loading
        showToast('üîç Checking Jira for new test suggestions...', 'info');
        
        // Fetch suggestions
        fetch('/api/jira/suggestions')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    preRunSuggestions = data.suggestions;
                    preRunSuggestionIndex = 0;
                    showPreRunSuggestionModal();
                } else {
                    // No suggestions, proceed with run
                    showToast('‚úÖ No new suggestions found, starting run...', 'success');
                    proceedWithRun = true;
                    document.getElementById('buildForm').submit();
                }
            })
            .catch(error => {
                console.error('Error checking Jira:', error);
                // On error, proceed with run anyway
                proceedWithRun = true;
                document.getElementById('buildForm').submit();
            });
        
        return false;
    }
    
    function showPreRunSuggestionModal() {
        if (preRunSuggestionIndex >= preRunSuggestions.length) {
            // All suggestions processed, proceed with run
            closePreRunModal();
            showToast('‚úÖ Starting health check...', 'success');
            proceedWithRun = true;
            document.getElementById('buildForm').submit();
            return;
        }
        
        var suggestion = preRunSuggestions[preRunSuggestionIndex];
        var modal = document.getElementById('pre-run-modal');
        
        // Update modal content
        document.getElementById('pre-run-counter').textContent = (preRunSuggestionIndex + 1) + ' of ' + preRunSuggestions.length;
        document.getElementById('pre-run-check-name').textContent = suggestion.suggested_check.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        document.getElementById('pre-run-jira-key').textContent = suggestion.jira_key;
        document.getElementById('pre-run-jira-key').href = 'https://issues.redhat.com/browse/' + suggestion.jira_key;
        document.getElementById('pre-run-priority').textContent = suggestion.priority || 'Normal';
        document.getElementById('pre-run-priority').className = 'priority-badge priority-' + (suggestion.priority || 'normal').toLowerCase();
        document.getElementById('pre-run-description').textContent = suggestion.check_description;
        document.getElementById('pre-run-reason').textContent = suggestion.bug_summary || 'Detected from recent Jira bugs';
        
        // Command
        var cmdSection = document.getElementById('pre-run-cmd-section');
        if (suggestion.command) {
            document.getElementById('pre-run-command').textContent = suggestion.command;
            cmdSection.style.display = 'block';
        } else {
            cmdSection.style.display = 'none';
        }
        
        modal.style.display = 'flex';
    }
    
    function acceptPreRunSuggestion() {
        var suggestion = preRunSuggestions[preRunSuggestionIndex];
        
        // Accept via API
        fetch('/api/jira/accept-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: suggestion.suggested_check,
                jira_key: suggestion.jira_key,
                description: suggestion.check_description
            })
        }).then(() => {
            // Add the check to the form
            addPreRunCheckToForm(suggestion);
            showToast('‚úÖ Added: ' + suggestion.suggested_check, 'success');
            
            // Move to next
            preRunSuggestionIndex++;
            showPreRunSuggestionModal();
        });
    }
    
    function rejectPreRunSuggestion() {
        var suggestion = preRunSuggestions[preRunSuggestionIndex];
        
        // Reject via API
        fetch('/api/jira/reject-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: suggestion.suggested_check })
        });
        
        // Move to next
        preRunSuggestionIndex++;
        showPreRunSuggestionModal();
    }
    
    function skipAllPreRunSuggestions() {
        closePreRunModal();
        showToast('‚è≠Ô∏è Skipped suggestions, starting run...', 'info');
        proceedWithRun = true;
        document.getElementById('buildForm').submit();
    }
    
    function closePreRunModal() {
        document.getElementById('pre-run-modal').style.display = 'none';
    }
    
    function addPreRunCheckToForm(suggestion) {
        // Add a hidden input for the new check
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'checks';
        input.value = suggestion.suggested_check;
        document.getElementById('buildForm').appendChild(input);
    }

    function toggleSidebarSection(title) {
        title.classList.toggle('collapsed');
        var content = title.nextElementSibling;
        if (content && content.classList.contains('sidebar-content')) {
            content.classList.toggle('collapsed');
        }
    }

    // ‚îÄ‚îÄ Template Save/Load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _selectedTemplateIcon = 'üìã';

    function pickTemplateIcon(el) {
        document.querySelectorAll('.tmpl-icon-opt').forEach(function(e) {
            e.style.borderColor = 'transparent';
        });
        el.style.borderColor = 'var(--accent)';
        _selectedTemplateIcon = el.getAttribute('data-icon');
    }

    function openSaveTemplateModal() {
        var modal = document.getElementById('saveTemplateModal');
        modal.style.display = 'flex';
        document.getElementById('tmpl-name').value = '';
        document.getElementById('tmpl-desc').value = '';
        document.getElementById('tmpl-shared').checked = false;
        _selectedTemplateIcon = 'üìã';
        document.querySelectorAll('.tmpl-icon-opt').forEach(function(e) {
            e.style.borderColor = e.getAttribute('data-icon') === 'üìã' ? 'var(--accent)' : 'transparent';
        });
        document.getElementById('tmpl-name').focus();
    }

    function closeSaveTemplateModal() {
        document.getElementById('saveTemplateModal').style.display = 'none';
    }

    function serializeFormConfig() {
        var form = document.getElementById('buildForm');
        var config = {};

        config.task_type = (form.querySelector('input[name="task_type"]:checked') || {}).value || 'health_check';
        config.run_name = (form.querySelector('[name="run_name"]') || {}).value || '';
        config.server_host = (form.querySelector('[name="server_host"]') || {}).value || '';

        // Health checks
        config.checks = [];
        form.querySelectorAll('input[name="checks"]:checked').forEach(function(cb) {
            config.checks.push(cb.value);
        });

        // CNV scenarios
        config.scenario_mode = (form.querySelector('input[name="scenario_mode"]:checked') || {}).value || 'sanity';
        config.scenario_tests = [];
        form.querySelectorAll('input[name="scenario_tests"]:checked').forEach(function(cb) {
            config.scenario_tests.push(cb.value);
        });
        config.scenario_parallel = !!(form.querySelector('input[name="scenario_parallel"]') || {}).checked;
        config.cnv_path = (form.querySelector('[name="cnv_path"]') || {}).value || '';
        config.kb_log_level = (form.querySelector('[name="kb_log_level"]') || {}).value || '';
        config.kb_timeout = (form.querySelector('[name="kb_timeout"]') || {}).value || '';

        // Env vars (cnv_var_*)
        config.env_vars = {};
        form.querySelectorAll('[name^="cnv_var_"]').forEach(function(el) {
            var varName = el.name.replace('cnv_var_', '');
            var scenario = el.getAttribute('data-scenario') || '_global';
            var key = scenario === '_global' ? varName : scenario + '.' + varName;
            if (el.type === 'checkbox') {
                config.env_vars[key] = el.checked ? 'true' : 'false';
            } else {
                config.env_vars[key] = el.value;
            }
        });

        // RCA / email / thresholds
        config.rca_level = (form.querySelector('[name="rca_level"]') || {}).value || 'none';
        config.email = !!(form.querySelector('[name="cnv_send_email"]') || {}).checked;
        config.email_to = (form.querySelector('[name="cnv_email_to"]') || {}).value || '';

        return config;
    }

    function saveTemplate() {
        var name = document.getElementById('tmpl-name').value.trim();
        if (!name) {
            alert('Please enter a template name');
            document.getElementById('tmpl-name').focus();
            return;
        }
        var btn = document.getElementById('tmpl-save-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        fetch('/api/templates', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: document.getElementById('tmpl-desc').value.trim(),
                icon: _selectedTemplateIcon,
                shared: document.getElementById('tmpl-shared').checked,
                config: serializeFormConfig()
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                closeSaveTemplateModal();
                location.reload();
            }
        })
        .catch(function(err) {
            alert('Failed to save: ' + err);
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'üíæ Save Template';
        });
    }

    function deleteTemplate(id, name) {
        if (!confirm('Delete template "' + name + '"?')) return;
        fetch('/api/templates/' + id, {method: 'DELETE'})
        .then(function(r) { return r.json(); })
        .then(function() { location.reload(); })
        .catch(function(err) { alert('Failed: ' + err); });
    }

    // Load a user template into the form
    function loadTemplateConfig(config) {
        var form = document.getElementById('buildForm');
        if (!config) return;

        // Task type
        if (config.task_type) {
            var radio = form.querySelector('input[name="task_type"][value="' + config.task_type + '"]');
            if (radio) { radio.checked = true; switchTaskType(); }
        }

        // Run name
        if (config.run_name) {
            var rn = form.querySelector('[name="run_name"]');
            if (rn) rn.value = config.run_name;
        }

        // Server host
        if (config.server_host) {
            var sh = form.querySelector('[name="server_host"]');
            if (sh) sh.value = config.server_host;
        }

        // Health checks
        if (config.checks && config.checks.length) {
            form.querySelectorAll('input[name="checks"]').forEach(function(cb) {
                cb.checked = config.checks.indexOf(cb.value) !== -1;
            });
        }

        // Scenario mode
        if (config.scenario_mode) {
            var modeRadio = form.querySelector('input[name="scenario_mode"][value="' + config.scenario_mode + '"]');
            if (modeRadio) { modeRadio.checked = true; if (typeof updateModeStyles === 'function') updateModeStyles(); }
        }

        // Scenario tests
        if (config.scenario_tests && config.scenario_tests.length) {
            form.querySelectorAll('input[name="scenario_tests"]').forEach(function(cb) {
                cb.checked = config.scenario_tests.indexOf(cb.value) !== -1;
            });
        }

        // Scenario parallel
        if (config.scenario_parallel !== undefined) {
            var sp = form.querySelector('input[name="scenario_parallel"]');
            if (sp) sp.checked = !!config.scenario_parallel;
        }

        // cnv_path
        if (config.cnv_path) {
            var cp = form.querySelector('[name="cnv_path"]');
            if (cp) cp.value = config.cnv_path;
        }

        // kb_timeout, kb_log_level
        if (config.kb_timeout) {
            var kt = form.querySelector('[name="kb_timeout"]');
            if (kt) kt.value = config.kb_timeout;
        }
        if (config.kb_log_level) {
            var kl = form.querySelector('[name="kb_log_level"]');
            if (kl) kl.value = config.kb_log_level;
        }

        // Env vars
        if (config.env_vars) {
            Object.keys(config.env_vars).forEach(function(key) {
                var val = config.env_vars[key];
                var parts = key.split('.');
                var varName, scenario;
                if (parts.length === 2) {
                    scenario = parts[0];
                    varName = parts[1];
                } else {
                    varName = parts[0];
                    scenario = null;
                }
                var sel = scenario
                    ? '[name="cnv_var_' + varName + '"][data-scenario="' + scenario + '"]'
                    : '[name="cnv_var_' + varName + '"]';
                var field = form.querySelector(sel);
                if (!field) return;
                if (field.tagName === 'SELECT') {
                    for (var i = 0; i < field.options.length; i++) {
                        if (field.options[i].value === val) { field.selectedIndex = i; break; }
                    }
                } else if (field.type === 'checkbox') {
                    field.checked = (val === 'true');
                    var hidden = field.previousElementSibling;
                    if (hidden && hidden.type === 'hidden') hidden.value = val;
                } else {
                    field.value = val;
                }
            });
        }

        // Email
        if (config.email !== undefined) {
            var emailCb = form.querySelector('[name="cnv_send_email"]');
            if (emailCb) emailCb.checked = !!config.email;
        }
        if (config.email_to) {
            var emailTo = form.querySelector('[name="cnv_email_to"]');
            if (emailTo) emailTo.value = config.email_to;
        }

        // RCA level
        if (config.rca_level) {
            var rl = form.querySelector('[name="rca_level"]');
            if (rl) rl.value = config.rca_level;
        }

        // Refresh UI
        if (typeof updateScenarioVarGroups === 'function') updateScenarioVarGroups();
    }
</script>

<!-- Pre-Run Jira Suggestions Modal -->
<div id="pre-run-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.75);backdrop-filter:blur(4px);z-index:10000;justify-content:center;align-items:center;">
    <div style="background:#fff;border-radius:14px;max-width:560px;width:92%;box-shadow:0 24px 80px rgba(0,0,0,0.25);border:1px solid #e5e7eb;">
        <!-- Header -->
        <div style="padding:20px 24px 16px;border-bottom:1px solid #f0f0f0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="background:linear-gradient(135deg,#f59e0b,#d97706);width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;">üé´</span>
                    <span style="font-size:16px;font-weight:700;color:#111;">New Test Suggestion from Jira</span>
                </div>
                <span id="pre-run-counter" style="background:#eef2ff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;color:#4338ca;">1 of 3</span>
            </div>
            <p style="margin:0;font-size:13px;color:#4b5563;padding-left:40px;font-weight:500;">Add this check to your health check run?</p>
        </div>
        
        <!-- Content -->
        <div style="padding:20px 24px;">
            <!-- Check Name -->
            <div style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:6px;">Suggested Check</div>
                <div id="pre-run-check-name" style="font-size:18px;font-weight:700;color:#111;font-family:'SF Mono','Consolas',monospace;background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:8px;"></div>
            </div>
            
            <!-- Jira + Priority row -->
            <div style="display:flex;gap:16px;margin-bottom:20px;">
                <div style="flex:1;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:4px;">Source Bug</div>
                    <a id="pre-run-jira-key" href="#" target="_blank" style="font-weight:600;color:#0066cc;text-decoration:none;font-size:14px;"></a>
                </div>
                <div>
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:4px;">Priority</div>
                    <span id="pre-run-priority" class="priority-badge"></span>
                </div>
            </div>
            
            <!-- Description -->
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px 16px;margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#15803d;margin-bottom:6px;">What This Check Does</div>
                <div id="pre-run-description" style="font-size:13px;color:#166534;line-height:1.6;font-weight:500;"></div>
            </div>
            
            <!-- Command -->
            <div id="pre-run-cmd-section" style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:6px;">Validation Command</div>
                <div style="background:#1e1e2e;border-radius:8px;padding:12px 14px;position:relative;">
                    <code id="pre-run-command" style="display:block;color:#a5f3fc;font-family:'SF Mono','Consolas','Courier New',monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;line-height:1.6;"></code>
                    <span style="position:absolute;top:8px;right:10px;font-size:9px;color:#94a3b8;background:#2d2d3d;padding:2px 6px;border-radius:4px;font-weight:600;">oc</span>
                </div>
            </div>
            
            <!-- Reason -->
            <div style="font-size:13px;color:#374151;margin-bottom:24px;padding-left:2px;">
                <strong style="color:#111827;">Why:</strong> <span id="pre-run-reason"></span>
            </div>
        </div>
        
        <!-- Actions -->
        <div style="padding:0 24px 20px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;gap:10px;">
                <button type="button" onclick="acceptPreRunSuggestion()" style="flex:1;padding:12px 20px;border:none;border-radius:8px;background:#16a34a;color:white;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.15s;" onmouseover="this.style.background='#15803d'" onmouseout="this.style.background='#16a34a'">
                    Add to This Run
                </button>
                <button type="button" onclick="rejectPreRunSuggestion()" style="flex:1;padding:12px 20px;border:1px solid #d1d5db;border-radius:8px;background:#fff;color:#374151;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
                    Skip
                </button>
            </div>
            <button type="button" onclick="skipAllPreRunSuggestions()" style="width:100%;padding:10px;border:none;border-radius:8px;background:#fef2f2;color:#b91c1c;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s;" onmouseover="this.style.background='#fee2e2';this.style.color='#dc2626'" onmouseout="this.style.background='#fef2f2';this.style.color='#b91c1c'">
                Skip all & start run
            </button>
        </div>
    </div>
</div>

<!-- Jira Suggestion Modal (for during build) -->
<div id="jira-suggestion-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.75);backdrop-filter:blur(4px);z-index:9999;justify-content:center;align-items:center;">
    <div style="background:#fff;border-radius:14px;max-width:560px;width:92%;max-height:90vh;overflow:auto;box-shadow:0 24px 80px rgba(0,0,0,0.25);border:1px solid #e5e7eb;">
        <!-- Header -->
        <div style="padding:20px 24px 16px;border-bottom:1px solid #f0f0f0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="background:linear-gradient(135deg,#6366f1,#8b5cf6);width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;">ü§ñ</span>
                    <span style="font-size:16px;font-weight:700;color:#111;">New Health Check Suggestion</span>
                </div>
                <span id="modal-counter" style="background:#eef2ff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;color:#4338ca;">1 of 3</span>
            </div>
            <p style="margin:0;font-size:13px;color:#4b5563;padding-left:40px;font-weight:500;">AI found a potential new test from Jira bugs</p>
        </div>
        
        <!-- Content -->
        <div style="padding:20px 24px;">
            <!-- Check Name -->
            <div style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:6px;">Suggested Check</div>
                <div id="modal-check-name" style="font-size:18px;font-weight:700;color:#111;font-family:'SF Mono','Consolas',monospace;background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:8px;"></div>
            </div>
            
            <!-- Jira + Priority row -->
            <div style="display:flex;gap:16px;margin-bottom:20px;">
                <div style="flex:1;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:4px;">Source Bug</div>
                    <a id="modal-jira-key" href="#" target="_blank" style="font-weight:600;color:#0066cc;text-decoration:none;font-size:14px;"></a>
                </div>
                <div>
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:4px;">Priority</div>
                    <span id="modal-priority" class="priority-badge"></span>
                </div>
            </div>
            
            <!-- Summary -->
            <div style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:6px;">Bug Summary</div>
                <div id="modal-summary" style="font-size:14px;line-height:1.6;color:#111827;font-weight:500;"></div>
            </div>
            
            <!-- Description -->
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px 16px;margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#15803d;margin-bottom:6px;">What This Check Does</div>
                <div id="modal-description" style="font-size:13px;color:#166534;line-height:1.6;font-weight:500;"></div>
            </div>
            
            <!-- Command -->
            <div id="modal-cmd-section" style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#1f2937;margin-bottom:6px;">Validation Command</div>
                <div style="background:#1e1e2e;border-radius:8px;padding:12px 14px;position:relative;">
                    <code id="modal-command" style="display:block;color:#a5f3fc;font-family:'SF Mono','Consolas','Courier New',monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;line-height:1.6;"></code>
                    <span style="position:absolute;top:8px;right:10px;font-size:9px;color:#94a3b8;background:#2d2d3d;padding:2px 6px;border-radius:4px;font-weight:600;">oc</span>
                </div>
            </div>
            
            <!-- Reason -->
            <div style="font-size:13px;color:#374151;margin-bottom:24px;padding-left:2px;">
                <strong style="color:#111827;">Why suggested:</strong> <span id="modal-reason"></span>
            </div>
        </div>
        
        <!-- Actions -->
        <div style="padding:0 24px 20px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;gap:10px;">
                <button type="button" onclick="acceptJiraSuggestion()" style="flex:1;padding:12px 20px;border:none;border-radius:8px;background:#16a34a;color:white;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.15s;" onmouseover="this.style.background='#15803d'" onmouseout="this.style.background='#16a34a'">
                    Accept & Add
                </button>
                <button type="button" onclick="rejectJiraSuggestion()" style="flex:1;padding:12px 20px;border:1px solid #d1d5db;border-radius:8px;background:#fff;color:#374151;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
                    Skip
                </button>
            </div>
            <button type="button" onclick="skipAllJiraSuggestions()" style="width:100%;padding:10px;border:none;border-radius:8px;background:#fef2f2;color:#b91c1c;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s;" onmouseover="this.style.background='#fee2e2';this.style.color='#dc2626'" onmouseout="this.style.background='#fef2f2';this.style.color='#b91c1c'">
                Skip all remaining
            </button>
        </div>
    </div>
</div>

<style>
    .priority-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }
    .priority-critical, .priority-blocker {
        background: var(--error);
        color: white;
    }
    .priority-major {
        background: var(--warning);
        color: #333;
    }
    .priority-normal, .priority-minor {
        background: var(--bg-tertiary);
        color: var(--text);
    }
    @keyframes slideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Command toggle for health check items */
    .checkbox-item.has-commands {
        flex-wrap: wrap;
        position: relative;
    }
    .cmd-toggle-btn {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        margin-top: 2px;
        opacity: 0.7;
        box-shadow: 0 1px 3px rgba(99,102,241,0.3);
    }
    .cmd-toggle-btn:hover {
        opacity: 1;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(99,102,241,0.4);
    }
    .checkbox-item.show-cmds .cmd-toggle-btn {
        opacity: 1;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        box-shadow: 0 2px 8px rgba(99,102,241,0.4);
    }
    .cmd-panel {
        display: none;
        width: 100%;
        padding: 10px 12px 4px;
        margin-top: 8px;
        border-top: 2px solid #6366f120;
        background: linear-gradient(135deg, #f0f0ff, #f8f7ff);
        border-radius: 0 0 8px 8px;
        margin-left: -14px;
        margin-right: -14px;
        margin-bottom: -14px;
        width: calc(100% + 28px);
    }
    .checkbox-item.show-cmds .cmd-panel {
        display: block;
    }
    .cmd-panel-label {
        font-size: 10px;
        font-weight: 700;
        color: #6366f1;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 6px;
    }
    .cmd-entry {
        margin-bottom: 10px;
    }
    .cmd-entry:last-child {
        margin-bottom: 0;
    }
    .cmd-line {
        display: block;
        background: #1e1e2e;
        color: #a5f3fc;
        font-family: 'SF Mono', 'Consolas', 'Courier New', monospace;
        font-size: 11.5px;
        padding: 8px 12px;
        border-radius: 6px 6px 0 0;
        white-space: pre-wrap;
        word-break: break-all;
        line-height: 1.5;
        border: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .cmd-validates {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-top: none;
        color: #166534;
        font-size: 11.5px;
        padding: 6px 12px;
        border-radius: 0 0 6px 6px;
        line-height: 1.5;
    }
</style>
{% endblock %}
