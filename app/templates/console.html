{% extends "base.html" %}

{% block title %}Console Output - Build #{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .console-full {
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        padding: 20px;
        min-height: 500px;
        white-space: pre-wrap;
        word-break: break-word;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<span>â€º</span>
<a href="/job/{{ build.number }}">Build #{{ build.number }}{% if build.name %} - {{ build.name }}{% endif %}</a>
<span>â€º</span>
<span>Console Output</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Build #{{ build.number }}</div>
            {% if build.name %}
            <div style="padding:8px 12px;font-size:12px;color:var(--text-secondary);background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;">
                ğŸ·ï¸ {{ build.name }}
            </div>
            {% endif %}
            <a href="/job/{{ build.number }}" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“Š</span>
                Build Summary
            </a>
            <a href="/job/{{ build.number }}/console" class="sidebar-item active">
                <span class="sidebar-icon">ğŸ“</span>
                Console Output
            </a>
        </div>
    </aside>
    
    <main class="main">
        <div class="card">
            <div class="card-header">ğŸ“ Console Output</div>
            <div class="card-body" style="padding:0;">
                <div class="console-full" id="console">{{ build.output }}</div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
{% if build.status == 'running' %}
<script>
    var buildNum = {{ build.number }};
    var pollTimer = setInterval(function() {
        fetch('/api/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                // Find this build among running builds
                var myBuild = null;
                if (data.builds) {
                    for (var i = 0; i < data.builds.length; i++) {
                        if (data.builds[i].number === buildNum) {
                            myBuild = data.builds[i];
                            break;
                        }
                    }
                }
                if (myBuild) {
                    document.getElementById('console').innerHTML = myBuild.output;
                    document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
                } else if (!data.running || !myBuild) {
                    // Build finished â€” reload once to show final output from DB, then stop polling
                    clearInterval(pollTimer);
                    location.reload();
                }
            });
    }, 2000);
</script>
{% endif %}
{% endblock %}
