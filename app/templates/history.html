{% extends "base.html" %}

{% block title %}Run History - CNV HealthCrew AI{% endblock %}

{% block breadcrumb %}
<span>â€º</span>
<span>Run History</span>
{% endblock %}

{% block content %}
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Filter
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">â–¼</span>
            </div>
            <div class="sidebar-content">
                <a href="/job/history" class="sidebar-item active">
                    <span class="sidebar-icon">ğŸ“‹</span>
                    All Runs
                </a>
                <a href="/job/history?status=success" class="sidebar-item">
                    <span class="sidebar-icon">âœ…</span>
                    Successful
                </a>
                <a href="/job/history?status=unstable" class="sidebar-item">
                    <span class="sidebar-icon">âš ï¸</span>
                    With Issues
                </a>
                <a href="/job/history?status=failed" class="sidebar-item">
                    <span class="sidebar-icon">âŒ</span>
                    Failed
                </a>
            </div>
        </div>
        {% if current_user.is_admin %}
        <div class="sidebar-section">
            <div class="sidebar-title" onclick="toggleSidebarSection(this)" style="cursor:pointer;display:flex;align-items:center;">
                Cleanup
                <span class="collapse-icon" style="margin-left:auto;font-size:10px;">â–¼</span>
            </div>
            <div class="sidebar-content">
                <a href="#" onclick="deleteBulk('stopped'); return false;" class="sidebar-item" style="color:var(--warning);">
                    <span class="sidebar-icon">â¹ï¸</span>
                    Delete All Stopped
                </a>
                <a href="#" onclick="deleteBulk('failed'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">âŒ</span>
                    Delete All Failed
                </a>
                <a href="#" onclick="deleteBulk('all'); return false;" class="sidebar-item" style="color:var(--error);">
                    <span class="sidebar-icon">ğŸ—‘ï¸</span>
                    Delete All Runs
                </a>
            </div>
        </div>
        {% endif %}
    </aside>
    
    <main class="main">
        <div class="card">
            <div class="card-header">
                ğŸ“‹ Run History
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                    <span style="font-weight:normal;color:var(--text-muted);">{{ builds|length }} builds</span>
                    <a href="/job/history?view=all" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view != 'mine' %}background:var(--accent);color:white;{% endif %}">All</a>
                    <a href="/job/history?view=mine" class="btn" style="padding:4px 12px;font-size:11px;{% if current_view == 'mine' %}background:var(--accent);color:white;{% endif %}">Mine</a>
                </div>
                <button id="deleteSelectedBtn" onclick="deleteSelected()" class="btn btn-danger" style="margin-left:16px;display:none;">
                    ğŸ—‘ï¸ Delete Selected (<span id="selectedCount">0</span>)
                </button>
            </div>
            <div class="card-body" style="padding:0;">
                {% if builds %}
                <table class="build-table">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>Run</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Lab</th>
                            <th>Jump Host</th>
                            <th>Triggered By</th>
                            <th>Checks</th>
                            <th>Options</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for build in builds %}
                        <tr>
                            <td>{% if current_user.is_admin or build.triggered_by == current_user.username %}<input type="checkbox" class="build-checkbox" value="{{ build.number }}" onchange="updateSelectedCount()">{% endif %}</td>
                            <td>
                                <a href="/job/{{ build.number }}" class="build-link">
                                    <span class="status-icon {{ build.status }}"></span>
                                    #{{ build.number }}
                                </a>
                            </td>
                            <td>
                                {% if build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV</span>
                                {% else %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">ğŸ©º Health</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ build.status }}">
                                    {{ build.status_text }}
                                </span>
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;">
                                {{ build.name or 'â€”' }}
                            </td>
                            <td style="font-size:11px;color:var(--text);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ build.options.server_host or '' }}">
                                {{ build.options.server_host.split('.')[0] if build.options.server_host else 'â€”' }}
                            </td>
                            <td style="font-size:12px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;">
                                    <span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--accent);color:white;font-size:9px;font-weight:700;">{{ (build.triggered_by or 'S')[0]|upper }}</span>
                                    {{ build.triggered_by or 'system' }}
                                </span>
                            </td>
                            <td>{{ build.checks_count }}</td>
                            <td>
                                {% if build.options.task_type == 'cnv_scenarios' %}
                                <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:linear-gradient(135deg,#f97316,#ea580c);color:white;">ğŸ”¥ CNV</span>
                                {% else %}
                                {% if build.options.rca_level == 'full' %}ğŸ”{% elif build.options.rca_level == 'bugs' %}ğŸ›{% else %}ğŸ“‹{% endif %}
                                {% if build.options.rca_jira %}ğŸ«{% endif %}
                                {% if build.options.rca_email %}ğŸ“§{% endif %}
                                {% if build.options.rca_web %}ğŸŒ{% endif %}
                                {% if build.options.email %}ğŸ“¤{% endif %}
                                {% endif %}
                            </td>
                            <td>{{ build.timestamp }}</td>
                            <td>{{ build.duration }}</td>
                            <td>
                                {% if build.report_file %}
                                <a href="/report/{{ build.report_file }}" class="btn" target="_blank">ğŸ“„</a>
                                {% endif %}
                                <a href="/job/{{ build.number }}/console" class="btn">ğŸ“</a>
                                <a href="/job/rebuild/{{ build.number }}" class="btn">ğŸ”„</a>
                                {% if current_user.is_admin or build.triggered_by == current_user.username %}
                                <button onclick="deleteBuild({{ build.number }})" class="btn" style="color:var(--error);" title="Delete">ğŸ—‘ï¸</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <h3>No builds found</h3>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSidebarSection(title) {
        title.classList.toggle('collapsed');
        var content = title.nextElementSibling;
        if (content && content.classList.contains('sidebar-content')) {
            content.classList.toggle('collapsed');
        }
    }
    
    function toggleSelectAll() {
        var selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.build-checkbox').forEach(function(cb) {
            cb.checked = selectAll;
        });
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        var count = document.querySelectorAll('.build-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('deleteSelectedBtn').style.display = count > 0 ? 'inline-flex' : 'none';
    }
    
    function deleteSelected() {
        var selected = [];
        document.querySelectorAll('.build-checkbox:checked').forEach(function(cb) {
            selected.push(cb.value);
        });
        
        if (selected.length === 0) return;
        
        if (confirm('Are you sure you want to delete ' + selected.length + ' build(s) and their reports?')) {
            Promise.all(selected.map(function(buildNum) {
                return fetch('/api/delete/' + buildNum, { method: 'POST' });
            })).then(function() {
                location.reload();
            });
        }
    }
    
    function deleteBuild(buildNum) {
        if (confirm('Are you sure you want to delete Run #' + buildNum + ' and its report?')) {
            fetch('/api/delete/' + buildNum, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete: ' + data.error);
                    }
                });
        }
    }
    
    function deleteBulk(filterType) {
        var messages = {
            'stopped': 'Are you sure you want to delete ALL STOPPED builds?',
            'failed': 'Are you sure you want to delete ALL FAILED builds?',
            'all': 'âš ï¸ WARNING: This will delete ALL builds and their reports!\n\nAre you absolutely sure?'
        };
        
        if (confirm(messages[filterType])) {
            fetch('/api/delete-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filter: filterType})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Deleted ' + data.deleted + ' build(s)');
                    location.reload();
                } else {
                    alert('Failed to delete: ' + data.error);
                }
            });
        }
    }
</script>
{% endblock %}
